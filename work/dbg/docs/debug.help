11/4/2020 9:08:24 AM     C:\sandbox\code\work\dbg\docs\debug.help

latest Windbg: \\dbg\privates\latest

Full dump - user and kernel
.dump /ka <file>

OneNote WinDbg: search PLE-SW-DEV for:
    1. "WinDbg - Examples and Debug Tips"
    2. "WinDbg cheat sheet"

.symopt+ 0x40

.cxr <addr>; kv


>>>>
Here's a command to look up symbols saved to \\desmo\release\symbols:
symchk <driver> /v /s \\desmo\release\symbols

For "driver" specify a .sys or .dll or even use wildcards (e.g. "oempanel*.dll).
Do this from the folder where you have the .sys or .dll.  It will look at that 
file to find the GUID which it needs to look up on Desmo to find the .pdb.
<<<<

> !dawg
> !dawt

> .sypath+ SRV*c:\Symbols*http://symweb;SRV*c:\Symbols*\\desmo\release\Symbols;
> .srcpath C:\git\SurfaceTconDriver\sys;C:\git\SurfaceLibrary\Kernel\DMF

.sypath+ SRV*c:\Symbols*http://symweb;SRV*c:\Symbols*\\desmo\release\Symbols;C:\git\SurfaceTconDriver\Binaries\flush_d0exit_TBQ_count_flush_4.6\bin;
.srcpath C:\git\SurfaceTconDriver\sys;C:\git\SurfaceLibrary\Kernel\DMF


dump all threads and issue !thread on each:
kd> !for_each_thread "!thread @#Thread"

or just dump all threads:
kd> !for_each_thread


is event signalled - 
https://samscode.blogspot.com/2013/03/checking-events-signaled-state-in-km-w.html
5: kd> !handle 0x3cc f Event

Searching for handles of type Event

PROCESS ffff888aad4b70c0
    SessionId: 0  Cid: 054c    Peb: bf674de000  ParentCid: 01b0
    DirBase: 1199cc000  ObjectTable: ffff998a9cca3d80  HandleCount: 289.
    Image: WUDFHost.exe

Handle table at ffff998a9cca3d80 with 289 entries in use

03cc: Object: ffff888ab0d923e0  GrantedAccess: 001f0003 (Protected) (Inherit) Entry: ffff998a9cc1bf30
Object: ffff888ab0d923e0  Type: (ffff888aa3ad0bc0) Event
    ObjectHeader: ffff888ab0d923b0 (new version)
        HandleCount: 1  PointerCount: 32746


5: kd> dt nt!_DISPATCHER_HEADER ffff888ab0d923e0
   +0x004 SignalState      : 0n1


==== WDF debugging ====

Look at all WDF100 on stacks:
1: kd> !stacks 2 wdf0100

4: kd> !process 0 0x1f wudfhost.exe
4: kd> !wdfkd.wdfdriverinfo SurfaceOemPanel.dll 0x10
4: kd> !wdfdevice 0xfffffe08d5c4a628
4: kd> !wdfrequest 0xfffffe08d5bc4438
4: kd> !wdfumirp 0x000001f72a374990
4: kd> !wdfumdevstack  0x000001f72a39a5b0
4: kd> !wdfkd.wdfdevicequeues 0xfffffe08d5c4a628
4: kd> !wdfiotarget 0xfffffe08d5bdb278
4: kd> !wdfkd.wdflogdump WudfRd -d
4: kd> !wdfldr WudfRd !! verify driver was successfully loaded


6: kd> .load wdfkd.dll
6: kd> !wdfdriverinfo SurfaceSerialHubDriver.sys fff
6: kd> !wdflogdump SurfaceSerialHubDriver.sys
6: kd> !WDFQUEUE <queue addr>
6: kd> !WDFDEVICE <device addr>

6: kd> !wdfkd.help
Wdfkd.dll extension built on Jan 01 2016 at 08:00:00

For detailed information about a specific command:!wdfkd.<wdfcommand> /?

!wdfhelp, !help
   Show this message.

!wdfcollection <WDFCOLLECTION handle>
   Dumps all the objects stored in the collection.

!wdfcommonbuffer <WDFCOMMONBUFFER handle>
   [KMDF only]
   This command will dump information about WDFCOMMONBUFFER.

!wdfchildlist <WDFCHLIDLIST handle>
   [KMDF only]
   Dumps the state of all the reported device descriptions in the list.

KMDF:
   !wdfcrashdump [information type]
   Used with kernel mode minidumps to display the log and other crashdump
   information if present in the dump file.
   [information type] is an optional parameter which supports the following values:
       log     - Displays the framework log (Default option)
       loader  - Displays the minidump's "dynamic-bound" drivers

UMDF v2.15+:
   !wdfcrashdump <driver_name>.dll [flags]
   Used with user mode minidumps to display captured log and loader information.
   If no driver name is provided, all active drivers in the host process during the fault
   will be printed. If a driver name is provided, logs will be displayed. The
   following flag values are supported:
      -m    - Merges framework and driver logs in their recorded order
      -d    - Displays only the driver logs
      -f    - Displays only the framework logs

!wdfdevext <device extension pointer from PDEVICE_OBJECT>
   For KMDF, dumps the WDFDEVICE handle related to the device extension 
   along with other WDF handle information.

   For UMDF, dumps the list of UMDF drivers corresponding to the 
   PDEVICE_OBJECT of Wudfrd, given the device extension pointer.

!wdfdevice <WDFDEVICE handle> [flags]
   Dumps information and state of the WDFDEVICE handle
   Flags: 0x01 - Dump verbose information
          0x02 - Dump detailed power state information
          0x04 - Dump detailed power policy state information
          0x08 - Dump detailed pnp state information
          0x10 - Dump all assigned state machine callbacks

!wdfdeviceinterrupts <WDFDevice handle>

!wdfdevicequeues <WDFDEVICE handle>
   Dumps information about all the WDFQUEUE's of WDFDEVICE.
   See wdfqueue as well.
   Flags: 0x10 - Dump unlimited number of queues and contained requests

!wdfdmaenabler <WDFDMAENABLER handle>
   [KMDF only]
   This command will dump verbose information about WDFDMAENABLER
   and its transaction and common buffer objects

!wdfdmaenablers <WDFDEVICE handle>
   [KMDF only]
   This command will list all dma-enablers and associated transaction
   and common buffer objects of WDFDEVICE handle.

!wdfdmatransaction <WDFDMATRANSACTION handle>
   [KMDF only]
   This command will dump information about WDFDMATRANSACTION.

!wdfdriverinfo <driver_name> [flags]
   Displays Wdf driver information, such as device tree and WDF Version Library levels.
   The driver_name should not include the ".sys" file extension.
   [flags] is an optional parameter.  The following values can be combined:
      0x00000001 - Display verifier settings and count of WDF objects.
                   Can be combined with 0x40 to get internal objects
      0x00000010 - Display the WDFHANDLE hierarchy for the driver

        The following flags are only valid when 0x00000010 is set:
        0x00000020 - Show context and callback information for each handle
        0x00000040 - Show internal type information for each handle
        0x00000080 - Show handle information in compact form
        0x00000100 - Show internal type information left justified
        0x00000200 - Show leaked objects (only if they are being tracked or verified)

      0x00000400 - Display device tree in verbose form.

!wdfextendwatchdog <WDFDEVICE handle> [0 | 1]
   [KMDF only]
   Extends the watchdog timer to measure responsiveness during power
   transitions for devices which are not power pageable
   Pass 0 to turn off the extended watchdog timer

!wdffindobjects [<start_address> | registers] [flags]
   This command searches the memory or registers for WDF objects.
   If no parameters are supplied, the command will continue the search
   started by a previous wdffindobjects <start_address> command
   [flags] are only inspected if [<start_address> | registers] is supplied.
     The following values are valid:
     0x00000001 - verbose output
     0x00000002 - show internal type information

!wdfforwardprogress <WDFQUEUE handle>
   [KMDF only]
   Dumps information about forwardprogress for a queue which supports forward progress.
   Flags: 0x10 - Dump unlimited number of requests

!wdfgetdriver
   Echo the current default driver_name.

!wdfhandle <driver handle value> [flags]
   Dumps information about the handle, including the underlying framework
   object pointer. Handle value is any handle value returned to the driver.
   Optional flags parameter may include the following values:
      0x00000010 - Display the WDFHANDLE hierarchy for the given handle

      The following flags are only valid when 0x00000010 is set:
      0x00000020 - Show context and callback information for each handle
      0x00000040 - Show internal type information for each handle
      0x00000080 - Show handle information in compact form
      0x00000100 - Show internal type information left justified

!wdfinterrupt <WDFINTERRUPT handle> [flags]
   Dumps information and state of the WDFINTERRUPT handle
   Optional flags parameter may include the following values:
      0x00000001 - Show interrupt dispatch table for the vector using !idt

!wdfiotarget <WDFIOTARGET handle> [flags]
   Dumps information and state of the WDFIOTARGET handle
   Optional flags may include the following values:
      0x00000001 - Show details on each pended WDFREQUEST
      0x00000010 - Dump unlimited number of requests

!wdfldr [<driver_name>]
   Prints information about the currently loaded KMDF and UMDF drivers or
   driver extensions.
   UMDF: 
      Providing the optional driver name will list out all instances of 
      the driver currently running on the system and their class extension
      drivers.
      If run from user mode debugger, it should be attached to WUDFHOST.exe 
      It would then list out all the UMDF driver instances in that process

   Optional driver_name is ignored for WDF v1.9 and below

!wdflogdump <driver_name> [WdfDriverGlobals | HostProcessId] [ -d | -f | -m | -a ] [LogAddress]
   KMDF:
     Prints the KMDF in-flight recorder log records for the named driver. If
     [WdfDriverGlobals] is supplied, then <driver_name> is ignored but still
     must be supplied.
     Driver log: -d
     Framework log: -f
     -a - Specific driver log. If this is used, LogAddress must be provided.
     
   UMDF:
     Prints the UMDF in-flight recorder log records for the named driver.
     The .dll extension must be provided. If [HostProcessId] is not provided,
     a list of valid IDs will be printed. If a single process can be determined
     it will automatically be chosen.
      For UMDF 2.15+ a flag is required. Omitting the flag will show all options. 
     Merged log: -m
     Driver log: -d
     Framework log: -f

!wdflogsave <driver_name> [capture_filename]
   Saves the WDF In-Flight Recorder log records for the
   named driver. The filename will be "<driver_name>.etl".
   The driver_name parameter should not include the ".sys" file extension.
   The optional capture_filename parameter should not include the
   ".etl" extension. If the capture filename parameter is not given
   the capture filename will be "<driver_name>.etl".

!wdfmemory <WDFMEMORY handle>
   Dumps the underlying buffer pointer and size for the WDFMEMORY handle.

!wdfobject <framework object pointer>
   Dumps information about the underlying framework object.

!wdfopenhandles <WDFDEVICE handle> [flags]
   Dumps information about all the handles opened on WDFDEVICE.
   Flags: 0x01 - Dump fileobject context information

!wdfpoolusage <driver_name> [address_to_search] [flags]
   Dumps pool usage for the given driver_name.
   If [address_to_search] is supplied, it will search for a pool allocation 
     that spans the address.  A value of 0 indicates
     that no allocation should be searched for.
   [flags] are only inspected if [address_to_search] is supplied.  The 
     following values are valid:
     0x00000001 - verbose output
     0x00000002 - show internal type information for each handle
     0x00000004 - show caller
   Example: !wdfpoolusage <driver_name>
              Dump pool and show handle information
            !wdfpoolusage <driver_name> 0 2
              Dump pool and show handle and internal type information

!wdfqueue <WDFQUEUE handle>
   Dumps information about WDFQUEUE.
   Flags: 0x10 - Dump unlimited number of requests

!wdfrequest <WDFREQUEST handle>
   Dumps information about WDFREQUEST.

!wdfsearchpath <filepath to the format (TMC/TMF) files>
   Set the searchpath to the format files needed to format
   the WDF log records.
   The environmental TRACE_FORMAT_SEARCH_PATH=<searchpath> may be set
   to your the default searchpath. The wdfsearchpath cmd value takes
   precedence over the environmental setting value.

!wdfsettraceprefix <trace prefix string>
   Set the trace prefix format string. This will control the trace message
   prefix issued with each log trace message.
   The environmental TRACE_FORMAT_PREFIX=<trace prefix string> may also be used.

!wdfsetdriver <driver_name>
   Set the default driver_name. This driver_name will be use when other
   driver_name-requiring wdfkd commands are invoked without the 
   driver_name parameter. User-mode drivers must include the .dll extension.
   See !wdfgetdriver to get the current name.

!wdfspinlock <spin lock object pointer>
   Dumps the spin lock information and the history of the spin lock object
   if available.

!wdftagtracker <tag object pointer> [flags]
   Dumps all outstanding tag information (tag value, line, file, time)
   for the given tag tracker.
   flags:  0x1 - display the history of acquires and releases on the object
           0x2 - display line number in hex instead of decimal
           0x4 - display all tags instead of cutting it off after 1,000 entries
   To retrieve a pointer to a tag tracker, use the !wdfkd.wdfobject extension
   on an internal framework object pointer. 

!wdftmffile <TMF file name>
   This command is used to set or clear the TMF file for formatting
   log. To clear the name, run the command without the filename.

!wdftraceprtdebug <on | off>
   This command will turn on the TracePrt diagnostic mode.
   To be used under the direction of support.

!wdfumdevstack <address> [flags]
   [UMDF Only]
   <address> is the address of UMDF Device stack. It can be obtained from 
   the output of !wdldr <driver_name> or !wdfumdevstacks
   Flags: 0x01 - dump detailed information (default).
   Flags: 0x80 - dump internal values of device stack.

!wdfumdevstacks [flags]
   [UMDF Only]
   Flags: 0x01 - dump detailed information (default).
   Flags: 0x80 - dump internal values of device stack.

!wdfumdownirp - This command works only in kernel debugger
   [UMDF v2 and greater]
   Usage 
   [1]: !wdfumdownirp <umirp>
      This command will print user mode file handle to be used
      with !handle to get the kernel mode _FILE_OBJECT

   [2]: !wdfumdownirp <umirp> <_FILE_OBJECT addr>
      To get the kernel mode IRP

!wdfumfile <address>
   [UMDF v2 and greater]
   <address> is the address of UM file obtained from the output of either
   !wdfumirp or !wdfumdevstacks

!wdfumirp <address> [flags]
   [UMDF Only]
   <address> is the address of UMDF host IRP (CWudfIrp) obtained 
   from the output of !wdfumirps
   Flags: 0x01 - dump details of IRP buffers
          0x80 - displays details about the internal framework

!wdfumirps [<numIrps | *> [<deviceStack | *> [flags]]]
   [UMDF v2 and greater]
   Flags: 0x01 - dump irp details

!wdfumtriage 
   [UMDF Only]
   Dumps triage information for UMDF. This includes information about 
   driver services, devices , pending IRPs and other useful information 
   about infrastructure components.

!wdfusbdevice <WDFUSBDEVICE handle> [flags]
   This command will dump out information about a WDFUSBDEVICE I/O target
   flags:  0x1 - display I/O target properties
           0x2 - display I/O target properties for each WDFUSBPIPE

!wdfusbinterface <WDFUSBINTERFACE handle> [flags]
   This command will dump out information about a WDFUSBINTERFACE
   This will include all of its alternate settings and currently selected
   setting.
   flags:  0x1 - display I/O target properties for each WDFUSBPIPE

!wdfusbpipe <WDFUSBPIPE handle> [flags]
   This command will dump out information about a WDFUSBPIPE I/O target
   flags:  0x1 - display I/O target properties

!wdfwmi <WDFDEVICE handle>
   [KMDF only]
   This command will dump out WMI registration, provider and instance information
   for a WDFDEVICE handle.


========================

> vertarget -- os version
1: kd> !sysinfo
!sysinfo [ cpuinfo | cpumicrocode | cpuspeed | gbl | machineid | registers | smbios ] [-csv | -noheaders]


7: kd> !sysinfo smbios
[System Information (Type 1) - Length 27 - Handle 0001h]
  Manufacturer                  Microsoft Corporation
  Product Name                  Surface Pro 7


> lmv <-- dump drivers
> lmv m igdkmdn64
1: kd> lmv m igdkmdn64
start             end                 module name
fffff807`88f60000 fffff807`8a411000   igdkmdn64   (deferred)             
    Mapped memory image file: c:\symbols\igdkmdn64.sys\5DFBC20514b1000\igdkmdn64.sys
    Image path: igdkmdn64.sys
    Image name: igdkmdn64.sys
    Timestamp:        Thu Dec 19 10:31:33 2019 (5DFBC205)
    CheckSum:         014B3286
    ImageSize:        014B1000
    File version:     26.20.100.7641
    Product version:  26.20.100.7641
    File flags:       0 (Mask 3F)
    File OS:          40004 NT Win32
    File type:        3.4 Driver
    File date:        00000000.00000000
    Translations:     0409.04b0
    CompanyName:      Intel Corporation
    ProductName:      Intel HD Graphics Drivers for Windows(R)
    InternalName:     igdkmdn64.sys
    OriginalFilename: igdkmdn64.sys
    ProductVersion:   26.20.100.7641
    FileVersion:      26.20.100.7641
    FileDescription:  Intel Graphics Kernel Mode New Driver
    LegalCopyright:   Copyright (c) 1998-2018 Intel Corporation.
Mini Kernel Dump does not contain unloaded driver list

Because kernel mode thread stack size is small (12Kb or 0×3000 on x86 and 24Kb on x64) 
we can simply dump mem-ory range between ESP-3000 and ESP+3000. We can use RSP register 
for x64 dumps but the output will be the same.
1: kd> dps esp-3000 esp+3000 <-- raw stack dump - shows all drivers on stacks

Dump driver symbols:
1: kd> x dxgkrnl!*
    and WHAMMO !!!!!

1: kd> kL
Child-SP          RetAddr           Call Site
ffff8380`b9c2ef00 fffff807`8563e80f watchdog!WdDbgReportRecreate+0x116
ffff8380`b9c2ef50 fffff807`81d0035c dxgkrnl!TdrUpdateDbgReport+0x10f
ffff8380`b9c2efa0 fffff807`81d9a16e dxgmms2!VidSchiResetEngine+0x7c0
ffff8380`b9c2f290 fffff807`81d70463 dxgmms2!VidSchiResetEngines+0xc2
ffff8380`b9c2f2e0 fffff807`81d9a9ff dxgmms2!VidSchWaitForCompletionEvent+0x290a3
ffff8380`b9c2f360 fffff807`81cf17e8 dxgmms2!VidSchiWaitForCompletePreemption+0x7b
(Inline Function) --------`-------- dxgmms2!VidSchiCompletePreemption+0x12
ffff8380`b9c2f450 fffff807`81d59d8c dxgmms2!VidSchiSwitchFromSuspendedDevices+0x11048
(Inline Function) --------`-------- dxgmms2!VidSchiSubmitDeviceCommand+0x28
(Inline Function) --------`-------- dxgmms2!VidSchiSubmitQueueCommand+0x169
ffff8380`b9c2f4c0 fffff807`81d59bba dxgmms2!VidSchiRun_PriorityTable+0x1bc
ffff8380`b9c2f510 fffff807`7ef1e135 dxgmms2!VidSchiWorkerThread+0xca
ffff8380`b9c2f550 fffff807`7efc99a8 nt!PspSystemThreadStartup+0x55
ffff8380`b9c2f5a0 00000000`00000000 nt!KiStartSystemThread+0x28
1: kd> r
rax=ffffcc0ed39dfac0 rbx=ffffa78f4fec5680 rcx=ffffcc0ed39dfac0
rdx=0000000000000000 rsi=ffffcc0ed39dfac0 rdi=ffffa78f536926a0
rip=fffff8078578f9c6 rsp=ffff8380b9c2ef00 rbp=ffffa78f55a30010
 r8=0000000000000000  r9=0000000000000000 r10=fffff8077efca390
r11=000000000000000a r12=ffffa78f4fec2460 r13=0000000000000000
r14=ffffa78f4b5b1030 r15=0000000000000001
iopl=0         nv up ei pl zr na po nc
cs=0010  ss=0018  ds=002b  es=002b  fs=0053  gs=002b             efl=00040246
watchdog!WdDbgReportRecreate+0x116:
fffff807`8578f9c6 488b4f38        mov     rcx,qword ptr [rdi+38h] ds:002b:ffffa78f`536926d8=????????????????


1: kd> .thread
Implicit thread is now ffffa78f`4fec5680
> .frame x <== set to frame x of .thread
> dv <== locals

1: kd> !thread ffffa78f4fec5680
THREAD ffffa78f4fec5680  Cid 0004.0308  Teb: 0000000000000000 Win32Thread: 0000000000000000 RUNNING on processor 1
Not impersonating
GetUlongFromAddress: unable to read from fffff8077f22ca14
Owning Process            ffffa78f46066040       Image:         System
Attached Process          N/A            Image:         N/A
fffff78000000000: Unable to get shared data
Wait Start TickCount      712723       
Context Switch Count      1302471        IdealProcessor: 3             
ReadMemory error: Cannot get nt!KeMaximumIncrement value.
UserTime                  00:00:00.000
KernelTime                00:00:00.000
Win32 Start Address dxgmms2!VidSchiWorkerThread (0xfffff80781d59af0)
Stack Init ffff8380b9c2f5d0 Current ffff8380b9c2e8d0
Base ffff8380b9c30000 Limit ffff8380b9c29000 Call 0
Priority 16 BasePriority 16 UnusualBoost 0 ForegroundBoost 0 IoPriority 2 PagePriority 5
Child-SP          RetAddr           : Args to Child                                                           : Call Site
ffff8380`b9c2ef00 fffff807`8563e80f : ffffa78f`55a30010 ffff8380`b9c2f0a0 ffffa78f`55a30010 ffffa78f`536926a0 : watchdog!WdDbgReportRecreate+0x116 [onecoreuap\windows\core\watchdog\dbgrep\dump.cpp @ 832]
ffff8380`b9c2ef50 fffff807`81d0035c : ffffa78f`00000000 ffffa78f`52c90030 ffffa78f`55a30010 ffffa78f`4febe000 : dxgkrnl!TdrUpdateDbgReport+0x10f [onecoreuap\windows\core\dxkernel\dxgkrnl\core\dxgtdr.cxx @ 946]
ffff8380`b9c2efa0 fffff807`81d9a16e : ffffa78f`4febe000 00000000`00000000 00000000`00000001 00000000`00000001 : dxgmms2!VidSchiResetEngine+0x7c0 [onecoreuap\windows\core\dxkernel\dxgkrnl\dxgmms2\vidsch\vidschi.cxx @ 16581]
ffff8380`b9c2f290 fffff807`81d70463 : 00000000`00000000 ffffa78f`4febe000 00000000`00000000 ffff8380`b9c2f3a0 : dxgmms2!VidSchiResetEngines+0xc2 [onecoreuap\windows\core\dxkernel\dxgkrnl\dxgmms2\vidsch\vidschi.cxx @ 16721]
ffff8380`b9c2f2e0 fffff807`81d9a9ff : ffffa78f`4febe000 ffffffff`feced300 00000000`00000000 fffff807`81cda9f2 : dxgmms2!VidSchWaitForCompletionEvent+0x290a3 [onecoreuap\windows\core\dxkernel\dxgkrnl\dxgmms2\vidsch\vidsch.cxx @ 8514]
ffff8380`b9c2f360 fffff807`81cf17e8 : ffffa78f`4fe99000 00000000`00000000 ffffa78f`4fe99690 fffff807`81ce1400 : dxgmms2!VidSchiWaitForCompletePreemption+0x7b [onecoreuap\windows\core\dxkernel\dxgkrnl\dxgmms2\vidsch\vidschi.cxx @ 5527]
(Inline Function) --------`-------- : --------`-------- --------`-------- --------`-------- --------`-------- : dxgmms2!VidSchiCompletePreemption+0x12 (Inline Function @ fffff807`81cf17e8) [onecoreuap\windows\core\dxkernel\dxgkrnl\dxgmms2\vidsch\vidschi.cxx @ 15223]
ffff8380`b9c2f450 fffff807`81d59d8c : ffffa78f`50163010 ffffa78f`4fe99000 ffffa78f`4fc3b5a0 ffffa78f`539ed3b0 : dxgmms2!VidSchiSwitchFromSuspendedDevices+0x11048 [onecoreuap\windows\core\dxkernel\dxgkrnl\dxgmms2\vidsch\vidschi.cxx @ 24725]
(Inline Function) --------`-------- : --------`-------- --------`-------- --------`-------- --------`-------- : dxgmms2!VidSchiSubmitDeviceCommand+0x28 (Inline Function @ fffff807`81d59d8c) [onecoreuap\windows\core\dxkernel\dxgkrnl\dxgmms2\vidsch\vidschi.cxx @ 2531]
(Inline Function) --------`-------- : --------`-------- --------`-------- --------`-------- --------`-------- : dxgmms2!VidSchiSubmitQueueCommand+0x169 (Inline Function @ fffff807`81d59d8c) [onecoreuap\windows\core\dxkernel\dxgkrnl\dxgmms2\vidsch\vidschi.cxx @ 1953]
ffff8380`b9c2f4c0 fffff807`81d59bba : ffffa78f`4fe99400 fffff807`81d59af0 ffffa78f`4fe99000 00000000`00000000 : dxgmms2!VidSchiRun_PriorityTable+0x1bc [onecoreuap\windows\core\dxkernel\dxgkrnl\dxgmms2\vidsch\vidschi.cxx @ 1047]
ffff8380`b9c2f510 fffff807`7ef1e135 : ffffa78f`4fec5680 fffff807`00000001 ffffa78f`4fe99000 000024ef`bd9bbfff : dxgmms2!VidSchiWorkerThread+0xca [onecoreuap\windows\core\dxkernel\dxgkrnl\dxgmms2\vidsch\vidschi.cxx @ 576]
ffff8380`b9c2f550 fffff807`7efc99a8 : ffffdc80`45540180 ffffa78f`4fec5680 fffff807`7ef1e0e0 00000000`00000000 : nt!PspSystemThreadStartup+0x55 [minkernel\ntos\ps\psexec.c @ 9310]
ffff8380`b9c2f5a0 00000000`00000000 : ffff8380`b9c30000 ffff8380`b9c29000 00000000`00000000 00000000`00000000 : nt!KiStartSystemThread+0x28 [minkernel\ntos\ke\amd64\threadbg.asm @ 83]


1: kd> dt _ETHREAD ffffa78f4fec5680
nt!_ETHREAD
   +0x000 Tcb              : _KTHREAD
1: kd> dt _KTHREAD ffffa78f4fec5680


1: kd> !process ffffa78f46066040
PROCESS ffffa78f46066040
    SessionId: none  Cid: 0004    Peb: 00000000  ParentCid: 0000
    DirBase: 001ad000  ObjectTable: ffffcc0eccc0aac0  HandleCount: <Data Not Accessible>
    Image: System
    VadRoot ffffa78f508d1c70 Vads 8 Clone 0 Private 21. Modified 561106. Locked 0.
    DeviceMap ffffcc0eccc13660
    Token                             ffffcc0eccc0b8d0
    ReadMemory error: Cannot get nt!KeMaximumIncrement value.
fffff78000000000: Unable to get shared data
    ElapsedTime                       00:00:00.000
    UserTime                          00:00:00.000
    KernelTime                        00:00:00.000
    QuotaPoolUsage[PagedPool]         0
    QuotaPoolUsage[NonPagedPool]      272
    Working Set Sizes (now,min,max)  (0, 0, 0) (0KB, 0KB, 0KB)
    PeakWorkingSetSize                0
    VirtualSize                       3 Mb
    PeakVirtualSize                   13 Mb
    PageFaultCount                    0
    MemoryPriority                    BACKGROUND
    BasePriority                      8
    CommitCharge                      49

        *** Error in reading nt!_ETHREAD @ ffffa78f4606b040


0: kd> .asm no_code_bytes Assembly options: no_code_bytes
0: kd> ub nt!KiTrap00+0x88 nt!KiTrap00+0x74: 8083483b test

0: kd> uf igdkmdn64!DxgkDdiCollectDbgInfo

1: kd> .thread /r /p ffffa78f`4fec5680
Implicit thread is now ffffa78f`4fec5680
Implicit process is now ffffa78f`46066040
Loading User Symbols
1: kd> kL 100
Child-SP          RetAddr           Call Site
ffff8380`b9c2ef00 fffff807`8563e80f watchdog!WdDbgReportRecreate+0x116
ffff8380`b9c2ef50 fffff807`81d0035c dxgkrnl!TdrUpdateDbgReport+0x10f
ffff8380`b9c2efa0 fffff807`81d9a16e dxgmms2!VidSchiResetEngine+0x7c0
ffff8380`b9c2f290 fffff807`81d70463 dxgmms2!VidSchiResetEngines+0xc2
ffff8380`b9c2f2e0 fffff807`81d9a9ff dxgmms2!VidSchWaitForCompletionEvent+0x290a3
ffff8380`b9c2f360 fffff807`81cf17e8 dxgmms2!VidSchiWaitForCompletePreemption+0x7b
(Inline Function) --------`-------- dxgmms2!VidSchiCompletePreemption+0x12
ffff8380`b9c2f450 fffff807`81d59d8c dxgmms2!VidSchiSwitchFromSuspendedDevices+0x11048
(Inline Function) --------`-------- dxgmms2!VidSchiSubmitDeviceCommand+0x28
(Inline Function) --------`-------- dxgmms2!VidSchiSubmitQueueCommand+0x169
ffff8380`b9c2f4c0 fffff807`81d59bba dxgmms2!VidSchiRun_PriorityTable+0x1bc
ffff8380`b9c2f510 fffff807`7ef1e135 dxgmms2!VidSchiWorkerThread+0xca
ffff8380`b9c2f550 fffff807`7efc99a8 nt!PspSystemThreadStartup+0x55
ffff8380`b9c2f5a0 00000000`00000000 nt!KiStartSystemThread+0x28


dump registers:
> r
dump contents:
> du @eax
> dd @eax
> dc @eax <== cool hex dump with ascii

> dds <addr1> <addr2> <= lists dwords of stack: StackLimit & StackBase from !teb

> lm <= lists modules (drivers and limits)

Interrupts: dump IDT

.chain
Extension DLL search Path:
    C:\Program Files (x86)\Windows Kits\8.1\Debuggers\x64\WINXP;C:\Program Files (x86)\Windows Kits\8.1\Debuggers\x64\winext;C:\Program Files (x86)\Windows Kits\8.1\Debuggers\x64\winext\arcade;C:\Program Files (x86)\Windows Kits\8.1\Debuggers\x64\pri;C:\Program Files (x86)\Windows Kits\8.1\Debuggers\x64;C:\Program Files (x86)\Windows Kits\8.1\Debuggers\x64\winext\arcade;C:\CEdev\bin;C:\Python37\;C:\Python37\DLLs\;C:\Python37\Scripts\;C:\Python37\Tools\;C:\Python37\Tools\ninja\;C:\Python36\;C:\Python36\DLLs\;C:\Python36\Scripts\;C:\Python36\Tools\;C:\Python36\Tools\ninja\;C:\Perl64\site\bin;C:\Perl64\bin;C:\Program Files\Common Files\Microsoft Shared\Microsoft Online Services;C:\Program Files (x86)\Common Files\Microsoft Shared\Microsoft Online Services;C:\WINDOWS\system32;C:\WINDOWS;C:\WINDOWS\System32\Wbem;C:\WINDOWS\System32\WindowsPowerShell\v1.0\;C:\WINDOWS\System32\OpenSSH\;C:\Program Files\Git\cmd;C:\Program Files\TortoiseGit\bin;C:\Program Files\dotnet\;C:\Program Files\Microsoft SQL Server\130\Tools\Binn\;C:\Program Files (x86)\IAR Systems\Embedded Workbench 7.0;C:\Program Files (x86)\Windows Kits\10\Windows Performance Toolkit\;C:\FPC\3.0.4\bin\i386-Win32;C:\WINDOWS\system32\config\systemprofile\.dnx\bin;C:\Program Files\Microsoft DNX\Dnvm\;C:\Program Files\Microsoft SQL Server\120\Tools\Binn\;C:\Program Files (x86)\Windows Kits\8.1\Windows Performance Toolkit\;C:\Program Files\Microsoft SQL Server\Client SDK\ODBC\170\Tools\Binn\;C:\Users\v-babart\AppData\Local\NuGet;C:\Users\v-babart\AppData\Local\Microsoft\WindowsApps;C:\Users\v-babart\.dotnet\tools;C:\Users\v-babart\AppData\Local\Microsoft\WindowsApps;C:\Program Files (x86)\Nmap;C:\Users\v-babart\.dotnet\tools

Extension DLL chain:
    kd: image 10.0.19041.1, built Mon Feb 02 01:30:16 2105
        [path: C:\WINDOWS\system32\kd.dll]
    wdfkd: image 6.3.9600.17336, API 1.0.0, built Thu Feb 26 18:03:19 2015
        [path: C:\Program Files (x86)\Windows Kits\8.1\Debuggers\x64\winext\wdfkd.dll]
    dbghelp: image 6.3.9600.17298, API 6.3.6, built Fri Oct 24 18:07:10 2014
        [path: C:\Program Files (x86)\Windows Kits\8.1\Debuggers\x64\dbghelp.dll]
    ext: image 6.3.9600.17336, API 1.0.0, built Thu Feb 26 18:15:38 2015
        [path: C:\Program Files (x86)\Windows Kits\8.1\Debuggers\x64\winext\ext.dll]
    exts: image 6.3.9600.17336, API 1.0.0, built Thu Feb 26 18:11:52 2015
        [path: C:\Program Files (x86)\Windows Kits\8.1\Debuggers\x64\WINXP\exts.dll]
    kext: image 6.3.9600.17298, API 1.0.0, built Fri Oct 24 18:13:06 2014
        [path: C:\Program Files (x86)\Windows Kits\8.1\Debuggers\x64\winext\kext.dll]
    kdexts: image 6.3.9600.17298, API 1.0.0, built Fri Oct 24 18:13:07 2014
        [path: C:\Program Files (x86)\Windows Kits\8.1\Debuggers\x64\WINXP\kdexts.dll]

6: kd> !kext.help
cbreg [%%]<RegBaseAddress>    - Displays CardBus and ExCA registers
db [Flag] [Address [L <Range>]] - Displays memory in bytes and ANSI chars
dc [Flag] [Address [L <Range>]] - Displays memory in ULONGs and ANSI chars
dd [Flag] [Address [L <Range>]] - Displays memory in ULONGs
diskspace <DriveLetter>[:]      - Displays free disk space for volume
dp [Flag] [Address [L <Range>]] - Displays memory in ULONG_PTR
du [Flag] [Address [L <Range>]] - Displays memory in wide chars
dw [Flag] [Address [L <Range>]] - Displays memory in USHORTs
eb [Flag] <Address> [[Value1] [[Value2]...]]] - Write bytes into memory
ed [Flag] <Address> [[Value1] [[Value2]...]]] - Write ULONGs into memory
ecb <Bus>.<Dev>.<Func> <Offset> <Data> - Edit PCI ConfigSpace byte
ecd <Bus>.<Dev>.<Func> <Offset> <Data> - Edit PCI ConfigSpace ULONG
ecs                                    - Edit PCI ConfigSpace help
ecw <Bus>.<Dev>.<Func> <Offset> <Data> - Edit PCI ConfigSpace WORD
exca <BasePort>.<SocketNum>    - Displays CardBus ExCA registers only
help                           - Show this help
pci [Flag] [Segment] [Bus] [Device] [Function] [MinAddr] [MaxAddr]
                               - Displays PCI ConfigSpace

Type ".hh [command]" for more detailed help
   
6: kd> !ext.help
address [address]          - Displays the address space layout
        [-UsageType]       - Displays the address space regions of the given type
analyze [-v]               - Analyzes current exception or bugcheck
cpuid [processor]          - Displays CPU version info for all CPUs
elog_str <message>         - Logs simple message to host event log
cppexr <exraddress>        - Displays a C++ EXCEPTION_RECORD
error [errorcode]          - Displays Win32 & NTSTATUS error string
exchain                    - Displays exception chain for current thread
findxmldata                - Displays data from cabbed sysdata.xml
for_each_frame <cmd>       - Executes command for each frame in current
                             thread
for_each_local <cmd> $$<n> - Executes command for each local variable in
                             current frame, substituting fixed-name alias
for_each_process <cmd>     - Executes command for each process
for_each_thread <cmd>      - Executes command for each thread
                             $u<n> for each occurrence of $$<n>
gle [-all]                 - Displays last error & status for current thread
imggp <imagebase>          - Displays GP directory entry for 64-bit image
imgreloc <imagebase>       - Relocates modules for an image
list [-? | parameters]     - Displays lists
obja <address>             - Displays OBJECT_ATTRIBUTES[32|64]
owner [symbol!module]      - Detects owner for current exception or
                             bugcheck from triage.ini
rtlavl <address>           - Displays RTL_AVL_TABLE
std_map <address>          - Displays a std::map<>
str <address>              - Displays ANSI_STRING or OEM_STRING
ustr <address>             - Displays UNICODE_STRING

Type ".hh [command]" for more detailed help

6: kd> !exts.help
acl <address> [flags]        - Displays the ACL
atom <address>               - Displays the atom or table(s) for the process
avrf [-? | parameters]       - Displays or modifies App Verifier settings
cs [-? | parameters]         - Displays critical sections for the process
cxr                          - Obsolete, .cxr is new command
decodeptr32 <value>          - Decode encoded 32-bit pointer value (using process cookie)
decodeptr64 <value>          - Decode encoded 64-bit pointer value (using process cookie)
dlls [-h | parameters]       - Displays loaded DLLS
encodeptr32 <ptr>            - Encode 32-bit value for encoded pointer (using process cookie)
encodeptr64 <ptr>            - Encode 64-bit value for encoded pointer (using process cookie)
exr                          - Obsolete, .exr is new command
findthis [-? | options]     - Search the registers for the this pointer
gflag [-?|<value>]           - Displays the global flag
heap [-? | parameters]       - Displays heap info
help                         - Displays this list
kuser                        - Displays KUSER_SHARED_DATA
peb [address]                - Displays the PEB structure
psr <value>|@ipsr [flags]    - Displays an IA64 Processor Status Word
sd <address> [flags]         - Displays the SECURITY_DESCRIPTOR
shipassert                   - Displays ship asserts
sid <address> [flags]        - Displays the SID
slist [-? | parameters]      - Displays singly-linked list
stl [options] <varname>      - Dumps an STL variable
stltree [options] <address>  - Dumps an STL set, map, multiset, or multimap
teb [address]                - Displays the TEB structure
tls <slot | -1> [teb | 0]    - Dumps TLS slots. !tls /? for usage
token [-n|-?] <handle|addr>  - Displays TOKEN
tp <command>                 - Dump threadpool information

Type ".hh [command]" for more detailed help

6: kd> !kext.help
cbreg [%%]<RegBaseAddress>    - Displays CardBus and ExCA registers
db [Flag] [Address [L <Range>]] - Displays memory in bytes and ANSI chars
dc [Flag] [Address [L <Range>]] - Displays memory in ULONGs and ANSI chars
dd [Flag] [Address [L <Range>]] - Displays memory in ULONGs
diskspace <DriveLetter>[:]      - Displays free disk space for volume
dp [Flag] [Address [L <Range>]] - Displays memory in ULONG_PTR
du [Flag] [Address [L <Range>]] - Displays memory in wide chars
dw [Flag] [Address [L <Range>]] - Displays memory in USHORTs
eb [Flag] <Address> [[Value1] [[Value2]...]]] - Write bytes into memory
ed [Flag] <Address> [[Value1] [[Value2]...]]] - Write ULONGs into memory
ecb <Bus>.<Dev>.<Func> <Offset> <Data> - Edit PCI ConfigSpace byte
ecd <Bus>.<Dev>.<Func> <Offset> <Data> - Edit PCI ConfigSpace ULONG
ecs                                    - Edit PCI ConfigSpace help
ecw <Bus>.<Dev>.<Func> <Offset> <Data> - Edit PCI ConfigSpace WORD
exca <BasePort>.<SocketNum>    - Displays CardBus ExCA registers only
help                           - Show this help
pci [Flag] [Segment] [Bus] [Device] [Function] [MinAddr] [MaxAddr]
                               - Displays PCI ConfigSpace

Type ".hh [command]" for more detailed help

6: kd> !kdexts.help
acpicache [flags]            - Displays cached ACPI tables
acpiinf                      - Displays ACPI Information structure
acpiirqarb                   - Displays ACPI IRQ Arbiter data
acpiresconflict              - Displays detail on resource conflicts that cause
                               bugcheck 0xA5 (ACPI_ROOT_PCI_RESOURCE_FAILURE)
ahcache [flags]              - Displays application compatibility cache
amli <command|?> [params]    - Use AMLI debugger extensions
apc [[proc|thre] <address>]  - Displays Asynchronous Procedure Calls
arbiter [flags]              - Displays all arbiters and arbitrated ranges
arblist <address> [flags]    - Dump set of resources being arbitrated
bcb <address>                - Display the Buffer Control Block
biosreslist <address>        - Dump PnpBios/ACPI resource list
blockeddrv                   - Dumps the list of blocked drivers in the system
bpid <pid>                   - Tells winlogon to do a user-mode break into
                               process <pid>
bugdump                      - Display bug check dump data
bushnd [address]             - Dump a HAL "BUS HANDLER" structure
ca <address> [flags]         - Dump the control area of a section
calldata <table name>        - Dump call data hash table
cchelp                       - Display Cache Manager debugger extensions
chklowmem                    - Tests if PAE system booted with /LOWMEM switch
cmreslist <CM Resource List> - Dump CM resource list
cpuinfo [id]                 - Displays CPU information for specified processor
dbgprint                     - Displays contents of DbgPrint buffer
dblink <address> [count] [bias] - Dumps a list via its blinks
dflink <address> [count] [bias] - Dumps a list via its flinks
deadlock [1]                 - Display Driver Verifier deadlock detection info
defwrites                    - Dumps deferred write queue & cache write
                               throttle analysis
devext [<address> <type>]    - Dump device extension of specified type
devhandles [<address>]       - Dumps open handles against the specified device
devinst                      - dumps the device reference table
devnode <device node> [flags] [service] - Dump the device node
devobj <device>              - Dump the device object and Irp queue
devpowerstate [device node]  - Dumps the device node with the power state and all attached devices
devstack <device>            - Dump device stack associated w/device object
dma [<adapter> [flags]]      - Displays Direct Memory Access subsystem info
dpa [options]                - Displays pool allocations
dpcs [processor]             - Dumps the queued DPCs
dpcstackhistory [processor] [count] - Dumps last [count] number of captured (if any) DPC watchdog callstack samples
dpcwatchdog                  - Dumps the DPC history of all processsors
driveinfo <drive>[:]         - Dump drive volume information for specific drive
drivers                      - Display info about loaded system modules
drvobj <driver> [flags]      - Dump the driver object and related information
dskheap                      - Dump desktop heap
e820reslist <List>           - Dump an ACPI_BIOS_MULTI_NODE resource list
errlog                       - Dump the error log contents
exqueue [flags] [partition]  - Dump the ExWorkerQueues
exrlog                       - Display the exception log
facs                         - Dumps the Firmware ACPI Control Structure
fadt                         - Dumps the Fixed ACPI Description Table
filecache                    - Dumps information about the file system cache
filelock <address>           - Dump a file lock structure - address is either
                               the filelock or a fileobject
filetime                     - Dumps 64-bit FILETIME as a human-readable time
findautochkblockers          - Dumps file handles and file-names which are
                               preventing autochk from running
finddata <address> <offset>  - Find cached data at given offset in FILE_OBJECT
findhandle <object> <process | 0> - Find handles referring to the specified object
findthreads [-v] [-t <addr>]|[-i <addr>]|[-d <addr>]|[-a <addr> [-e <addr>|-l <length>]] - Find threads with stack-locations referencing a given object/memory range
fpsearch <address>           - Find a freed special pool allocation
frag [flags]                 - Kernel mode pool fragmentation
frozen                       - Show processor states (Current,Frozen,Running)
gbl                          - Dumps the ACPI Global Lock
gentable <address> [flags]   - Dumps the given rtl_generic_table
handle <addr> <flags> <process> <TypeName> -  Dumps handle for a process
help                         - Displays this list
hidppd <address> <flags>     - Dump Preparsed Data of HID device
ib <port>                    - Read a byte from an I/O port
id <port>                    - Read a double-word from an I/O port
idt <vector>                 - Dump ISRs referenced by each IDT entry
ioresdes <address>           - Display IO_RESOURCE_DESCRIPTOR structure
ioreslist <IO Resource List> - Dump IO resource requirements list
ipi                          - Dump IPI processors state
iw <port>                    - Read a word from an I/O port
irp <address> <dumplevel>    - Dump IRP at specified address
irpfind [pooltype] [restart addr] [<irpsearch> <address>]
                             - Search pool for active IRPs
irql [processor]             - Display current IRQL for processor
isainfo <address> [flags]    - Display ISA Bus and Card info
job <address> [flags]        - Dump JobObject at address, processes in job
joblist [flags]              - Displays all active job objects
lbt                          - Dump legacy bus information table
loadermemorylist <address>   - Display OSLOADER memory allocation list
locks [-v] <address>         - Dump kernel mode resource locks
logonsession [<LUID> [level]]  - Display logon sessions
lookaside <address> <options> <depth> - Dump lookaside lists
lpc                          - Dump lpc ports and messages
mapic                        - Dumps the ACPI Multiple APIC Table
mca <address>                - Display Machine Check Architecture registers
memlist                      - Scans physical memory lists for consistency
memusage                     - Dumps the page frame database table
nsobj   <address>            - Dumps an ACPI Namespace Object
nstree [<address>]           - Dumps an ACPI Namespace Object tree
numa                         - Display Non-Uniform Memory Access nodes
numa_hal                     - Display HAL NUMA info
ob <port>                    - Write a byte to an I/O port
object <-r | Path | address | 0 TypeName>  - Dumps an object manager object
obtrace <address|object>     - Display object trace information
od <port>                    - Write a double-word to an I/O port
openmaps <shared cache map > - Dumps the active views for a shared cache map
ow <port>                    - Write a word to an I/O port
pcitree                      - Dump the PCI tree structure
pcm <address>                - Detects valid address for Private Cache Map
pagefile                     - Dumps pagefile information and related device stacks
pcmcia [1]                   - Displays PCMCIA devices and their states
pcr [processor]              - Dumps the Processor Control Registers
pfn                          - Dumps the page frame database entry for the
                               physical page
pnpaction                    - Dump PNP action queue
pnpcompletion                - Dump PNP completion queue
pnpevent <event entry>       - Dump PNP events
pnplocks                     - Dump PNP locks
pnpthreads                   - Dump active Pnp thread if any
pnptriage                    - 'x' command for Pnp - dumps basic info useful for triage
pocaps                       - Dumps System Power Capabilities.
podev <devobj>               - Dumps power relevent data in device object
polist [<devobj>]            - Dumps power Irp serial list entries
ponode                       - Dumps power Device Node stack (devnodes in
                               power order)
pool [<0|-1|address> [detail]] - Dump kernel mode heap
poolfind Tag [pooltype] -    - Finds occurrences of the specified Tag
poolused [flags [TAG]]       - Dump usage by pool tag
popolicy [<address> [flags]] - Dumps System Power Policy.
poproc [<address> [flags]]   - Dumps Processor Power State.
poprocpolicy [<address> [flags]] - Dumps Processor Power Policy.
poreqlist [<devobj>]         - Dumps PoRequestedPowerIrp created Power Irps
posettings [/?]              - Dumps the power settings database
potrigger <address>          - Dumps POP_ACTION_TRIGGER.
powertriage                  - Dumps basic information useful for triage of power related issues
pplookaside [processor] [lookasidelist] - Dumps PerProcessor LookasideLists.
prcb [processor]             - Displays the Processor Control Block
process [<address>] [flags] [image name] - Dumps process at specified address
pte <address>                - Dump PDE and PTE for the entered address
ptov PhysicalPageNumber      - Dump all valid physical<->virtual mappings
                               for the given page directory
qlocks                       - Dumps state of all queued spin locks
range <RtlRangeList>         - Dump RTL_RANGE_LIST
ready                        - Dumps state of all READY system threads
reg [<command> [params]]     - Registry extensions
rellist <relation list> [flags] - Dump PNP relation lists
remlock                      - Dump a remove lock structure
rsdt                         - Displays the ACPI Root System Description Table
running [-t] [-i]            - Displays the running threads in the system
scm <address>                - Detects valid address for Shared Cache Map
session [-?] [-s] <id> [flags] [image name] - Dumps sessions
sprocess [<id|-1> [flags]]   - Displays session processes
srb <address>                - Dump Srb at specified address
stacks <detail-level>        - Dump summary of current kernel stacks
swd                          - Dump Software Watchdog state
sysinfo                      - Dump SMBios, ACPI, and CPU info
sysptes                      - Dumps the system PTEs
thread [<address> [flags]]   - Dump current thread, specified thread, or stack
                               containing address
timer                        - Dumps timer tree
tokenleak [<0>|<1> <ProcessCid> <BreakCount> <MethodWatch>]
                             - Activates token leak tracking
tunnel <address>             - Dump a file property tunneling cache
trueref <address> [<process>] - Displays the refcount of the specified object
tz [<address> <flags>]       - Dumps Thermal Zones. No Args dumps All TZs
tzinfo <address>             - Dumps Thermal Zone Information.
ubc [*|<bpid>]               - Clears a user-space breakpoint
ubd [*|<bpid>]               - Disables a user-space breakpoint
ube [*|<bpid>]               - Enables a user-space breakpoint
ubl                          - Lists all user-space breakpoint
ubp <address>                - Sets a user-space breakpoint
vad                          - Dumps VADs
verifier                     - Displays Driver Verifier settings and status
version                      - Version of extension dll
vm                           - Dumps virtual management values
vpb <address>                - Dumps volume parameter block
vtop DirBase address         - Dumps physical page for virtual address
whatperftime <perf>          - Converts performance time to HH:MM:SS.mmm
whattime <ticks>             - Converts ticks to HH:MM:SS.mmm
wsle [<flags> [address]]     - Display Working Set List Entries
zombies [<flags> [address]]  - Find all zombie processes

X64-specific:

apic [base]                  - Dump local apic
apicerr                      - Dumps local apic error log
ioapic [base]                - Dump io apic
mtrr                         - Dumps MTRR

Type ".hh [command]" for more detailed help


!poaction


kd> .sympath+ srv*;C:\git\SurfaceOemPanelDriver\Debug\x64\bin;C:\git\SurfaceTconDriver\Debug\x64\bin

0:000> .symopt- 0x40
Symbol options are 0x30377:
0x00000001 – SYMOPT_CASE_INSENSITIVE
0x00000002 – SYMOPT_UNDNAME
0x00000004 – SYMOPT_DEFERRED_LOADS
0x00000010 – SYMOPT_LOAD_LINES
0x00000020 – SYMOPT_OMAP_FIND_NEAREST
0x00000100 – SYMOPT_NO_UNQUALIFIED_LOADS
0x00000200 – SYMOPT_FAIL_CRITICAL_ERRORS
0x00010000 – SYMOPT_AUTO_PUBLICS
0x00020000 – SYMOPT_NO_IMAGE_SEARCH
Load symbols:
!sym noisy
.reload /f

Registry
!reg dumppool
!reg querykey \REGISTRY\MACHINE\SYSTEM\ControlSet001\Services

4: kd> !reg querykey \REGISTRY\MACHINE\SYSTEM\ControlSet001\Services\igfxn


Sorry <\REGISTRY\MACHINE\SYSTEM\ControlSet001\Services\igfxn> is not cached 

===========================================================================================
Falling back to traversing the tree of nodes.

Hive         ffff8c8320246000
KeyNode      ffff8c83251e6cac

[SubKeyAddr]         [SubKeyName]
ffff8c83251e6f2c     Parameters
ffff8c83251e7024     Video

[SubKeyAddr]         [VolatileSubKeyName]
ffff8c83209f8644     Enum

 Use '!reg keyinfo ffff8c8320246000 <SubKeyAddr>' to dump the subkey details

[ValueType]         [ValueName]                   [ValueData]
REG_DWORD           Type                          1
REG_DWORD           Start                         3
REG_DWORD           ErrorControl                  0
REG_DWORD           Tag                           5
REG_EXPAND_SZ       ImagePath                     \SystemRoot\System32\DriverStore\FileRepository\iigd_dch.inf_amd64_6b06e9c04476fc60\igdkmdn64.sys
REG_SZ              Group                         Video
REG_MULTI_SZ        Owners                        oem0.inf\0
REG_DWORD           DCHUVen                       8086

sites:
https://bsodtutorials.wordpress.com/
https://stackoverflow.com/questions/4946685/good-tutorial-for-windbg
https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/debug-universal-drivers--kernel-mode-
http://pciids.sourceforge.net/pci.ids
-- good talk on power states
https://www.kernel.org/doc/html/v4.14/driver-api/pm/devices.html
https://docs.microsoft.com/en-us/windows-hardware/drivers/storage/life-cycle-of-a-storport-driver

References:
https://docs.microsoft.com/en-us/windows-hardware/drivers/wdf/using-umdf-debugger-extensions
https://docs.microsoft.com/en-us/windows-hardware/drivers/wdf/debugging-umdf-2-0-drivers
https://theartofdev.com/windbg-cheat-sheet/
Power problems:
https://systemdebug.in/0x9f-bugcheck-with-param-3-here-is-how-you-go-about-it/
https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/using-symchk

WDF debugging:
https://www.osr.com/nt-insider/2015-issue1/kmdf-umdf-hints/
https://www.osr.com/nt-insider/2011-issue2/analysts-perspective-10-windbg-commands-might-know/
http://ntcoder.com/bab/2012/03/06/how-to-force-symbol-loading-in-windbg/
0x00000040 – SYMOPT_LOAD_ANYTHING

Driver samples:
https://github.com/microsoft/Windows-driver-samples

ACPI:
https://acpica.org/sites/acpica/files/ACPI-Introduction.pdf
https://acpica.org/sites/acpica/files/asl_tutorial_v20190625.pdf
https://askbob.tech/acpi-101/

UEFI reading:
file://desmo/WDS/Devices/Paloma/SWFW/Docs/Renior/FP6/SW_docs/
https://deviceswiki.com/wiki/Learning_UEFI

UEFI debug:
OneNote: Retrieve UEFI image from Retail BB
UEFI release history : OneNote
use grasshopper dips => DN-UP-UP-UP
use SurfDbg (C:\sandbox\tools\SurfDbg_Try):
\\desmo\Release\Shared\CI_tools-surfdbg\refs\heads\master\4.95.191121-1810
UEFI debug versions use pipeline: 
https://dev.azure.com/MSFTDEVICES/UEFI-Delos/_build?definitionId=7387
UEFI Source Level Debugging (OneNote)
UEFI Firmware update: OneNote Retrieve UEFI image from Retail BB
  > py .\PlatformBuild.py BLD_*_FORCE_DEBUGGER_ENABLED=TRUE --clean
UEFI Debug messages in OS from ACPI (OneNote)
UEFI building: Delos local build (OneNote)


UEFI Tianocore 3rd party setup:
wizard: https://github.com/tianocore/tianocore.github.io/wiki/UEFI-Driver-Wizard
Download and unzip UDK2014.IHV into c:\EDK_Workspace
https://github.com/tianocore/tianocore.github.io/wiki/UDK2014.IHV-Setup-Guide
Extract BaseTools(Windows)
run edksetup.bat from VS x64 native shell
Wizard, open workspace C:\EDK_Workspace\UDK2014.IHV
Create driver inside workspace: C:\EDK_Workspace\UDK2014.IHV\Drivers


In windbg we do this via…

0:000> .symopt+ 0x40
Symbol options are 0x30377:
0x00000001 – SYMOPT_CASE_INSENSITIVE
0x00000002 – SYMOPT_UNDNAME
0x00000004 – SYMOPT_DEFERRED_LOADS
0x00000010 – SYMOPT_LOAD_LINES
0x00000020 – SYMOPT_OMAP_FIND_NEAREST
0x00000040 – SYMOPT_LOAD_ANYTHING <———– Prevents validation of .pdb file
0x00000100 – SYMOPT_NO_UNQUALIFIED_LOADS
0x00000200 – SYMOPT_FAIL_CRITICAL_ERRORS
0x00010000 – SYMOPT_AUTO_PUBLICS
0x00020000 – SYMOPT_NO_IMAGE_SEARCH

To re-enable strict mapping between .exe and .pdb use


Storage:
7: kd> !minipkd.help

SCSI Miniport Debugger Extension
help                      - displays this message
adapters                  - dumps all the HBAs
adapter <adapter>         - dumps the specified Adapter Extension
exports <adapter>         - dumps the miniport exports for the given adapter
lun <lun>                 - dumps the specified Logical Unit Extension
portconfig <portconfig>   - dumps the specified PORT_CONFIGURATION_INFORMATION
req <adapter>             - dumps active requests on specified adapter or device
srb <srb>                 - dumps the specified SCSI_REQUEST_BLOCK

7: kd> !minipkd.adapters
minipkd error (0): drivers\storage\kdext\minipkd\minipkd.c @ line 435
7: kd> !scsikd.help

IMPORTANT NOTE: Please consider using StorageKD instead of scsikd for your debugging needs for win8 and above targets

SCSIPORT Debugger Extension
          help -    displays this message
       srbdata -    dumps the specified SRB_DATA tracking block
               -    
    The following take either the device object or device extension -   
       scsiext -    dumps the specified scsiport extension
      classext -    dumps the specified classpnp extension
               -    
    Commands for partition tables -     
        layout -    dumps the drive layout at the the specified address
      layoutex -    dumps the extended drive layout at the specified address
          part -    dumps the partition at the specified address
        partex -    dumps the extended partition at the specified address

7: kd> !scsikd.classext 
Storage class devices:

* !classext ffffa7074c5a1060 [1,2] SAMSUNG MZ9LQ1T0HALB-00000 Paging Disk       

Usage: !classext <class device> <level [0-2]>

Optical devices, such as DVD drives, can be listed with !wdfkd.wdfdriverinfo cdrom, and further explored 
using the "!wdfkd.wdfdevice <device_handle>" and "!wdfkd.wdfdevicequeues <device_handle>" commands.


ACPI:
2: kd> !nstree
\___ (ffff880593f10048) - Unknown
| _SB_ (ffff880593f10258) - Device ffff8805948ea010
| | LID0 (ffff880593f36048) - Device ffff8805928a27d0
| | | _HID (ffff880593f36158) - Integer - 000000000d0cd041
| | | _STA (ffff880593f36208) - Method - Flags 0000000000000000 Start ffff880593f3637a Len 000000000000000c
| | | _LID (ffff880593f363a0) - Method - Flags 0000000000000000 Start ffff880593f36512 Len 000000000000000e

2: kd> !amli dns /s \_sb.ssh._dsm
ACPI Name Space: \_SB.SSH._DSM (ffff818892f39720)
Method(_DSM:Flags=0x4,CodeBuff=ffff818892f39892,Len=478)

1: kd> !amli dns /s \_sb.lid0
ACPI Name Space: \_SB.LID0 (ffff880593f36048)
Device(LID0)
| Integer(_HID:Value=0x000000000d0cd041[218943553])
| Method(_STA:Flags=0x0,CodeBuff=ffff880593f3637a,Len=17)
| Method(_LID:Flags=0x0,CodeBuff=ffff880593f36512,Len=19)

1: kd> !amli dns /s \_sb.lid0._lid
ACPI Name Space: \_SB.LID0._LID (ffff880593f363a0)
Method(_LID:Flags=0x0,CodeBuff=ffff880593f36512,Len=19)

1: kd> !nsobj ffff880593f363a0
nsobj:  dumping object at ffff880593f363a0
NameSpace Object \ (ffff880593f363a0) - Device 0000000000000000
  Flink 0000000000000000Blink  000000b68557d0e0
  Parent 0000000000000000  Child 0000000000000000
  Value 0000000000000000  Length 0000000000000000
  Buffer 0000000000000000  Flags 0000000000000000
    Object Data - ffff880593f363e0 Type - 08 <Method> Flags=0000000000000000 Start=ffff880593f36512 Len=000000000000000e
    
Dump acpi method
1: kd> !amli u ffff880593f36512
ffff880593f36512:[\_SB.LID0._LID]
ffff880593f36512 : Store(M009(0x16), Local0)
ffff880593f3651a : If(LEqual(Local0, Zero))
ffff880593f3651f : {
ffff880593f3651f : | Return(One)
ffff880593f36521 : }
ffff880593f36521 : Else
ffff880593f36523 : {
ffff880593f36523 : | Return(Zero)
ffff880593f36525 : }


Example full round trip:
1: kd> !wdfkd.wdflogdump WudfRd -d
494: RdPnpTracker::RdPnp - RdPnpTracker::RdPnp: RdFdoDevice 0xFFFF880597FDE9F0 !devobj 0xFFFF88059D516DD0 IRP_MJ_POWER 0x00000002(IRP_MN_SET_POWER) IRP 0xFFFF8805A09B3760 received
495: RdPnpTracker::RdPnpProcessor - Forwarding IRP 0xFFFF8805A09B3760 to host on its way down
499: RdPnpTracker::RdForwardRequestToHostReply - Power IRP 0xFFFF8805A09B3760 0x00000002(IRP_MN_SET_POWER) reply (0x00000000(false)) received from host. RdPnPTracker 0xFFFF88059DB97DE0 HasProblem 0x00000000(false)
500: RdPnpTracker::RdPnpProcessor - Forwarding IRP 0xFFFF8805A09B3760 to host on completion


cache*;SRV*https://msdl.microsoft.com/download/symbols

!object \
!object \Global??\
!object \Global??\PhysicalDrive0

6: kd> !object \Global??\PhysicalDrive0
Object: ffff808c5a148460  Type: (ffffa708ea48c4e0) SymbolicLink
    ObjectHeader: ffff808c5a148430 (new version)
    HandleCount: 0  PointerCount: 1
    Directory Object: ffff808c58c079c0  Name: PhysicalDrive0
    Flags: 00000000 ( Local )
    Target String is '\Device\Harddisk0\DR0'

6: kd> !object \Device\Harddisk0\DR0
Object: ffffa708ef066060  Type: (ffffa708ea4e2220) Device
    ObjectHeader: ffffa708ef066030 (new version)
    HandleCount: 0  PointerCount: 3
    Directory Object: ffff808c58cd8220  Name: DR0

6: kd> !devobj ffffa708ef066060
Device object (ffffa708ef066060) is for:
 DR0 \Driver\disk DriverObject ffffa708ecec2b00
Current Irp 00000000 RefCount 5 Type 00000007 Flags 01000050
Vpb ffffa708ef091cd0 SecurityDescriptor ffff808c58dc77e0 DevExt ffffa708ef0661b0 DevObjExt ffffa708ef066a60 Dope ffffa708ef091bf0 
ExtensionFlags (0x00000800)  DOE_DEFAULT_SD_PRESENT
Characteristics (0x00000100)  FILE_DEVICE_SECURE_OPEN
AttachedDevice (Upper) ffffa708ecece8d0 \Driver\partmgr
AttachedTo (Lower) ffffa708ecec4de0 \Driver\EhStorClass
Device queue is not busy.

6: kd> !devstack ffffa708ef066060
  !DevObj           !DrvObj            !DevExt           ObjectName
  ffffa708ecece8d0  \Driver\partmgr    ffffa708ececea20  
> ffffa708ef066060  \Driver\disk       ffffa708ef0661b0  DR0
  ffffa708ecec4de0  \Driver\EhStorClassffffa708ecec4ba0  
  ffffa708ec9a9060  \Driver\stornvme   ffffa708ec9a91b0  00000037
!DevNode ffffa708ec9aa8d0 :
  DeviceInst is "SCSI\Disk&Ven_NVMe&Prod_HFM256GDGTNG-87A\000000"
  ServiceName is "disk"

6: kd> !vpb ffffa708ef091cd0
Vpb at 0xffffa708ef091cd0
Flags: 0x30 
DeviceObject: 0x0000000000000000
RealDevice:   0xffffa708ef066060
RefCount: 0
Volume Label: 


6: kd> !devnode ffffa708ec9aa8d0
DevNode 0xffffa708ec9aa8d0 for PDO 0xffffa708ec9a9060
  Parent 0xffffa708ec933cd0   Sibling 0000000000   Child 0000000000   
  InstancePath is "SCSI\Disk&Ven_NVMe&Prod_HFM256GDGTNG-87A\000000"
  ServiceName is "disk"
  TargetDeviceNotify List - f 0xffff808c5c486db0  b 0xffff808c5c486db0
  State = DeviceNodeStarted (0x308)
  Previous State = DeviceNodeEnumerateCompletion (0x30d)
  StateHistory[01] = DeviceNodeEnumerateCompletion (0x30d)
  StateHistory[00] = DeviceNodeEnumeratePending (0x30c)
  StateHistory[19] = DeviceNodeStarted (0x308)
  StateHistory[18] = DeviceNodeEnumerateCompletion (0x30d)
  StateHistory[17] = DeviceNodeEnumeratePending (0x30c)
  StateHistory[16] = DeviceNodeStarted (0x308)
  StateHistory[15] = DeviceNodeEnumerateCompletion (0x30d)
  StateHistory[14] = DeviceNodeEnumeratePending (0x30c)
  StateHistory[13] = DeviceNodeStarted (0x308)
  StateHistory[12] = DeviceNodeEnumerateCompletion (0x30d)
  StateHistory[11] = DeviceNodeEnumeratePending (0x30c)
  StateHistory[10] = DeviceNodeStarted (0x308)
  StateHistory[09] = DeviceNodeEnumerateCompletion (0x30d)
  StateHistory[08] = DeviceNodeEnumeratePending (0x30c)
  StateHistory[07] = DeviceNodeStarted (0x308)
  StateHistory[06] = DeviceNodeStartPostWork (0x307)
  StateHistory[05] = DeviceNodeStartCompletion (0x306)
  StateHistory[04] = DeviceNodeStartPending (0x305)
  StateHistory[03] = DeviceNodeResourcesAssigned (0x304)
  StateHistory[02] = DeviceNodeDriversAdded (0x303)
  Flags (0x24000130)  DNF_ENUMERATED, DNF_IDS_QUERIED, 
                      DNF_NO_RESOURCE_REQUIRED, DNF_NO_LOWER_DEVICE_FILTERS, 
                      DNF_NO_UPPER_DEVICE_FILTERS
  UserFlags (0x00000008)  DNUF_NOT_DISABLEABLE
  CapabilityFlags (0x004001c1)  DeviceD1, UniqueID, 
                                SilentInstall, RawDeviceOK
                                Unknown flags 0x00400000
  DisableableDepends = 1 (including self)


6: kd> !object \Global??\Volume{e2faca35-8b0f-41fd-9743-4fa665234538}
Object: ffff808c5a14d380  Type: (ffffa708ea48c4e0) SymbolicLink
    ObjectHeader: ffff808c5a14d350 (new version)
    HandleCount: 0  PointerCount: 1
    Directory Object: ffff808c58c079c0  Name: Volume{e2faca35-8b0f-41fd-9743-4fa665234538}
    Flags: 00000000 ( Local )
    Target String is '\Device\HarddiskVolume3'

6: kd> !object \Device\HarddiskVolume3
Object: ffffa708ecf7c930  Type: (ffffa708ea4e2220) Device
    ObjectHeader: ffffa708ecf7c900 (new version)
    HandleCount: 0  PointerCount: 11
    Directory Object: ffff808c58c04a20  Name: HarddiskVolume3

6: kd> !devstack ffffa708ecf7c930
  !DevObj           !DrvObj            !DevExt           ObjectName
  ffffa708ef179040  \Driver\volsnap    ffffa708ef179190  
  ffffa708ecec18d0  \Driver\volume     ffffa708ecec1a20  
  ffffa708eceee8d0  \Driver\rdyboost   ffffa708eceeea20  
  ffffa708eceed8d0  \Driver\iorate     ffffa708eceeda20  
  ffffa708ef177030  \Driver\fvevol     ffffa708ef177180  
> ffffa708ecf7c930  \Driver\volmgr     ffffa708ecf7ca80  HarddiskVolume3
!DevNode ffffa708ecee3c90 :
  DeviceInst is "STORAGE\Volume\{bb1d3e22-3c95-11ea-ad85-806e6f6e6963}#0000000018500000"
  ServiceName is "volume"

6: kd> !drvobj \Driver\volmgr 
Driver object (ffffa708ec995e30) is for:
 \Driver\volmgr

Driver Extension List: (id , addr)

Device Object list:
ffffa708ecee38f0  ffffa708ecf7c930  ffffa708eceb3b40  ffffa708ecee2b90
ffffa708ec921900  

6: kd> !object \Driver\mountmgr
Object: ffffa708ec939d20  Type: (ffffa708ea4e24e0) Driver
    ObjectHeader: ffffa708ec939cf0 (new version)
    HandleCount: 0  PointerCount: 7
    Directory Object: ffff808c58cd7420  Name: mountmgr


6: kd> !drvobj ffffa708ec939d20
Driver object (ffffa708ec939d20) is for:
 \Driver\mountmgr

Driver Extension List: (id , addr)

Device Object list:
ffffa708ec9a2ca0  

6: kd> !devobj ffffa708ec9a2ca0
Device object (ffffa708ec9a2ca0) is for:
 MountPointManager \Driver\mountmgr DriverObject ffffa708ec939d20
Current Irp 00000000 RefCount 0 Type 00000012 Flags 00000840
SecurityDescriptor ffff808c58df8b20 DevExt ffffa708ec9a2df0 DevObjExt ffffa708ec9a2f68 
ExtensionFlags (0x00000800)  DOE_DEFAULT_SD_PRESENT
Characteristics (0x00000100)  FILE_DEVICE_SECURE_OPEN
Device queue is not busy.



