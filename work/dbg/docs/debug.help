11/4/2020 9:08:24 AM     C:\sandbox\code\work\dbg\docs\debug.help

https://github.com/walnut314/code/blob/master/work/dbg/docs/debug.help
\\wosext2\training\Nonsla\WD

note: windbg can be used to open drivers to compare versions for fix
> uf driver!function

kPnL

start:
.lines
lml, lm vi m pci
!running -it
!sysinfo machineid 
!cpuinfo

Break on reboot: Ctrl-Alt-K

latest Windbg: \\dbg\privates\latest

!winde.activity

1: kd> !dawg
-----------------------------------------------------
         Debug Analysis - Wait Graph
-----------------------------------------------------
7: kd> !dawt
-----------------------------------------------------
         Debug Analysis - Wait Tree
-----------------------------------------------------

4: kd> dx KiBugCheckDriver
KiBugCheckDriver                 : 0xffffe10585a70668 : "SurfaceSystemManagementFrameworkDriver.sys" [Type: _UNICODE_STRING *]
    [<Raw View>]     [Type: _UNICODE_STRING]


!Winde.help

Identify dump or LKD:
0: kd> ||
.  0 64-bit Kernel triage dump: C:\sandbox\dumps\Bug_2051983\0000e5380_PDCRevocation-20201111-0836.dmp

modify dump file: DedicatedDumpFile, and AlwaysKeepMemoryDump --> registry settings

Run scripts:
kd> $$< <path to script>

Get the last event:
0: kd> .lastevent
Last event: Break instruction exception - code 80000003 (first/second chance not available)
  debugger time: Tue Dec  1 16:21:40.638 2020 (UTC - 8:00)

random stuff:
0: kd> .printf "%y\n" , @eip
00000000`487a8304
0: kd> uf <function-address> -- dumps the whole function.


Full dump - user and kernel
.dump /ka <file>

OneNote WinDbg: search PLE-SW-DEV for:
    1. "WinDbg - Examples and Debug Tips"
    2. "WinDbg cheat sheet"

.symopt+ 0x40
.symopt- 100
.reload /f
.reload /u igdkmdn64.sys

.cxr <addr>; kv
> kPnL

>>>>
Here's a command to look up symbols saved to \\desmo\release\symbols:
symchk <driver> /v /s \\desmo\release\symbols

For "driver" specify a .sys or .dll or even use wildcards (e.g. "oempanel*.dll).
Do this from the folder where you have the .sys or .dll.  It will look at that 
file to find the GUID which it needs to look up on Desmo to find the .pdb.
<<<<

> !dawg
> !dawt

> .sympath+ SRV*c:\Symbols*http://symweb;SRV*c:\Symbols*\\desmo\release\Symbols;
    srv*\\desmo\wds\Devices\Paloma\SWFW\AMD_Driver_Firmware\Symbols\SymSrv

> .srcpath C:\git\SurfaceTconDriver\sys;C:\git\SurfaceLibrary\Kernel\DMF

.sypath+ SRV*c:\Symbols*http://symweb;SRV*c:\Symbols*\\desmo\release\Symbols;C:\git\SurfaceTconDriver\Binaries\flush_d0exit_TBQ_count_flush_4.6\bin;
.srcpath C:\git\SurfaceTconDriver\sys;C:\git\SurfaceLibrary\Kernel\DMF

First get the WDF memory buffer:
4: kd> !wdfmemory 0x00001efa6c939448
Treating handle as a KMDF handle!
WDFMEMORY 0x00001efa6c939448:  Buffer 0xffffe105936c6c30, Length 0x3a0 (928) bytes

> !ppmstate -- PPM
> !ppm
> !popolicy
2: kd> !popolicy
SYSTEM_POWER_POLICY (R.1) @ 0xfffff8066c23d3c4
  PowerButton:     Hibernate  Flags: 00000000   Event: 00000000  
  SleepButton:     Hibernate  Flags: 00000000   Event: 00000000  
  LidClose:        Hibernate  Flags: 00000000   Event: 00000000  
  Idle:            Hibernate  Flags: 00000000   Event: 00000000  
  OverThrottled:        None  Flags: 00000000   Event: 00000000  
  IdleTimeout:             0  IdleSensitivity:        90%
  MinSleep:               S0  MaxSleep:               S0
  LidOpenWake:            S0  FastSleep:              S0
  WinLogonFlags:           1  S4Timeout:            e100
  VideoTimeout:            0  VideoDim:                0
  SpinTimeout:            1e  OptForPower:             0
  FanTolerance:            0% ForcedThrottle:          0%
  MinThrottle:             0% DyanmicThrottle:      None (0)
2: kd> !ppmperfpolicy
Not suported. Use !ppmsettings instead.
2: kd> !ppmsettings
Error retrieving size of nt!PpmPolicyConfigTable
2: kd> !ppmcheck

  PpmCheckArmed:             TRUE
  PpmCheckStartDpc:          0xfffff8066c23bc80
  PpmCheckDpc:               0xfffff8066c23bcc0
  PpmCheckTimer:             -
  PpmCheckMakeupCount:       0
  PpmCheckLastExecutionTime: -
  PpmCheckTime:              08:25:32.391.610us (0x469f83a744)
  PpmCheckPhase:             0
  PpmCheckRegistered:        0xfffff8066c20bca0
Affinity Conversion Failed
  PpmPerfStatesRegistered:   0xfffff8066c20bf20
Affinity Conversion Failed
  CoreParkingEnabled:        FALSE
  CoreParkingMask:           0xfffff8066c20bdb0
Affinity Conversion Failed



DMFKd info:
7: kd> !dmfkd.help
Commands for C:\Users\v-babart\AppData\Local\Dbg\UserExtensions\DmfKd\1.233.137.0\x64\DmfKd.dll:
  !dmfbuffer            - [Deprecated] use !dmf_buffer
  !dmfbufferpool        - [Deprecated] use !dmf_bufferpool
  !dmfbufferqueue       - [Deprecated] use !dmf_bufferqueue
  !dmfconfig            - [Deprecated] use !dmf_module
  !dmfconfigaddr        - [Internal Use Only]
  !dmfcontext           - [Deprecated] use !dmf_module
  !dmfcontextaddr       - [Internal Use Only]
  !dmfmoduleinfo        - [Deprecated] use !dmf_module
  !dmfobject            - [Deprecated] use !dmf_module
  !dmftree              - Displays the DMF Tree starting from a WDF Device /
                          DMF Module / DMF Collection
                          Type !dmftree /? for flag usages.
  !dmfwdfmemorytobuffer - [Internal Use Only]
  !help                 - Displays information on available extension commands
  !helpex               - Displays information on all commands : Both C++ and
                          JS commands
  !surfacedriverlegacy  - Displays information regarding the specified Surface driver
  !surfacedriverslegacy - Lists all the loaded Surface drivers
!help <cmd> will give more information for a particular command
7: kd> !dmfkd.helpex
Commands for C:\Users\v-babart\AppData\Local\Dbg\UserExtensions\DmfKd\1.233.137.0\x64\DmfKd.dll:
  !dmftree              - Displays the DMF Tree starting from a WDF Device /
                          DMF Module / DMF Collection
                          Type !dmftree /? for flag usages.
  !dmfwdfmemorytobuffer - [Internal Use Only]
  !help                 - Displays information on available extension commands
  !helpex               - Displays information on all commands : Both C++ and JS commands
  !surfacedriverlegacy  - Displays information regarding the specified Surface driver
  !surfacedriverslegacy - Lists all the loaded Surface drivers

Below are the JavaScript command descriptions:
  !dmf_bufferpool                 - Displays BufferPool Details
  !dmf_bufferqueue                - Displays BufferQueue Details
  !dmf_componentfirmwareupdatehidtransportsurface  - Displays Component firmware update hid transport surface Details
  !dmf_componentfirmwareupdatev2  - Displays Component firmware update surface Details
  !dmf_continuousrequesttarget    - Displays ContinuousRequestTarget Details
  !dmf_deviceinterfacetarget      - Displays DeviceInterfaceTarget Details
  !dmf_gpiotarget                 - Displays GpioTarget Details
  !dmf_hidtarget                  - Displays HidTarget Details
  !dmf_interface                     - Displays DmfInterface Details
  !dmf_interruptresource          - Displays InterruptResource Details
  !dmf_ioctlhandler               - Displays IoctlHandler Details
  !dmf_module                     - Displays DmfModule Details
  !dmf_pdo                        - Displays Pdo Details
  !dmf_pingpongbuffer             - Displays PingPongBuffer Details
  !dmf_queuedworkitem             - Displays QueuedWorkItem Details
  !dmf_requesttarget              - Displays RequestTarget Details
  !dmf_samcommunicationviassh     - Displays SamCommunicationViaSsh Details
  !dmf_scheduledtask              - Displays ScheduledTask Details
  !dmf_selftarget                 - Displays SelfTarget Details
  !dmf_serialtarget               - Displays SerialTarget Details
  !dmf_spbtarget                  - Displays SpbTarget Details
  !dmf_thread                     - Displays Thread Details
  !dmf_threadedbufferqueue        - Displays ThreadedBufferQueue Details
  !dmf_wdfhandle                  - Displays WDFHANDLE Details
  !surfacecfuoverhid         - Displays SurfaceCFUOverHid Driver Details
  !surfacedriver                  - Displays details of a specific Surface Driver
  !surfacedrivers                 - Displays Surface Drivers
  !surfaceserialhubdriver         - Displays SurfaceSerialHub Driver Details
  !helpex <cmd> will give more information for a particular command

dump all threads and issue !thread on each:
kd> !for_each_thread "!thread @#Thread"
kd> !for_each_thread ".thread @#Thread; kP"

or just dump all threads:
kd> !for_each_thread

Dump kernel service table (pretty sweet):
.for(r $t0=0;@$t0<dwo(nt!KiServiceLimit);r $t0=@$t0+1){.printf "%d %y\n", $t0, nt!KiServiceTable+(dwo(nt!KiServiceTable+@$t0*4)>>4)}

11: kd> .for(r $t0=0;@$t0<dwo(nt!KiServiceLimit);r $t0=@$t0+1){.printf "%d %y\n", $t0, nt!KiServiceTable+(dwo(nt!KiServiceTable+@$t0*4)>>4)}
0 nt!NtAccessCheck (fffff801`656947f0)
1 nt!NtWorkerFactoryWorkerReady (fffff801`657736d0)
2 nt!NtAcceptConnectPort (fffff801`65bf61c0)
3 nt!NtMapUserPhysicalPagesScatter (fffff801`65e335b0)
4 nt!NtWaitForSingleObject (fffff801`65ad9c20)
5 nt!NtCallbackReturn (fffff801`6582bef0)
6 nt!NtReadFile (fffff801`65bb7270)
7 nt!NtDeviceIoControlFile (fffff801`65ada420)
8 nt!NtWriteFile (fffff801`65b1e850)



is event signalled - 
https://samscode.blogspot.com/2013/03/checking-events-signaled-state-in-km-w.html
5: kd> !handle 0x3cc f Event

Searching for handles of type Event

PROCESS ffff888aad4b70c0
    SessionId: 0  Cid: 054c    Peb: bf674de000  ParentCid: 01b0
    DirBase: 1199cc000  ObjectTable: ffff998a9cca3d80  HandleCount: 289.
    Image: WUDFHost.exe

Handle table at ffff998a9cca3d80 with 289 entries in use

03cc: Object: ffff888ab0d923e0  GrantedAccess: 001f0003 (Protected) (Inherit) Entry: ffff998a9cc1bf30
Object: ffff888ab0d923e0  Type: (ffff888aa3ad0bc0) Event
    ObjectHeader: ffff888ab0d923b0 (new version)
        HandleCount: 1  PointerCount: 32746


5: kd> dt nt!_DISPATCHER_HEADER ffff888ab0d923e0
   +0x004 SignalState      : 0n1

3: kd> dt nt!_kevent ffff800f2cc43670
   +0x000 Header           : _DISPATCHER_HEADER

Ticks:
Wait Start TickCount 2658271 Ticks: 2649851 (0:11:28:57.940)
    => (0:11:28:57.940) => 11hrs 28 minute and 57 seconds

Register based stack dump:
> dps esp-100 esp+100

> !rcdrkd.rcdrlogdump <driver_name.sys>

0: kd> !wmitrace.strdump <-- list running loggers
0: kd> !wmitrace.logger 0x1d <-- MpWppTracing
0: kd> !wmitrace.logger 0x02 <-- Circular Kernel Context Logger
0: kd> !wmitrace.logdump *   <-- dump all logs

4: kd> !wmitrace.strdump
(WmiTrace) StrDump Generic
  LoggerContext Array @ 0xFFFFBE031ED71CC0 [80 Elements]
    Logger Id 0x02 @ 0xFFFFBE03201E3600 Named 'Circular Kernel Context Logger'
    Logger Id 0x03 @ 0xFFFFBE03202F0040 Named 'Eventlog-Security'
    Logger Id 0x04 @ 0xFFFFBE03201E4040 Named 'DefenderApiLogger'
    Logger Id 0x05 @ 0xFFFFBE03202EA380 Named 'DefenderAuditLogger'
    Logger Id 0x06 @ 0xFFFFBE03202EA940 Named 'DiagLog'
    Logger Id 0x07 @ 0xFFFFBE03202ED040 Named 'Diagtrack-Listener'
    Logger Id 0x08 @ 0xFFFFBE03202ED600 Named 'EventLog-Application'
    Logger Id 0x09 @ 0xFFFFBE03202F0600 Named 'EventLog-System'
    Logger Id 0x0a @ 0xFFFFBE03202F3040 Named 'FaceTel'
    Logger Id 0x0b @ 0xFFFFBE03202F3600 Named 'LwtNetLog'
    Logger Id 0x0c @ 0xFFFFBE03202F6040 Named 'Microsoft-Windows-Rdp-Graphics-RdpIdd-Trace'
    Logger Id 0x0d @ 0xFFFFBE03202F6640 Named 'NetCore'
    Logger Id 0x0e @ 0xFFFFBE03210E2080 Named 'NtfsLog'
    Logger Id 0x0f @ 0xFFFFBE03210E2640 Named 'RadioMgr'
    Logger Id 0x10 @ 0xFFFFBE032F0319C0 Named 'ScreenOnPowerStudyTraceSession'
    Logger Id 0x11 @ 0xFFFFBE03210E5600 Named 'ReFSLog'
    Logger Id 0x12 @ 0xFFFFBE03210E8040 Named 'UBPM'
    Logger Id 0x13 @ 0xFFFFBE03210E98C0 Named 'WdiContextLog'
    Logger Id 0x14 @ 0xFFFFBE03210EC040 Named 'WiFiDriverIHVSession'
    Logger Id 0x15 @ 0xFFFFBE03210EC600 Named 'WiFiSession'
    Logger Id 0x16 @ 0xFFFFBE0327797400 Named 'NetCfgTrace'
    Logger Id 0x18 @ 0xFFFFBE032EF3A9C0 Named 'SleepStudyTraceSession'
    Logger Id 0x19 @ 0xFFFFBE0330FA2040 Named 'F589D420-8B9A-40A2-95A8-DBB27ED17997'
    Logger Id 0x1a @ 0xFFFFBE0330FC2700 Named 'BE235AAC-AC9D-4DDC-9FA6-D4C37AF837B7'
    Logger Id 0x1b @ 0xFFFFBE0330F60040 Named 'D425B399-4B71-4151-8DAF-413F92A75EC3'
    Logger Id 0x1d @ 0xFFFFBE0329A0F600 Named 'WFP-IPsec Diagnostics'
    Logger Id 0x1e @ 0xFFFFBE032D8C9700 Named 'MpWppTracing-20230326-050133-00000003-ffffffff'
    Logger Id 0x20 @ 0xFFFFBE032B14E8C0 Named 'SgrmEtwSession'
    Logger Id 0x21 @ 0xFFFFBE032F03EA00 Named 'SHS-03262023-050148-7-1ff'

0: kd> !wmitrace.logdump 0x02
0: kd> !wmitrace.logdump 'Circular Kernel Context Logger'
    
==== WDF debugging ====

Look at all WDF100 on stacks:
1: kd> !stacks 2 wdf0100

4: kd> !process 0 0x1f wudfhost.exe
4: kd> !wdfkd.wdfdriverinfo SurfaceOemPanel.dll 0x10
4: kd> !wdfkd.wdfumirps
4: kd> !wdfdevice 0xfffffe08d5c4a628
4: kd> !wdfrequest 0xfffffe08d5bc4438 -- aka dt FxRequest 0xfffffe08d5bc4438
4: kd> !wdfumirp 0x000001f72a374990
4: kd> !wdfumdevstack  0x000001f72a39a5b0
4: kd> !wdfkd.wdfdevicequeues 0xfffffe08d5c4a628
4: kd> !wdfiotarget 0xfffffe08d5bdb278
4: kd> !wdfkd.wdflogdump WudfRd -d
4: kd> !wdfldr WudfRd !! verify driver was successfully loaded
4: kd> !wdfldr (no arg) shows all devices
4: kd> !mex.us -a surfaceoempanel

1: kd> dt FXDEVICE 0x216bc135b40

6: kd> .load wdfkd.dll
6: kd> !wdfdriverinfo SurfaceSerialHubDriver.sys fff
6: kd> !wdflogdump SurfaceSerialHubDriver.sys
6: kd> !WDFQUEUE <queue addr>
6: kd> !WDFDEVICE <device addr>

0: kd> !ioctldecode 0x230c14
Unknown IOCTL  : 0x230c14 
Device Type    : 0x23 (FILE_DEVICE_VIDEO)
Method         : 0x0 METHOD_BUFFERED 
Access         : FILE_ANY_ACCESS
Function       : 0x305


6: kd> !wdfkd.help
Wdfkd.dll extension built on Jan 01 2016 at 08:00:00

For detailed information about a specific command:!wdfkd.<wdfcommand> /?

!wdfhelp, !help
   Show this message.

!wdfcollection <WDFCOLLECTION handle>
   Dumps all the objects stored in the collection.

!wdfcommonbuffer <WDFCOMMONBUFFER handle>
   [KMDF only]
   This command will dump information about WDFCOMMONBUFFER.

!wdfchildlist <WDFCHLIDLIST handle>
   [KMDF only]
   Dumps the state of all the reported device descriptions in the list.

KMDF:
   !wdfcrashdump [information type]
   Used with kernel mode minidumps to display the log and other crashdump
   information if present in the dump file.
   [information type] is an optional parameter which supports the following values:
       log     - Displays the framework log (Default option)
       loader  - Displays the minidump's "dynamic-bound" drivers

UMDF v2.15+:
   !wdfcrashdump <driver_name>.dll [flags]
   Used with user mode minidumps to display captured log and loader information.
   If no driver name is provided, all active drivers in the host process during the fault
   will be printed. If a driver name is provided, logs will be displayed. The
   following flag values are supported:
      -m    - Merges framework and driver logs in their recorded order
      -d    - Displays only the driver logs
      -f    - Displays only the framework logs

!wdfdevext <device extension pointer from PDEVICE_OBJECT>
   For KMDF, dumps the WDFDEVICE handle related to the device extension 
   along with other WDF handle information.

   For UMDF, dumps the list of UMDF drivers corresponding to the 
   PDEVICE_OBJECT of Wudfrd, given the device extension pointer.

!wdfdevice <WDFDEVICE handle> [flags]
   Dumps information and state of the WDFDEVICE handle
   Flags: 0x01 - Dump verbose information
          0x02 - Dump detailed power state information
          0x04 - Dump detailed power policy state information
          0x08 - Dump detailed pnp state information
          0x10 - Dump all assigned state machine callbacks

!wdfdeviceinterrupts <WDFDevice handle>

!wdfdevicequeues <WDFDEVICE handle>
   Dumps information about all the WDFQUEUE's of WDFDEVICE.
   See wdfqueue as well.
   Flags: 0x10 - Dump unlimited number of queues and contained requests

!wdfdmaenabler <WDFDMAENABLER handle>
   [KMDF only]
   This command will dump verbose information about WDFDMAENABLER
   and its transaction and common buffer objects

!wdfdmaenablers <WDFDEVICE handle>
   [KMDF only]
   This command will list all dma-enablers and associated transaction
   and common buffer objects of WDFDEVICE handle.

!wdfdmatransaction <WDFDMATRANSACTION handle>
   [KMDF only]
   This command will dump information about WDFDMATRANSACTION.

!wdfdriverinfo <driver_name> [flags]
   Displays Wdf driver information, such as device tree and WDF Version Library levels.
   The driver_name should not include the ".sys" file extension.
   [flags] is an optional parameter.  The following values can be combined:
      0x00000001 - Display verifier settings and count of WDF objects.
                   Can be combined with 0x40 to get internal objects
      0x00000010 - Display the WDFHANDLE hierarchy for the driver

        The following flags are only valid when 0x00000010 is set:
        0x00000020 - Show context and callback information for each handle
        0x00000040 - Show internal type information for each handle
        0x00000080 - Show handle information in compact form
        0x00000100 - Show internal type information left justified
        0x00000200 - Show leaked objects (only if they are being tracked or verified)

      0x00000400 - Display device tree in verbose form.

!wdfextendwatchdog <WDFDEVICE handle> [0 | 1]
   [KMDF only]
   Extends the watchdog timer to measure responsiveness during power
   transitions for devices which are not power pageable
   Pass 0 to turn off the extended watchdog timer

!wdffindobjects [<start_address> | registers] [flags]
   This command searches the memory or registers for WDF objects.
   If no parameters are supplied, the command will continue the search
   started by a previous wdffindobjects <start_address> command
   [flags] are only inspected if [<start_address> | registers] is supplied.
     The following values are valid:
     0x00000001 - verbose output
     0x00000002 - show internal type information

!wdfforwardprogress <WDFQUEUE handle>
   [KMDF only]
   Dumps information about forwardprogress for a queue which supports forward progress.
   Flags: 0x10 - Dump unlimited number of requests

!wdfgetdriver
   Echo the current default driver_name.

!wdfhandle <driver handle value> [flags]
   Dumps information about the handle, including the underlying framework
   object pointer. Handle value is any handle value returned to the driver.
   Optional flags parameter may include the following values:
      0x00000010 - Display the WDFHANDLE hierarchy for the given handle

      The following flags are only valid when 0x00000010 is set:
      0x00000020 - Show context and callback information for each handle
      0x00000040 - Show internal type information for each handle
      0x00000080 - Show handle information in compact form
      0x00000100 - Show internal type information left justified

!wdfinterrupt <WDFINTERRUPT handle> [flags]
   Dumps information and state of the WDFINTERRUPT handle
   Optional flags parameter may include the following values:
      0x00000001 - Show interrupt dispatch table for the vector using !idt

!wdfiotarget <WDFIOTARGET handle> [flags]
   Dumps information and state of the WDFIOTARGET handle
   Optional flags may include the following values:
      0x00000001 - Show details on each pended WDFREQUEST
      0x00000010 - Dump unlimited number of requests

!wdfldr [<driver_name>]
   Prints information about the currently loaded KMDF and UMDF drivers or
   driver extensions.
   UMDF: 
      Providing the optional driver name will list out all instances of 
      the driver currently running on the system and their class extension
      drivers.
      If run from user mode debugger, it should be attached to WUDFHOST.exe 
      It would then list out all the UMDF driver instances in that process

   Optional driver_name is ignored for WDF v1.9 and below

!wdflogdump <driver_name> [WdfDriverGlobals | HostProcessId] [ -d | -f | -m | -a ] [LogAddress]
   KMDF:
     Prints the KMDF in-flight recorder log records for the named driver. If
     [WdfDriverGlobals] is supplied, then <driver_name> is ignored but still
     must be supplied.
     Driver log: -d
     Framework log: -f
     -a - Specific driver log. If this is used, LogAddress must be provided.
     
   UMDF:
     Prints the UMDF in-flight recorder log records for the named driver.
     The .dll extension must be provided. If [HostProcessId] is not provided,
     a list of valid IDs will be printed. If a single process can be determined
     it will automatically be chosen.
      For UMDF 2.15+ a flag is required. Omitting the flag will show all options. 
     Merged log: -m
     Driver log: -d
     Framework log: -f

!wdflogsave <driver_name> [capture_filename]
   Saves the WDF In-Flight Recorder log records for the
   named driver. The filename will be "<driver_name>.etl".
   The driver_name parameter should not include the ".sys" file extension.
   The optional capture_filename parameter should not include the
   ".etl" extension. If the capture filename parameter is not given
   the capture filename will be "<driver_name>.etl".

!wdfmemory <WDFMEMORY handle>
   Dumps the underlying buffer pointer and size for the WDFMEMORY handle.

!wdfobject <framework object pointer>
   Dumps information about the underlying framework object.

!wdfopenhandles <WDFDEVICE handle> [flags]
   Dumps information about all the handles opened on WDFDEVICE.
   Flags: 0x01 - Dump fileobject context information

!wdfpoolusage <driver_name> [address_to_search] [flags]
   Dumps pool usage for the given driver_name.
   If [address_to_search] is supplied, it will search for a pool allocation 
     that spans the address.  A value of 0 indicates
     that no allocation should be searched for.
   [flags] are only inspected if [address_to_search] is supplied.  The 
     following values are valid:
     0x00000001 - verbose output
     0x00000002 - show internal type information for each handle
     0x00000004 - show caller
   Example: !wdfpoolusage <driver_name>
              Dump pool and show handle information
            !wdfpoolusage <driver_name> 0 2
              Dump pool and show handle and internal type information

!wdfqueue <WDFQUEUE handle>
   Dumps information about WDFQUEUE.
   Flags: 0x10 - Dump unlimited number of requests

!wdfrequest <WDFREQUEST handle>
   Dumps information about WDFREQUEST.

!wdfsearchpath <filepath to the format (TMC/TMF) files>
   Set the searchpath to the format files needed to format
   the WDF log records.
   The environmental TRACE_FORMAT_SEARCH_PATH=<searchpath> may be set
   to your the default searchpath. The wdfsearchpath cmd value takes
   precedence over the environmental setting value.

!wdfsettraceprefix <trace prefix string>
   Set the trace prefix format string. This will control the trace message
   prefix issued with each log trace message.
   The environmental TRACE_FORMAT_PREFIX=<trace prefix string> may also be used.

!wdfsetdriver <driver_name>
   Set the default driver_name. This driver_name will be use when other
   driver_name-requiring wdfkd commands are invoked without the 
   driver_name parameter. User-mode drivers must include the .dll extension.
   See !wdfgetdriver to get the current name.

!wdfspinlock <spin lock object pointer>
   Dumps the spin lock information and the history of the spin lock object
   if available.

!wdftagtracker <tag object pointer> [flags]
   Dumps all outstanding tag information (tag value, line, file, time)
   for the given tag tracker.
   flags:  0x1 - display the history of acquires and releases on the object
           0x2 - display line number in hex instead of decimal
           0x4 - display all tags instead of cutting it off after 1,000 entries
   To retrieve a pointer to a tag tracker, use the !wdfkd.wdfobject extension
   on an internal framework object pointer. 

!wdftmffile <TMF file name>
   This command is used to set or clear the TMF file for formatting
   log. To clear the name, run the command without the filename.

!wdftraceprtdebug <on | off>
   This command will turn on the TracePrt diagnostic mode.
   To be used under the direction of support.

!wdfumdevstack <address> [flags]
   [UMDF Only]
   <address> is the address of UMDF Device stack. It can be obtained from 
   the output of !wdldr <driver_name> or !wdfumdevstacks
   Flags: 0x01 - dump detailed information (default).
   Flags: 0x80 - dump internal values of device stack.

!wdfumdevstacks [flags]
   [UMDF Only]
   Flags: 0x01 - dump detailed information (default).
   Flags: 0x80 - dump internal values of device stack.

!wdfumdownirp - This command works only in kernel debugger
   [UMDF v2 and greater]
   Usage 
   [1]: !wdfumdownirp <umirp>
      This command will print user mode file handle to be used
      with !handle to get the kernel mode _FILE_OBJECT

   [2]: !wdfumdownirp <umirp> <_FILE_OBJECT addr>
      To get the kernel mode IRP

!wdfumfile <address>
   [UMDF v2 and greater]
   <address> is the address of UM file obtained from the output of either
   !wdfumirp or !wdfumdevstacks

!wdfumirp <address> [flags]
   [UMDF Only]
   <address> is the address of UMDF host IRP (CWudfIrp) obtained 
   from the output of !wdfumirps
   Flags: 0x01 - dump details of IRP buffers
          0x80 - displays details about the internal framework

!wdfumirps [<numIrps | *> [<deviceStack | *> [flags]]]
   [UMDF v2 and greater]
   Flags: 0x01 - dump irp details

!wdfumtriage 
   [UMDF Only]
   Dumps triage information for UMDF. This includes information about 
   driver services, devices , pending IRPs and other useful information 
   about infrastructure components.

!wdfusbdevice <WDFUSBDEVICE handle> [flags]
   This command will dump out information about a WDFUSBDEVICE I/O target
   flags:  0x1 - display I/O target properties
           0x2 - display I/O target properties for each WDFUSBPIPE

!wdfusbinterface <WDFUSBINTERFACE handle> [flags]
   This command will dump out information about a WDFUSBINTERFACE
   This will include all of its alternate settings and currently selected
   setting.
   flags:  0x1 - display I/O target properties for each WDFUSBPIPE

!wdfusbpipe <WDFUSBPIPE handle> [flags]
   This command will dump out information about a WDFUSBPIPE I/O target
   flags:  0x1 - display I/O target properties

!wdfwmi <WDFDEVICE handle>
   [KMDF only]
   This command will dump out WMI registration, provider and instance information
   for a WDFDEVICE handle.


========================
BIOS version check:
wmic bios
Device manager\Firmware\Surface UEFI\Firmware\Firmware version.


> vertarget -- os version
1: kd> !sysinfo
!sysinfo [ cpuinfo | cpumicrocode | cpuspeed | gbl | machineid | registers | smbios ] [-csv | -noheaders]


7: kd> !sysinfo smbios
[System Information (Type 1) - Length 27 - Handle 0001h]
  Manufacturer                  Microsoft Corporation
  Product Name                  Surface Pro 7


> lmv <-- dump drivers
> lmv m igdkmdn64
0: kd> lmDvmSurfaceSerialHubDriver

1: kd> lmv m igdkmdn64
start             end                 module name
fffff807`88f60000 fffff807`8a411000   igdkmdn64   (deferred)             
    Mapped memory image file: c:\symbols\igdkmdn64.sys\5DFBC20514b1000\igdkmdn64.sys
    Image path: igdkmdn64.sys
    Image name: igdkmdn64.sys
    Timestamp:        Thu Dec 19 10:31:33 2019 (5DFBC205)
    CheckSum:         014B3286
    ImageSize:        014B1000
    File version:     26.20.100.7641
    Product version:  26.20.100.7641
    File flags:       0 (Mask 3F)
    File OS:          40004 NT Win32
    File type:        3.4 Driver
    File date:        00000000.00000000
    Translations:     0409.04b0
    CompanyName:      Intel Corporation
    ProductName:      Intel HD Graphics Drivers for Windows(R)
    InternalName:     igdkmdn64.sys
    OriginalFilename: igdkmdn64.sys
    ProductVersion:   26.20.100.7641
    FileVersion:      26.20.100.7641
    FileDescription:  Intel Graphics Kernel Mode New Driver
    LegalCopyright:   Copyright (c) 1998-2018 Intel Corporation.
Mini Kernel Dump does not contain unloaded driver list

Because kernel mode thread stack size is small (12Kb or 0×3000 on x86 and 24Kb on x64) 
we can simply dump mem-ory range between ESP-3000 and ESP+3000. We can use RSP register 
for x64 dumps but the output will be the same.
1: kd> dps esp-3000 esp+3000 <-- raw stack dump - shows all drivers on stacks

Dump driver symbols:
1: kd> x dxgkrnl!*
    and WHAMMO !!!!!

Upload graphics dumps to:
https://gdhm.intel.com/Upload/Upload

1: kd> !dxglog

1: kd> kL
Child-SP          RetAddr           Call Site
ffff8380`b9c2ef00 fffff807`8563e80f watchdog!WdDbgReportRecreate+0x116
ffff8380`b9c2ef50 fffff807`81d0035c dxgkrnl!TdrUpdateDbgReport+0x10f
ffff8380`b9c2efa0 fffff807`81d9a16e dxgmms2!VidSchiResetEngine+0x7c0
ffff8380`b9c2f290 fffff807`81d70463 dxgmms2!VidSchiResetEngines+0xc2
ffff8380`b9c2f2e0 fffff807`81d9a9ff dxgmms2!VidSchWaitForCompletionEvent+0x290a3
ffff8380`b9c2f360 fffff807`81cf17e8 dxgmms2!VidSchiWaitForCompletePreemption+0x7b
(Inline Function) --------`-------- dxgmms2!VidSchiCompletePreemption+0x12
ffff8380`b9c2f450 fffff807`81d59d8c dxgmms2!VidSchiSwitchFromSuspendedDevices+0x11048
(Inline Function) --------`-------- dxgmms2!VidSchiSubmitDeviceCommand+0x28
(Inline Function) --------`-------- dxgmms2!VidSchiSubmitQueueCommand+0x169
ffff8380`b9c2f4c0 fffff807`81d59bba dxgmms2!VidSchiRun_PriorityTable+0x1bc
ffff8380`b9c2f510 fffff807`7ef1e135 dxgmms2!VidSchiWorkerThread+0xca
ffff8380`b9c2f550 fffff807`7efc99a8 nt!PspSystemThreadStartup+0x55
ffff8380`b9c2f5a0 00000000`00000000 nt!KiStartSystemThread+0x28
1: kd> r
rax=ffffcc0ed39dfac0 rbx=ffffa78f4fec5680 rcx=ffffcc0ed39dfac0
rdx=0000000000000000 rsi=ffffcc0ed39dfac0 rdi=ffffa78f536926a0
rip=fffff8078578f9c6 rsp=ffff8380b9c2ef00 rbp=ffffa78f55a30010
 r8=0000000000000000  r9=0000000000000000 r10=fffff8077efca390
r11=000000000000000a r12=ffffa78f4fec2460 r13=0000000000000000
r14=ffffa78f4b5b1030 r15=0000000000000001
iopl=0         nv up ei pl zr na po nc
cs=0010  ss=0018  ds=002b  es=002b  fs=0053  gs=002b             efl=00040246
watchdog!WdDbgReportRecreate+0x116:
fffff807`8578f9c6 488b4f38        mov     rcx,qword ptr [rdi+38h] ds:002b:ffffa78f`536926d8=????????????????


1: kd> .thread
Implicit thread is now ffffa78f`4fec5680
> .frame x <== set to frame x of .thread
> .frame /r x <== set to frame x and show regs specific to that frame
> dv <== locals
> dv /V /i /t -- verbose locals

1: kd> !thread ffffa78f4fec5680
THREAD ffffa78f4fec5680  Cid 0004.0308  Teb: 0000000000000000 Win32Thread: 0000000000000000 RUNNING on processor 1
Not impersonating
GetUlongFromAddress: unable to read from fffff8077f22ca14
Owning Process            ffffa78f46066040       Image:         System
Attached Process          N/A            Image:         N/A
fffff78000000000: Unable to get shared data
Wait Start TickCount      712723       
Context Switch Count      1302471        IdealProcessor: 3             
ReadMemory error: Cannot get nt!KeMaximumIncrement value.
UserTime                  00:00:00.000
KernelTime                00:00:00.000
Win32 Start Address dxgmms2!VidSchiWorkerThread (0xfffff80781d59af0)
Stack Init ffff8380b9c2f5d0 Current ffff8380b9c2e8d0
Base ffff8380b9c30000 Limit ffff8380b9c29000 Call 0
Priority 16 BasePriority 16 UnusualBoost 0 ForegroundBoost 0 IoPriority 2 PagePriority 5
Child-SP          RetAddr           : Args to Child                                                           : Call Site
ffff8380`b9c2ef00 fffff807`8563e80f : ffffa78f`55a30010 ffff8380`b9c2f0a0 ffffa78f`55a30010 ffffa78f`536926a0 : watchdog!WdDbgReportRecreate+0x116 [onecoreuap\windows\core\watchdog\dbgrep\dump.cpp @ 832]
ffff8380`b9c2ef50 fffff807`81d0035c : ffffa78f`00000000 ffffa78f`52c90030 ffffa78f`55a30010 ffffa78f`4febe000 : dxgkrnl!TdrUpdateDbgReport+0x10f [onecoreuap\windows\core\dxkernel\dxgkrnl\core\dxgtdr.cxx @ 946]
ffff8380`b9c2efa0 fffff807`81d9a16e : ffffa78f`4febe000 00000000`00000000 00000000`00000001 00000000`00000001 : dxgmms2!VidSchiResetEngine+0x7c0 [onecoreuap\windows\core\dxkernel\dxgkrnl\dxgmms2\vidsch\vidschi.cxx @ 16581]
ffff8380`b9c2f290 fffff807`81d70463 : 00000000`00000000 ffffa78f`4febe000 00000000`00000000 ffff8380`b9c2f3a0 : dxgmms2!VidSchiResetEngines+0xc2 [onecoreuap\windows\core\dxkernel\dxgkrnl\dxgmms2\vidsch\vidschi.cxx @ 16721]
ffff8380`b9c2f2e0 fffff807`81d9a9ff : ffffa78f`4febe000 ffffffff`feced300 00000000`00000000 fffff807`81cda9f2 : dxgmms2!VidSchWaitForCompletionEvent+0x290a3 [onecoreuap\windows\core\dxkernel\dxgkrnl\dxgmms2\vidsch\vidsch.cxx @ 8514]
ffff8380`b9c2f360 fffff807`81cf17e8 : ffffa78f`4fe99000 00000000`00000000 ffffa78f`4fe99690 fffff807`81ce1400 : dxgmms2!VidSchiWaitForCompletePreemption+0x7b [onecoreuap\windows\core\dxkernel\dxgkrnl\dxgmms2\vidsch\vidschi.cxx @ 5527]
(Inline Function) --------`-------- : --------`-------- --------`-------- --------`-------- --------`-------- : dxgmms2!VidSchiCompletePreemption+0x12 (Inline Function @ fffff807`81cf17e8) [onecoreuap\windows\core\dxkernel\dxgkrnl\dxgmms2\vidsch\vidschi.cxx @ 15223]
ffff8380`b9c2f450 fffff807`81d59d8c : ffffa78f`50163010 ffffa78f`4fe99000 ffffa78f`4fc3b5a0 ffffa78f`539ed3b0 : dxgmms2!VidSchiSwitchFromSuspendedDevices+0x11048 [onecoreuap\windows\core\dxkernel\dxgkrnl\dxgmms2\vidsch\vidschi.cxx @ 24725]
(Inline Function) --------`-------- : --------`-------- --------`-------- --------`-------- --------`-------- : dxgmms2!VidSchiSubmitDeviceCommand+0x28 (Inline Function @ fffff807`81d59d8c) [onecoreuap\windows\core\dxkernel\dxgkrnl\dxgmms2\vidsch\vidschi.cxx @ 2531]
(Inline Function) --------`-------- : --------`-------- --------`-------- --------`-------- --------`-------- : dxgmms2!VidSchiSubmitQueueCommand+0x169 (Inline Function @ fffff807`81d59d8c) [onecoreuap\windows\core\dxkernel\dxgkrnl\dxgmms2\vidsch\vidschi.cxx @ 1953]
ffff8380`b9c2f4c0 fffff807`81d59bba : ffffa78f`4fe99400 fffff807`81d59af0 ffffa78f`4fe99000 00000000`00000000 : dxgmms2!VidSchiRun_PriorityTable+0x1bc [onecoreuap\windows\core\dxkernel\dxgkrnl\dxgmms2\vidsch\vidschi.cxx @ 1047]
ffff8380`b9c2f510 fffff807`7ef1e135 : ffffa78f`4fec5680 fffff807`00000001 ffffa78f`4fe99000 000024ef`bd9bbfff : dxgmms2!VidSchiWorkerThread+0xca [onecoreuap\windows\core\dxkernel\dxgkrnl\dxgmms2\vidsch\vidschi.cxx @ 576]
ffff8380`b9c2f550 fffff807`7efc99a8 : ffffdc80`45540180 ffffa78f`4fec5680 fffff807`7ef1e0e0 00000000`00000000 : nt!PspSystemThreadStartup+0x55 [minkernel\ntos\ps\psexec.c @ 9310]
ffff8380`b9c2f5a0 00000000`00000000 : ffff8380`b9c30000 ffff8380`b9c29000 00000000`00000000 00000000`00000000 : nt!KiStartSystemThread+0x28 [minkernel\ntos\ke\amd64\threadbg.asm @ 83]


1: kd> dt _ETHREAD ffffa78f4fec5680
nt!_ETHREAD
   +0x000 Tcb              : _KTHREAD
1: kd> dt _KTHREAD ffffa78f4fec5680


1: kd> !process ffffa78f46066040
PROCESS ffffa78f46066040
    SessionId: none  Cid: 0004    Peb: 00000000  ParentCid: 0000
    DirBase: 001ad000  ObjectTable: ffffcc0eccc0aac0  HandleCount: <Data Not Accessible>
    Image: System
    VadRoot ffffa78f508d1c70 Vads 8 Clone 0 Private 21. Modified 561106. Locked 0.
    DeviceMap ffffcc0eccc13660
    Token                             ffffcc0eccc0b8d0
    ReadMemory error: Cannot get nt!KeMaximumIncrement value.
fffff78000000000: Unable to get shared data
    ElapsedTime                       00:00:00.000
    UserTime                          00:00:00.000
    KernelTime                        00:00:00.000
    QuotaPoolUsage[PagedPool]         0
    QuotaPoolUsage[NonPagedPool]      272
    Working Set Sizes (now,min,max)  (0, 0, 0) (0KB, 0KB, 0KB)
    PeakWorkingSetSize                0
    VirtualSize                       3 Mb
    PeakVirtualSize                   13 Mb
    PageFaultCount                    0
    MemoryPriority                    BACKGROUND
    BasePriority                      8
    CommitCharge                      49

        *** Error in reading nt!_ETHREAD @ ffffa78f4606b040

1: kd> dt nt!_MMVAD ffffa78f508d1c70
   +0x000 Core             : _MMVAD_SHORT
   +0x040 u2               : <anonymous-tag>
   +0x048 Subsection       : ???? 
   +0x050 FirstPrototypePte : ???? 
   +0x058 LastContiguousPte : ???? 
   +0x060 ViewLinks        : _LIST_ENTRY
   +0x070 VadsProcess      : ???? 
   +0x078 u4               : <anonymous-tag>
   +0x080 FileObject       : ???? 


0: kd> .asm no_code_bytes Assembly options: no_code_bytes
0: kd> ub nt!KiTrap00+0x88 nt!KiTrap00+0x74: 8083483b test

0: kd> uf igdkmdn64!DxgkDdiCollectDbgInfo

1: kd> .thread /r /p ffffa78f`4fec5680
Implicit thread is now ffffa78f`4fec5680
Implicit process is now ffffa78f`46066040
Loading User Symbols
1: kd> kL 100
Child-SP          RetAddr           Call Site
ffff8380`b9c2ef00 fffff807`8563e80f watchdog!WdDbgReportRecreate+0x116
ffff8380`b9c2ef50 fffff807`81d0035c dxgkrnl!TdrUpdateDbgReport+0x10f
ffff8380`b9c2efa0 fffff807`81d9a16e dxgmms2!VidSchiResetEngine+0x7c0
ffff8380`b9c2f290 fffff807`81d70463 dxgmms2!VidSchiResetEngines+0xc2
ffff8380`b9c2f2e0 fffff807`81d9a9ff dxgmms2!VidSchWaitForCompletionEvent+0x290a3
ffff8380`b9c2f360 fffff807`81cf17e8 dxgmms2!VidSchiWaitForCompletePreemption+0x7b
(Inline Function) --------`-------- dxgmms2!VidSchiCompletePreemption+0x12
ffff8380`b9c2f450 fffff807`81d59d8c dxgmms2!VidSchiSwitchFromSuspendedDevices+0x11048
(Inline Function) --------`-------- dxgmms2!VidSchiSubmitDeviceCommand+0x28
(Inline Function) --------`-------- dxgmms2!VidSchiSubmitQueueCommand+0x169
ffff8380`b9c2f4c0 fffff807`81d59bba dxgmms2!VidSchiRun_PriorityTable+0x1bc
ffff8380`b9c2f510 fffff807`7ef1e135 dxgmms2!VidSchiWorkerThread+0xca
ffff8380`b9c2f550 fffff807`7efc99a8 nt!PspSystemThreadStartup+0x55
ffff8380`b9c2f5a0 00000000`00000000 nt!KiStartSystemThread+0x28


dump arch specific pointers - auto decode 32/64 bit:
> dp @eax 
dump registers:
> r
dump contents:
> du @eax
> dd @eax
> dc @eax <== cool hex dump with ascii

> dds <addr1> <addr2> <= lists dwords of stack: StackLimit & StackBase from !teb

> lm <= lists modules (drivers and limits)

Interrupts: dump IDT

.chain
Extension DLL search Path:
    C:\Program Files (x86)\Windows Kits\8.1\Debuggers\x64\WINXP;C:\Program Files (x86)\Windows Kits\8.1\Debuggers\x64\winext;C:\Program Files (x86)\Windows Kits\8.1\Debuggers\x64\winext\arcade;C:\Program Files (x86)\Windows Kits\8.1\Debuggers\x64\pri;C:\Program Files (x86)\Windows Kits\8.1\Debuggers\x64;C:\Program Files (x86)\Windows Kits\8.1\Debuggers\x64\winext\arcade;C:\CEdev\bin;C:\Python37\;C:\Python37\DLLs\;C:\Python37\Scripts\;C:\Python37\Tools\;C:\Python37\Tools\ninja\;C:\Python36\;C:\Python36\DLLs\;C:\Python36\Scripts\;C:\Python36\Tools\;C:\Python36\Tools\ninja\;C:\Perl64\site\bin;C:\Perl64\bin;C:\Program Files\Common Files\Microsoft Shared\Microsoft Online Services;C:\Program Files (x86)\Common Files\Microsoft Shared\Microsoft Online Services;C:\WINDOWS\system32;C:\WINDOWS;C:\WINDOWS\System32\Wbem;C:\WINDOWS\System32\WindowsPowerShell\v1.0\;C:\WINDOWS\System32\OpenSSH\;C:\Program Files\Git\cmd;C:\Program Files\TortoiseGit\bin;C:\Program Files\dotnet\;C:\Program Files\Microsoft SQL Server\130\Tools\Binn\;C:\Program Files (x86)\IAR Systems\Embedded Workbench 7.0;C:\Program Files (x86)\Windows Kits\10\Windows Performance Toolkit\;C:\FPC\3.0.4\bin\i386-Win32;C:\WINDOWS\system32\config\systemprofile\.dnx\bin;C:\Program Files\Microsoft DNX\Dnvm\;C:\Program Files\Microsoft SQL Server\120\Tools\Binn\;C:\Program Files (x86)\Windows Kits\8.1\Windows Performance Toolkit\;C:\Program Files\Microsoft SQL Server\Client SDK\ODBC\170\Tools\Binn\;C:\Users\v-babart\AppData\Local\NuGet;C:\Users\v-babart\AppData\Local\Microsoft\WindowsApps;C:\Users\v-babart\.dotnet\tools;C:\Users\v-babart\AppData\Local\Microsoft\WindowsApps;C:\Program Files (x86)\Nmap;C:\Users\v-babart\.dotnet\tools

Extension DLL chain:
    kd: image 10.0.19041.1, built Mon Feb 02 01:30:16 2105
        [path: C:\WINDOWS\system32\kd.dll]
    wdfkd: image 6.3.9600.17336, API 1.0.0, built Thu Feb 26 18:03:19 2015
        [path: C:\Program Files (x86)\Windows Kits\8.1\Debuggers\x64\winext\wdfkd.dll]
    dbghelp: image 6.3.9600.17298, API 6.3.6, built Fri Oct 24 18:07:10 2014
        [path: C:\Program Files (x86)\Windows Kits\8.1\Debuggers\x64\dbghelp.dll]
    ext: image 6.3.9600.17336, API 1.0.0, built Thu Feb 26 18:15:38 2015
        [path: C:\Program Files (x86)\Windows Kits\8.1\Debuggers\x64\winext\ext.dll]
    exts: image 6.3.9600.17336, API 1.0.0, built Thu Feb 26 18:11:52 2015
        [path: C:\Program Files (x86)\Windows Kits\8.1\Debuggers\x64\WINXP\exts.dll]
    kext: image 6.3.9600.17298, API 1.0.0, built Fri Oct 24 18:13:06 2014
        [path: C:\Program Files (x86)\Windows Kits\8.1\Debuggers\x64\winext\kext.dll]
    kdexts: image 6.3.9600.17298, API 1.0.0, built Fri Oct 24 18:13:07 2014
        [path: C:\Program Files (x86)\Windows Kits\8.1\Debuggers\x64\WINXP\kdexts.dll]

6: kd> !kext.help
cbreg [%%]<RegBaseAddress>    - Displays CardBus and ExCA registers
db [Flag] [Address [L <Range>]] - Displays memory in bytes and ANSI chars
dc [Flag] [Address [L <Range>]] - Displays memory in ULONGs and ANSI chars
dd [Flag] [Address [L <Range>]] - Displays memory in ULONGs
diskspace <DriveLetter>[:]      - Displays free disk space for volume
dp [Flag] [Address [L <Range>]] - Displays memory in ULONG_PTR
du [Flag] [Address [L <Range>]] - Displays memory in wide chars
dw [Flag] [Address [L <Range>]] - Displays memory in USHORTs
eb [Flag] <Address> [[Value1] [[Value2]...]]] - Write bytes into memory
ed [Flag] <Address> [[Value1] [[Value2]...]]] - Write ULONGs into memory
ecb <Bus>.<Dev>.<Func> <Offset> <Data> - Edit PCI ConfigSpace byte
ecd <Bus>.<Dev>.<Func> <Offset> <Data> - Edit PCI ConfigSpace ULONG
ecs                                    - Edit PCI ConfigSpace help
ecw <Bus>.<Dev>.<Func> <Offset> <Data> - Edit PCI ConfigSpace WORD
exca <BasePort>.<SocketNum>    - Displays CardBus ExCA registers only
help                           - Show this help
pci [Flag] [Segment] [Bus] [Device] [Function] [MinAddr] [MaxAddr]
                               - Displays PCI ConfigSpace

Type ".hh [command]" for more detailed help
   
6: kd> !ext.help
address [address]          - Displays the address space layout
        [-UsageType]       - Displays the address space regions of the given type
analyze [-v]               - Analyzes current exception or bugcheck
cpuid [processor]          - Displays CPU version info for all CPUs
elog_str <message>         - Logs simple message to host event log
cppexr <exraddress>        - Displays a C++ EXCEPTION_RECORD
error [errorcode]          - Displays Win32 & NTSTATUS error string
exchain                    - Displays exception chain for current thread
findxmldata                - Displays data from cabbed sysdata.xml
for_each_frame <cmd>       - Executes command for each frame in current
                             thread
for_each_local <cmd> $$<n> - Executes command for each local variable in
                             current frame, substituting fixed-name alias
for_each_process <cmd>     - Executes command for each process
for_each_thread <cmd>      - Executes command for each thread
                             $u<n> for each occurrence of $$<n>
gle [-all]                 - Displays last error & status for current thread
imggp <imagebase>          - Displays GP directory entry for 64-bit image
imgreloc <imagebase>       - Relocates modules for an image
list [-? | parameters]     - Displays lists
obja <address>             - Displays OBJECT_ATTRIBUTES[32|64]
owner [symbol!module]      - Detects owner for current exception or
                             bugcheck from triage.ini
rtlavl <address>           - Displays RTL_AVL_TABLE
std_map <address>          - Displays a std::map<>
str <address>              - Displays ANSI_STRING or OEM_STRING
ustr <address>             - Displays UNICODE_STRING

Type ".hh [command]" for more detailed help

6: kd> !exts.help
acl <address> [flags]        - Displays the ACL
atom <address>               - Displays the atom or table(s) for the process
avrf [-? | parameters]       - Displays or modifies App Verifier settings
cs [-? | parameters]         - Displays critical sections for the process
cxr                          - Obsolete, .cxr is new command
decodeptr32 <value>          - Decode encoded 32-bit pointer value (using process cookie)
decodeptr64 <value>          - Decode encoded 64-bit pointer value (using process cookie)
dlls [-h | parameters]       - Displays loaded DLLS
encodeptr32 <ptr>            - Encode 32-bit value for encoded pointer (using process cookie)
encodeptr64 <ptr>            - Encode 64-bit value for encoded pointer (using process cookie)
exr                          - Obsolete, .exr is new command
findthis [-? | options]     - Search the registers for the this pointer
gflag [-?|<value>]           - Displays the global flag
heap [-? | parameters]       - Displays heap info
help                         - Displays this list
kuser                        - Displays KUSER_SHARED_DATA
peb [address]                - Displays the PEB structure
psr <value>|@ipsr [flags]    - Displays an IA64 Processor Status Word
sd <address> [flags]         - Displays the SECURITY_DESCRIPTOR
shipassert                   - Displays ship asserts
sid <address> [flags]        - Displays the SID
slist [-? | parameters]      - Displays singly-linked list
stl [options] <varname>      - Dumps an STL variable
stltree [options] <address>  - Dumps an STL set, map, multiset, or multimap
teb [address]                - Displays the TEB structure
tls <slot | -1> [teb | 0]    - Dumps TLS slots. !tls /? for usage
token [-n|-?] <handle|addr>  - Displays TOKEN
tp <command>                 - Dump threadpool information

Type ".hh [command]" for more detailed help

6: kd> !kext.help
cbreg [%%]<RegBaseAddress>    - Displays CardBus and ExCA registers
db [Flag] [Address [L <Range>]] - Displays memory in bytes and ANSI chars
dc [Flag] [Address [L <Range>]] - Displays memory in ULONGs and ANSI chars
dd [Flag] [Address [L <Range>]] - Displays memory in ULONGs
diskspace <DriveLetter>[:]      - Displays free disk space for volume
dp [Flag] [Address [L <Range>]] - Displays memory in ULONG_PTR
du [Flag] [Address [L <Range>]] - Displays memory in wide chars
dw [Flag] [Address [L <Range>]] - Displays memory in USHORTs
eb [Flag] <Address> [[Value1] [[Value2]...]]] - Write bytes into memory
ed [Flag] <Address> [[Value1] [[Value2]...]]] - Write ULONGs into memory
ecb <Bus>.<Dev>.<Func> <Offset> <Data> - Edit PCI ConfigSpace byte
ecd <Bus>.<Dev>.<Func> <Offset> <Data> - Edit PCI ConfigSpace ULONG
ecs                                    - Edit PCI ConfigSpace help
ecw <Bus>.<Dev>.<Func> <Offset> <Data> - Edit PCI ConfigSpace WORD
exca <BasePort>.<SocketNum>    - Displays CardBus ExCA registers only
help                           - Show this help
pci [Flag] [Segment] [Bus] [Device] [Function] [MinAddr] [MaxAddr]
                               - Displays PCI ConfigSpace

Type ".hh [command]" for more detailed help

6: kd> !kdexts.help
acpicache [flags]            - Displays cached ACPI tables
acpiinf                      - Displays ACPI Information structure
acpiirqarb                   - Displays ACPI IRQ Arbiter data
acpiresconflict              - Displays detail on resource conflicts that cause
                               bugcheck 0xA5 (ACPI_ROOT_PCI_RESOURCE_FAILURE)
ahcache [flags]              - Displays application compatibility cache
amli <command|?> [params]    - Use AMLI debugger extensions
apc [[proc|thre] <address>]  - Displays Asynchronous Procedure Calls
arbiter [flags]              - Displays all arbiters and arbitrated ranges
arblist <address> [flags]    - Dump set of resources being arbitrated
bcb <address>                - Display the Buffer Control Block
biosreslist <address>        - Dump PnpBios/ACPI resource list
blockeddrv                   - Dumps the list of blocked drivers in the system
bpid <pid>                   - Tells winlogon to do a user-mode break into
                               process <pid>
bugdump                      - Display bug check dump data
bushnd [address]             - Dump a HAL "BUS HANDLER" structure
ca <address> [flags]         - Dump the control area of a section
calldata <table name>        - Dump call data hash table
cchelp                       - Display Cache Manager debugger extensions
chklowmem                    - Tests if PAE system booted with /LOWMEM switch
cmreslist <CM Resource List> - Dump CM resource list
cpuinfo [id]                 - Displays CPU information for specified processor
dbgprint                     - Displays contents of DbgPrint buffer
dblink <address> [count] [bias] - Dumps a list via its blinks
dflink <address> [count] [bias] - Dumps a list via its flinks
deadlock [1]                 - Display Driver Verifier deadlock detection info
defwrites                    - Dumps deferred write queue & cache write
                               throttle analysis
devext [<address> <type>]    - Dump device extension of specified type
devhandles [<address>]       - Dumps open handles against the specified device
devinst                      - dumps the device reference table
devnode <device node> [flags] [service] - Dump the device node
devobj <device>              - Dump the device object and Irp queue
devpowerstate [device node]  - Dumps the device node with the power state and all attached devices
devstack <device>            - Dump device stack associated w/device object
dma [<adapter> [flags]]      - Displays Direct Memory Access subsystem info
dpa [options]                - Displays pool allocations
dpcs [processor]             - Dumps the queued DPCs
dpcstackhistory [processor] [count] - Dumps last [count] number of captured (if any) DPC watchdog callstack samples
dpcwatchdog                  - Dumps the DPC history of all processsors
dpchistory [processor][id's]
driveinfo <drive>[:]         - Dump drive volume information for specific drive
drivers                      - Display info about loaded system modules
drvobj <driver> [flags]      - Dump the driver object and related information
dskheap                      - Dump desktop heap
e820reslist <List>           - Dump an ACPI_BIOS_MULTI_NODE resource list
errlog                       - Dump the error log contents
exqueue [flags] [partition]  - Dump the ExWorkerQueues
exrlog                       - Display the exception log
facs                         - Dumps the Firmware ACPI Control Structure
fadt                         - Dumps the Fixed ACPI Description Table
filecache                    - Dumps information about the file system cache
filelock <address>           - Dump a file lock structure - address is either
                               the filelock or a fileobject
filetime                     - Dumps 64-bit FILETIME as a human-readable time
findautochkblockers          - Dumps file handles and file-names which are
                               preventing autochk from running
finddata <address> <offset>  - Find cached data at given offset in FILE_OBJECT
findhandle <object> <process | 0> - Find handles referring to the specified object
findthreads [-v] [-t <addr>]|[-i <addr>]|[-d <addr>]|[-a <addr> [-e <addr>|-l <length>]] - Find threads with stack-locations referencing a given object/memory range
fpsearch <address>           - Find a freed special pool allocation
frag [flags]                 - Kernel mode pool fragmentation
frozen                       - Show processor states (Current,Frozen,Running)
gbl                          - Dumps the ACPI Global Lock
gentable <address> [flags]   - Dumps the given rtl_generic_table
handle <addr> <flags> <process> <TypeName> -  Dumps handle for a process
help                         - Displays this list
hidppd <address> <flags>     - Dump Preparsed Data of HID device
ib <port>                    - Read a byte from an I/O port
id <port>                    - Read a double-word from an I/O port
idt <vector>                 - DumpISRs referenced by each IDT entry
ioresdes <address>           - Display IO_RESOURCE_DESCRIPTOR structure
ioreslist <IO Resource List> - Dump IO resource requirements list
ipi                          - Dump IPI processors state
iw <port>                    - Read a word from an I/O port
irp <address> <dumplevel>    - Dump IRP at specified address
irpfind [pooltype] [restart addr] [<irpsearch> <address>]
                             - Search pool for active IRPs
irql [processor]             - Display current IRQL for processor
isainfo <address> [flags]    - Display ISA Bus and Card info
job <address> [flags]        - Dump JobObject at address, processes in job
joblist [flags]              - Displays all active job objects
lbt                          - Dump legacy bus information table
loadermemorylist <address>   - Display OSLOADER memory allocation list
locks [-v] <address>         - Dump kernel mode resource locks
logonsession [<LUID> [level]]  - Display logon sessions
lookaside <address> <options> <depth> - Dump lookaside lists
lpc                          - Dump lpc ports and messages
mapic                        - Dumps the ACPI Multiple APIC Table
mca <address>                - Display Machine Check Architecture registers
memlist                      - Scans physical memory lists for consistency
memusage                     - Dumps the page frame database table
nsobj   <address>            - Dumps an ACPI Namespace Object
nstree [<address>]           - Dumps an ACPI Namespace Object tree
numa                         - Display Non-Uniform Memory Access nodes
numa_hal                     - Display HAL NUMA info
ob <port>                    - Write a byte to an I/O port
object <-r | Path | address | 0 TypeName>  - Dumps an object manager object
obtrace <address|object>     - Display object trace information
od <port>                    - Write a double-word to an I/O port
openmaps <shared cache map > - Dumps the active views for a shared cache map
ow <port>                    - Write a word to an I/O port
pcitree                      - Dump the PCI tree structure
pcm <address>                - Detects valid address for Private Cache Map
pagefile                     - Dumps pagefile information and related device stacks
pcmcia [1]                   - Displays PCMCIA devices and their states
pcr [processor]              - Dumps the Processor Control Registers
pfn                          - Dumps the page frame database entry for the
                               physical page
pnpaction                    - Dump PNP action queue
pnpcompletion                - Dump PNP completion queue
pnpevent <event entry>       - Dump PNP events
pnplocks                     - Dump PNP locks
pnpthreads                   - Dump active Pnp thread if any
pnptriage                    - 'x' command for Pnp - dumps basic info useful for triage
pocaps                       - Dumps System Power Capabilities.
podev <devobj>               - Dumps power relevent data in device object
polist [<devobj>]            - Dumps power Irp serial list entries
ponode                       - Dumps power Device Node stack (devnodes in
                               power order)
pool [<0|-1|address> [detail]] - Dump kernel mode heap
poolfind Tag [pooltype] -    - Finds occurrences of the specified Tag
poolused [flags [TAG]]       - Dump usage by pool tag
popolicy [<address> [flags]] - Dumps System Power Policy.
poproc [<address> [flags]]   - Dumps Processor Power State.
poprocpolicy [<address> [flags]] - Dumps Processor Power Policy.
poreqlist [<devobj>]         - Dumps PoRequestedPowerIrp created Power Irps
posettings [/?]              - Dumps the power settings database
potrigger <address>          - Dumps POP_ACTION_TRIGGER.
powertriage                  - Dumps basic information useful for triage of power related issues
pplookaside [processor] [lookasidelist] - Dumps PerProcessor LookasideLists.
prcb [processor]             - Displays the Processor Control Block
process [<address>] [flags] [image name] - Dumps process at specified address
pte <address>                - Dump PDE and PTE for the entered address
ptov PhysicalPageNumber      - Dump all valid physical<->virtual mappings
                               for the given page directory
qlocks                       - Dumps state of all queued spin locks
range <RtlRangeList>         - Dump RTL_RANGE_LIST
ready                        - Dumps state of all READY system threads
reg [<command> [params]]     - Registry extensions
rellist <relation list> [flags] - Dump PNP relation lists
remlock                      - Dump a remove lock structure
rsdt                         - Displays the ACPI Root System Description Table
running [-t] [-i]            - Displays the running threads in the system
scm <address>                - Detects valid address for Shared Cache Map
session [-?] [-s] <id> [flags] [image name] - Dumps sessions
sprocess [<id|-1> [flags]]   - Displays session processes
srb <address>                - Dump Srb at specified address
stacks <detail-level>        - Dump summary of current kernel stacks
swd                          - Dump Software Watchdog state
sysinfo                      - Dump SMBios, ACPI, and CPU info
sysptes                      - Dumps the system PTEs
thread [<address> [flags]]   - Dump current thread, specified thread, or stack
                               containing address
timer                        - Dumps timer tree
tokenleak [<0>|<1> <ProcessCid> <BreakCount> <MethodWatch>]
                             - Activates token leak tracking
tunnel <address>             - Dump a file property tunneling cache
trueref <address> [<process>] - Displays the refcount of the specified object
tz [<address> <flags>]       - Dumps Thermal Zones. No Args dumps All TZs
tzinfo <address>             - Dumps Thermal Zone Information.
ubc [*|<bpid>]               - Clears a user-space breakpoint
ubd [*|<bpid>]               - Disables a user-space breakpoint
ube [*|<bpid>]               - Enables a user-space breakpoint
ubl                          - Lists all user-space breakpoint
ubp <address>                - Sets a user-space breakpoint
vad                          - Dumps VADs
verifier                     - Displays Driver Verifier settings and status
version                      - Version of extension dll
vm                           - Dumps virtual management values
vpb <address>                - Dumps volume parameter block
vtop DirBase address         - Dumps physical page for virtual address
whatperftime <perf>          - Converts performance time to HH:MM:SS.mmm
whattime <ticks>             - Converts ticks to HH:MM:SS.mmm
wsle [<flags> [address]]     - Display Working Set List Entries
zombies [<flags> [address]]  - Find all zombie processes


0: kd> !userkdx.help
-------------- USERKDX Debug Extension help:--------------

help -v [cmd]                 - Displays this list or gives details on command
atom                          - Dump atoms or atom tables
dcls [pcls]                   - Dump window class
dcur -aivp [pcur]             - Dump cursors
dde -vr [conv|window|xact]    - Dump DDE tracking information
ddl -vl [pdesk] [tag1] [tag2] - Dump desktop log for pdesk (filtered by tag1/tag2)
ddesk -vhd <pdesk>            - Displays objects allocated in desktop
ddk <pKbdTbl>                 - Dump deadkey table
df [flags] | [-p pid] | [-l]  - Displays or sets debug flags
dhe [pointer|handle] | [-t[o[p]] type [pti/ppi]] - Dump handle entry(ies)
dhard                         - Dump hard error list
dhid [-pv] [ppi]              - Dump HID info
dhk -ag[d] [pti]              - Dump hooks
dhot                          - Dump registered hotkeys
dhnr                          - Dump HID notification record
dhs -vpty [id|type]           - Dump handle table statistics
di                            - Displays USER input processing globals.
dimc [-hrvus] -[wci] [imc|wnd,etc.] - Dump Input Context
dimk [pImeHotKeyObj]          - Dump IME Hotkeys
dinp -v [pDeviceInfo]         - Dump input diagnostics
dinp_rim -v [pDeviceInfo]         - Dump input diagnostics
dkl -akv <pkl>                - Dump keyboard layout structures
dll [*]addr [l#] [b#] [o#] [c#] [t[addr]] - Dump linked list (can Ctrl-C)
dlr -lsc <pointer|handle>     - Displays assignment locks for object
dm -vris <menu|window>        - Dumps a menu
dmon <pMonitor>               - Dump MONITOR
dmq [-act] [pq]               - Messages in queues
dp -vcpt  [id]                - Displays simple process information
dpi [-cphsdlmbvf] [ppi]       - Displays PROCESSINFO structure specified
dq [-ampt] [pq]               - Displays Q structure specified
dsi [-bchmopvw]               - Displays SERVERINFO struct
dsms -vl [psms]               - Displays SMS (SendMessage structure) specified
dt -gvcp [id]                 - Displays simple thread information
dtdb [ptdb]                   - Dump Task Database
dti [pti]                     - Displays THREADINFO structure
dtin [Win32Thread]  - Displays THREADINFO structure
dtl [-t] [pointer|handle]     - Displays thread locks
dtmr [-itpqvc] [ptmr|pti|ppi|pq] - Dumps timer structure.
dupm                          - User Preference Bitmask
dw -aefhvsprwoz [hwnd/pwnd]   - Displays information on windows in system
dws [pws]                     - Dump windowstations
dpa -cvsfrp                   - Dump pool allocations
dvs -s                        - Dump sections and mapped views
dy [pdi]                      - Dump DISPLAYINFO
find baseaddr addr [o#]       - Find linked list element
kbd -au [pq]                  - Displays key state for queue
sas [-s] <addr> [length]      - Stack Analysis Stuff
tag [<tag #> [<flags>]]       - Displays or sets tags
test                          - Test basic debug functions.
uver                          - show versions of user and exts.
hh                            - dumps gdwHydraHint.
wm, vkey, ddlgt, disi: see each help
hogs [N]                      - Dump CPU hogs
dce                           - Dumps DC Cache Entry information.
daccel <pAccelTable | hAccelTable> - Dump the given accelerator table
heapff <pHeapBlock> - Looks for the given heap address in our list of freed heap.
dheap [-o <pid>] [-p] [-t] [-s] <pheap>  - dumps heap information for a win32 heap.
csrp [-vfp] [<pid>|<cp>]     - finds the given PID in the CSR process list.
dsmwp psmwp                   - Dumps the given smwp chain
dcvr pcvr                     - Dumps the given CVR structure
dclip       - Dumps clipboard
dwe                           - Dump winevents
dpow            - Dumps power related information like state of the display etc
dmaginp                       - Displays magnification input transform.
dmip                          - Displays MiP info.
dlw                           - Displays Window link log.
dlfg                          - Displays foreground change log.
dlfc [<pwndShellFrame>]       - Displays focus change log.
dfal                          - Displays foreground activation log.
dkcl                          - Displays Keyboard Correction log.
datmchk                       - Display Atomic Check log.
newsharingmode                - Tell the extesion about USER objects shared memory implementation
dumpentrypoints               - Dumps all win32k entry point functions.
cbs Prints complete callback stack
lcbs      - Callback stacks logging
luserint      - NTUSER interaction logging
bcumcb - Breaks/Crashes a given thread when it makes user mode callbacks


X64-specific:

apic [base]                  - Dump local apic
apicerr                      - Dumps local apic error log
ioapic [base]                - Dump io apic
mtrr                         - Dumps MTRR

Type ".hh [command]" for more detailed help


!poaction


kd> .sympath+ srv*;C:\git\SurfaceOemPanelDriver\Debug\x64\bin;C:\git\SurfaceTconDriver\Debug\x64\bin

0:000> .symopt- 0x40
Symbol options are 0x30377:
0x00000001  SYMOPT_CASE_INSENSITIVE
0x00000002  SYMOPT_UNDNAME
0x00000004  SYMOPT_DEFERRED_LOADS
0x00000010  SYMOPT_LOAD_LINES
0x00000020  SYMOPT_OMAP_FIND_NEAREST
0x00000100  SYMOPT_NO_UNQUALIFIED_LOADS
0x00000200  SYMOPT_FAIL_CRITICAL_ERRORS
0x00010000  SYMOPT_AUTO_PUBLICS
0x00020000  SYMOPT_NO_IMAGE_SEARCH
Load symbols:
!sym noisy
.reload /f

Registry
!reg dumppool
!reg querykey \REGISTRY\MACHINE\SYSTEM\ControlSet001\Services

4: kd> !reg querykey \REGISTRY\MACHINE\SYSTEM\ControlSet001\Services\igfxn
Sorry <\REGISTRY\MACHINE\SYSTEM\ControlSet001\Services\igfxn> is not cached 
===========================================================================================
Falling back to traversing the tree of nodes.
Hive         ffff8c8320246000
KeyNode      ffff8c83251e6cac
[SubKeyAddr]         [SubKeyName]
ffff8c83251e6f2c     Parameters
ffff8c83251e7024     Video
[SubKeyAddr]         [VolatileSubKeyName]
ffff8c83209f8644     Enum
 Use '!reg keyinfo ffff8c8320246000 <SubKeyAddr>' to dump the subkey details
[ValueType]         [ValueName]                   [ValueData]
REG_DWORD           Type                          1
REG_DWORD           Start                         3
REG_DWORD           ErrorControl                  0
REG_DWORD           Tag                           5
REG_EXPAND_SZ       ImagePath                     \SystemRoot\System32\DriverStore\FileRepository\iigd_dch.inf_amd64_6b06e9c04476fc60\igdkmdn64.sys
REG_SZ              Group                         Video
REG_MULTI_SZ        Owners                        oem0.inf\0
REG_DWORD           DCHUVen                       8086

sites:
https://github.com/reactos/reactos <= mock kernel sources
https://bsodtutorials.wordpress.com/
https://stackoverflow.com/questions/4946685/good-tutorial-for-windbg
https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/debugging-a-stack-overflow
https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/debug-universal-drivers--kernel-mode-
http://pciids.sourceforge.net/pci.ids
-- good talk on power states
https://www.kernel.org/doc/html/v4.14/driver-api/pm/devices.html
https://docs.microsoft.com/en-us/windows-hardware/drivers/storage/life-cycle-of-a-storport-driver

https://bsodtutorials.wordpress.com/2014/08/09/windows-access-tokens-token-and-_token

References:
http://www.brandonfa.lk/win8/index.html
http://www.brandonfa.lk/win8/win8_devrel_head_x64/
http://www.brandonfa.lk/win8/win8_devrel_head_x86/usbhub3.h
https://docs.microsoft.com/en-us/windows-hardware/drivers/wdf/using-umdf-debugger-extensions
https://docs.microsoft.com/en-us/windows-hardware/drivers/wdf/debugging-umdf-2-0-drivers
https://www.geoffchappell.com/index.htm <-- nt structures
https://theartofdev.com/windbg-cheat-sheet/
https://www.vergiliusproject.com/kernels/x86/Windows%2010/1507%20Threshold%201
Power problems:
https://systemdebug.in/0x9f-bugcheck-with-param-3-here-is-how-you-go-about-it/
https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/using-symchk
https://www.osr.com/nt-insider/2011-issue2/basics-wdf-queues/
ACL: https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/determining-the-acl-of-an-object

WDF debugging:
https://www.osr.com/nt-insider/2015-issue1/kmdf-umdf-hints/
https://www.osr.com/nt-insider/2011-issue2/analysts-perspective-10-windbg-commands-might-know/
http://ntcoder.com/bab/2012/03/06/how-to-force-symbol-loading-in-windbg/
0x00000040  SYMOPT_LOAD_ANYTHING

Decompiler:
https://derevenets.com/

Driver samples:
https://github.com/microsoft/Windows-driver-samples

Storage:
https://df-stream.com/2018/05/partition-diagnostic-event-log-and-usb-device-tracking-p1/

ACPI:
https://acpica.org/sites/acpica/files/ACPI-Introduction.pdf
https://acpica.org/sites/acpica/files/asl_tutorial_v20190625.pdf
https://askbob.tech/acpi-101/

UEFI reading:
file://desmo/WDS/Devices/Paloma/SWFW/Docs/Renior/FP6/SW_docs/
https://deviceswiki.com/wiki/Learning_UEFI

UEFI debug:
OneNote: Retrieve UEFI image from Retail BB
UEFI release history : OneNote
use grasshopper dips => DN-UP-UP-UP
use SurfDbg (C:\sandbox\tools\SurfDbg_Try):
\\desmo\Release\Shared\CI_tools-surfdbg\refs\heads\master\4.95.191121-1810
UEFI debug versions use pipeline: 
https://dev.azure.com/MSFTDEVICES/UEFI-Delos/_build?definitionId=7387
UEFI Source Level Debugging (OneNote)
UEFI Firmware update: OneNote Retrieve UEFI image from Retail BB
  > py .\PlatformBuild.py BLD_*_FORCE_DEBUGGER_ENABLED=TRUE --clean
UEFI Debug messages in OS from ACPI (OneNote)
UEFI building: Delos local build (OneNote)

UEFI Tianocore 3rd party setup:
wizard: https://github.com/tianocore/tianocore.github.io/wiki/UEFI-Driver-Wizard
Download and unzip UDK2014.IHV into c:\EDK_Workspace
https://github.com/tianocore/tianocore.github.io/wiki/UDK2014.IHV-Setup-Guide
Extract BaseTools(Windows)
run edksetup.bat from VS x64 native shell
Wizard, open workspace C:\EDK_Workspace\UDK2014.IHV
Create driver inside workspace: C:\EDK_Workspace\UDK2014.IHV\Drivers

Scripting:
https://www.dumpanalysis.org/WCDA/WCDA-Sample-Chapter.pdf
https://github.com/lallousx86/Windbg-Scripts/tree/master/practical-reverse-engineering
https://chris.eldredge.io/blog/2014/03/05/windbg-dump-entries-in-array/
https://www.exploit-db.com/docs/english/18576-deep-dive-into-os-internals-with-windbg.pdf


In windbg we do this via

0:000> .symopt+ 0x40
Symbol options are 0x30377:
0x00000001  SYMOPT_CASE_INSENSITIVE
0x00000002  SYMOPT_UNDNAME
0x00000004  SYMOPT_DEFERRED_LOADS
0x00000010  SYMOPT_LOAD_LINES
0x00000020  SYMOPT_OMAP_FIND_NEAREST
0x00000040  SYMOPT_LOAD_ANYTHING < Prevents validation of .pdb file
0x00000100  SYMOPT_NO_UNQUALIFIED_LOADS
0x00000200  SYMOPT_FAIL_CRITICAL_ERRORS
0x00010000  SYMOPT_AUTO_PUBLICS
0x00020000  SYMOPT_NO_IMAGE_SEARCH

To re-enable strict mapping between .exe and .pdb use


Storage:
7: kd> !minipkd.help

SCSI Miniport Debugger Extension
help                      - displays this message
adapters                  - dumps all the HBAs
adapter <adapter>         - dumps the specified Adapter Extension
exports <adapter>         - dumps the miniport exports for the given adapter
lun <lun>                 - dumps the specified Logical Unit Extension
portconfig <portconfig>   - dumps the specified PORT_CONFIGURATION_INFORMATION
req <adapter>             - dumps active requests on specified adapter or device
srb <srb>                 - dumps the specified SCSI_REQUEST_BLOCK

7: kd> !minipkd.adapters
minipkd error (0): drivers\storage\kdext\minipkd\minipkd.c @ line 435
7: kd> !scsikd.help

IMPORTANT NOTE: Please consider using StorageKD instead of scsikd for your debugging needs for win8 and above targets

SCSIPORT Debugger Extension
          help -    displays this message
       srbdata -    dumps the specified SRB_DATA tracking block
               -    
    The following take either the device object or device extension -   
       scsiext -    dumps the specified scsiport extension
      classext -    dumps the specified classpnp extension
               -    
    Commands for partition tables -     
        layout -    dumps the drive layout at the the specified address
      layoutex -    dumps the extended drive layout at the specified address
          part -    dumps the partition at the specified address
        partex -    dumps the extended partition at the specified address

7: kd> !scsikd.classext 
Storage class devices:

* !classext ffffa7074c5a1060 [1,2] SAMSUNG MZ9LQ1T0HALB-00000 Paging Disk       

Usage: !classext <class device> <level [0-2]>

Optical devices, such as DVD drives, can be listed with !wdfkd.wdfdriverinfo cdrom, and further explored 
using the "!wdfkd.wdfdevice <device_handle>" and "!wdfkd.wdfdevicequeues <device_handle>" commands.


ACPI:
2: kd> !nstree
\___ (ffff880593f10048) - Unknown
| _SB_ (ffff880593f10258) - Device ffff8805948ea010
| | LID0 (ffff880593f36048) - Device ffff8805928a27d0
| | | _HID (ffff880593f36158) - Integer - 000000000d0cd041
| | | _STA (ffff880593f36208) - Method - Flags 0000000000000000 Start ffff880593f3637a Len 000000000000000c
| | | _LID (ffff880593f363a0) - Method - Flags 0000000000000000 Start ffff880593f36512 Len 000000000000000e

The !amli lc extension lists all active ACPI contexts.
4: kd> !amli lc
 Ctxt=ffff9707d0081010, ThID=0000000000000000, Flgs=---C-----, pbOp=ffff9707c39ed30b, Obj=\_SB._SAN.GEN1.PAT0
 Ctxt=ffff9707d125d010, ThID=0000000000000000, Flgs=---C-----, pbOp=ffff9707c39ed14d, Obj=\_SB._SAN.GEN7._TMP
 Ctxt=ffff9707d290f270, ThID=0000000000000000, Flgs=---C-----, pbOp=ffff9707c39799cf, Obj=\_SB.BAT1._BIX
 Ctxt=ffff9707d0506010, ThID=0000000000000000, Flgs=---C-----, pbOp=ffff9707c397e93c, Obj=\_SB.SRTC._STV
 Ctxt=ffff9707d08f5010, ThID=0000000000000000, Flgs=---C-----, pbOp=ffff9707c397b9a9, Obj=\_SB.TPWR._BST


2: kd> !amli find PCI0
\_SB.PCI0

2: kd> !amli find UA00
\_SB.PCI0.UA00

2: kd> !amli find _PS3
\_SB.PCI0.GFX0._PS3
\_SB.PCI0.XHC._PS3
\_SB.PCI0.XHC.RHUB._PS3
\_SB.PCI0.HDAS._PS3
\_SB.PCI0.SAT0._PS3
\_SB.PCI0.SAT0.NVM1._PS3
\_SB.PCI0.SAT0.NVM2._PS3
\_SB.PCI0.SAT0.NVM3._PS3
\_SB.PCI0.I2C0._PS3
\_SB.PCI0.I2C0.FINK._PS3
\_SB.PCI0.I2C2._PS3
\_SB.PCI0.I2C3._PS3
\_SB.PCI0.I2C4._PS3
\_SB.PCI0.UA00._PS3
\_SB.PCI0.UA01._PS3
\_SB.PCI0.UA02._PS3
\_SB.PCI0.PEMC._PS3
\_SB.PCI0.PSDC._PS3
\_SB.PCI0.CNVW._PS3
\_SB.PCI0.TXHC._PS3
\_SB.PCI0.TXHC.RHUB._PS3
\_SB.PCI0.TDM0._PS3
\_SB.PCI0.TDM1._PS3
\_SB.PCI0.TRP0._PS3
\_SB.PCI0.TRP1._PS3
\_SB.PCI0.TRP2._PS3
\_SB.PCI0.TRP3._PS3


2: kd> !amli dns /s \_sb.ssh._dsm
ACPI Name Space: \_SB.SSH._DSM (ffff818892f39720)
Method(_DSM:Flags=0x4,CodeBuff=ffff818892f39892,Len=478)

1: kd> !amli dns /s \_sb.lid0
ACPI Name Space: \_SB.LID0 (ffff880593f36048)
Device(LID0)
| Integer(_HID:Value=0x000000000d0cd041[218943553])
| Method(_STA:Flags=0x0,CodeBuff=ffff880593f3637a,Len=17)
| Method(_LID:Flags=0x0,CodeBuff=ffff880593f36512,Len=19)

1: kd> !amli dns /s \_sb.lid0._lid
ACPI Name Space: \_SB.LID0._LID (ffff880593f363a0)
Method(_LID:Flags=0x0,CodeBuff=ffff880593f36512,Len=19)

1: kd> !nsobj ffff880593f363a0
nsobj:  dumping object at ffff880593f363a0
NameSpace Object \ (ffff880593f363a0) - Device 0000000000000000
  Flink 0000000000000000Blink  000000b68557d0e0
  Parent 0000000000000000  Child 0000000000000000
  Value 0000000000000000  Length 0000000000000000
  Buffer 0000000000000000  Flags 0000000000000000
    Object Data - ffff880593f363e0 Type - 08 <Method> Flags=0000000000000000 Start=ffff880593f36512 Len=000000000000000e
    
Dump acpi method
1: kd> !amli u ffff880593f36512
ffff880593f36512:[\_SB.LID0._LID]
ffff880593f36512 : Store(M009(0x16), Local0)
ffff880593f3651a : If(LEqual(Local0, Zero))
ffff880593f3651f : {
ffff880593f3651f : | Return(One)
ffff880593f36521 : }
ffff880593f36521 : Else
ffff880593f36523 : {
ffff880593f36523 : | Return(Zero)
ffff880593f36525 : }

ACPI live spew:
To set ACPI logging on from Windbg:
4: kd> !amli set spewon
kd> !amli set spewon traceon verboseon
kd> !amli set spewoff traceoff verboseoff

Check settings:
4: kd> !amli set
AMLTrace        =off
AMLDebugSpew    =on
DebuggerBreak   =off
LoadDDBBreak    =off
ErrorBreak      =off
VerboseMode     =off
LogEvent        =on
LogSize         =204

More info on this is at:
https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/-amli-set


SSH:
#define SSH_PORT "\\_SB.PCI0.UA00" // SurfaceSerialHub.asl
| | SSH_ (ffff8e87b297d208) - Device ffff8e87b1a4f010
| | | _HID (ffff8e87b297d2b8) - String - MSHW0084
| | | SULS (ffff8e87b297d368) - Integer - 0000000000000000
| | | _S0W (ffff8e87b297d418) - Integer - 0000000000000003
| | | _STA (ffff8e87b297d4c8) - Method - Flags 0000000000000000 Start ffff8e87b297d63a Len 000000000000000d
| | | _DEP (ffff8e87b297d6d8) - Package - NumElements 1
| | | SBUF (ffff8e87b297d808) - Buffer - b297d788 L=006d
| | | BAUD (ffff8e87b297d940) - Buffer Field Ptr=b297d788 Len=6d Offset=c Start=0NumBits=20 Flgas=3
| | | _INI (ffff8e87b297d9f0) - Method - Flags 0000000000000000 Start ffff8e87b297db62 Len 000000000000006f
| | | _CRS (ffff8e87b297dbe8) - Method - Flags 0000000000000000 Start ffff8e87b297dd5a Len 0000000000000000
| | | _DSM (ffff8e87b297dd70) - Method - Flags 0000000000000004 Start ffff8e87b297dee2 Len 000000000000018d

2: kd> !nsobj ffff8e87b297d208
nsobj:  dumping object at ffff8e87b297d208
NameSpace Object \_SB.SSH (ffff8e87b297d208) - Device ffff8e87b1a4f010
  Flink ffff8e87b297e088
Blink  ffff8e87b2979708
  Parent ffff8e87b0f10258  Child ffff8e87b297d2b8
  Value 0000000000000000  Length 0000000000000000
  Buffer 0000000000000000  Flags 0000000000000000
    Object Data - ffff8e87b297d248 Type - 06 <Device>

2: kd> !acpikd.acpiext ffff8e87b1a4f010
ACPI!DEVICE_EXTENSION ffff8e87b1a4f010 - ACPI\MSHW0084
  DevObject  ffff8e87af4b0cd0  PhysObject  ffff8e87af4b0cd0  NextObject   0000000000000000
  AcpiObject SSH_ ffff8e87b297d208 [\_SB.SSH]  ParentExt   ffff8e87af47e0d0
  PnpState   ActRunng  OldPnpState Started 
  Dispatch   fffff802373dd0f0
  RefCounts  3-Device 2-Irp 0-Hiber 1-Wake
  State      D3        Sw->S0 Dw->D3     Wake Pin        0
  SxD Table  S0->D0 S4->D3 S5->D3 
  Flags      0560200000010a20
    Types    PDO Enumerated ValidPnP 
    Caps     CanWake 
    Props    HasHID RanINI Enabled AcpiPower D3ColdNotEnabled DEP BusDriverSupportsD3Cold DEP_checked LckEnabled DisEnabled PostDisplayD0Succeeded CapSidebandWake CapGpioInterrupt CCA_checked PEP_checked 

0: kd> dt acpi!_device_extension  ffff8e87b1a4f010


Shows dependency of SSH on UA00
2: kd> !nsobj ffff8e87b297d6d8
nsobj:  dumping object at ffff8e87b297d6d8
NameSpace Object \_SB.SSH._DEP (ffff8e87b297d6d8) - Device 0000000000000000
  Flink ffff8e87b297d808
Blink  ffff8e87b297d4c8
  Parent ffff8e87b297d208  Child 0000000000000000
  Value 0000000000000000  Length 0000000000000030
  Buffer ffff8e87b297d698  Flags 0000000000000000
    Object Data - ffff8e87b297d718 Type - 04 <Package> NumElements=0000000000000001
      Object Data - ffff8e87b297d6a0 Type - 02 <String> String=^PCI0.UA00

0: kd> !devstack ffff8904d9409a00
  !DevObj           !DrvObj            !DevExt           ObjectName
> ffff8904d9409a00  \Driver\SurfaceSerialHubDriverffff8904d96132f0  00000065
  ffff8904d37df3c0  \Driver\ACPI       ffff8904d34977f0  00000024
!DevNode ffff8904d63198a0 :
  DeviceInst is "ACPI\MSHW0084\2&daba3ff&0"
  ServiceName is "SurfaceSerialHubDriver"

0: kd> !acpikd.acpiext ffff8904d34977f0
ACPI!DEVICE_EXTENSION ffff8904d34977f0 - ACPI\MSHW0084
  DevObject  ffff8904d37df3c0  PhysObject  ffff8904d37df3c0  NextObject   0000000000000000
  AcpiObject SSH_ ffff8904d4f27248 [\_SB.SSH]  ParentExt   ffff8904d34d60d0
  PnpState   ActRunng  OldPnpState Started 
  Dispatch   fffff8016207d0f0
  RefCounts  3-Device 1-Irp 0-Hiber 0-Wake
  State      D0        Sw->S0 Dw->D3     Wake Pin        0
  SxD Table  S0->D0 S4->D3 S5->D3 
  Flags      0560200000010a20
    Types    PDO Enumerated ValidPnP 
    Caps     CanWake 
    Props    HasHID RanINI Enabled AcpiPower D3ColdNotEnabled DEP BusDriverSupportsD3Cold DEP_checked LckEnabled PostDisplayD0Succeeded CapSidebandWake CapGpioInterrupt CCA_checked PEP_checked 

Example full round trip:
1: kd> !wdfkd.wdflogdump WudfRd -d
494: RdPnpTracker::RdPnp - RdPnpTracker::RdPnp: RdFdoDevice 0xFFFF880597FDE9F0 !devobj 0xFFFF88059D516DD0 IRP_MJ_POWER 0x00000002(IRP_MN_SET_POWER) IRP 0xFFFF8805A09B3760 received
495: RdPnpTracker::RdPnpProcessor - Forwarding IRP 0xFFFF8805A09B3760 to host on its way down
499: RdPnpTracker::RdForwardRequestToHostReply - Power IRP 0xFFFF8805A09B3760 0x00000002(IRP_MN_SET_POWER) reply (0x00000000(false)) received from host. RdPnPTracker 0xFFFF88059DB97DE0 HasProblem 0x00000000(false)
500: RdPnpTracker::RdPnpProcessor - Forwarding IRP 0xFFFF8805A09B3760 to host on completion


cache*;SRV*https://msdl.microsoft.com/download/symbols

!object \
!object \Global??\
!object \Global??\PhysicalDrive0

6: kd> !object \Global??\PhysicalDrive0
Object: ffff808c5a148460  Type: (ffffa708ea48c4e0) SymbolicLink
    ObjectHeader: ffff808c5a148430 (new version)
    HandleCount: 0  PointerCount: 1
    Directory Object: ffff808c58c079c0  Name: PhysicalDrive0
    Flags: 00000000 ( Local )
    Target String is '\Device\Harddisk0\DR0'

6: kd> !object \Device\Harddisk0\DR0
Object: ffffa708ef066060  Type: (ffffa708ea4e2220) Device
    ObjectHeader: ffffa708ef066030 (new version)
    HandleCount: 0  PointerCount: 3
    Directory Object: ffff808c58cd8220  Name: DR0

6: kd> !devobj ffffa708ef066060
Device object (ffffa708ef066060) is for:
 DR0 \Driver\disk DriverObject ffffa708ecec2b00
Current Irp 00000000 RefCount 5 Type 00000007 Flags 01000050
Vpb ffffa708ef091cd0 SecurityDescriptor ffff808c58dc77e0 DevExt ffffa708ef0661b0 DevObjExt ffffa708ef066a60 Dope ffffa708ef091bf0 
ExtensionFlags (0x00000800)  DOE_DEFAULT_SD_PRESENT
Characteristics (0x00000100)  FILE_DEVICE_SECURE_OPEN
AttachedDevice (Upper) ffffa708ecece8d0 \Driver\partmgr
AttachedTo (Lower) ffffa708ecec4de0 \Driver\EhStorClass
Device queue is not busy.

6: kd> !devstack ffffa708ef066060
  !DevObj           !DrvObj            !DevExt           ObjectName
  ffffa708ecece8d0  \Driver\partmgr    ffffa708ececea20  
> ffffa708ef066060  \Driver\disk       ffffa708ef0661b0  DR0
  ffffa708ecec4de0  \Driver\EhStorClassffffa708ecec4ba0  
  ffffa708ec9a9060  \Driver\stornvme   ffffa708ec9a91b0  00000037
!DevNode ffffa708ec9aa8d0 :
  DeviceInst is "SCSI\Disk&Ven_NVMe&Prod_HFM256GDGTNG-87A\000000"
  ServiceName is "disk"

6: kd> !vpb ffffa708ef091cd0
Vpb at 0xffffa708ef091cd0
Flags: 0x30 
DeviceObject: 0x0000000000000000
RealDevice:   0xffffa708ef066060
RefCount: 0
Volume Label: 


6: kd> !devnode ffffa708ec9aa8d0
DevNode 0xffffa708ec9aa8d0 for PDO 0xffffa708ec9a9060
  Parent 0xffffa708ec933cd0   Sibling 0000000000   Child 0000000000   
  InstancePath is "SCSI\Disk&Ven_NVMe&Prod_HFM256GDGTNG-87A\000000"
  ServiceName is "disk"
  TargetDeviceNotify List - f 0xffff808c5c486db0  b 0xffff808c5c486db0
  State = DeviceNodeStarted (0x308)
  Previous State = DeviceNodeEnumerateCompletion (0x30d)
  StateHistory[01] = DeviceNodeEnumerateCompletion (0x30d)
  StateHistory[00] = DeviceNodeEnumeratePending (0x30c)
  StateHistory[19] = DeviceNodeStarted (0x308)
  StateHistory[18] = DeviceNodeEnumerateCompletion (0x30d)
  StateHistory[17] = DeviceNodeEnumeratePending (0x30c)
  StateHistory[16] = DeviceNodeStarted (0x308)
  StateHistory[15] = DeviceNodeEnumerateCompletion (0x30d)
  StateHistory[14] = DeviceNodeEnumeratePending (0x30c)
  StateHistory[13] = DeviceNodeStarted (0x308)
  StateHistory[12] = DeviceNodeEnumerateCompletion (0x30d)
  StateHistory[11] = DeviceNodeEnumeratePending (0x30c)
  StateHistory[10] = DeviceNodeStarted (0x308)
  StateHistory[09] = DeviceNodeEnumerateCompletion (0x30d)
  StateHistory[08] = DeviceNodeEnumeratePending (0x30c)
  StateHistory[07] = DeviceNodeStarted (0x308)
  StateHistory[06] = DeviceNodeStartPostWork (0x307)
  StateHistory[05] = DeviceNodeStartCompletion (0x306)
  StateHistory[04] = DeviceNodeStartPending (0x305)
  StateHistory[03] = DeviceNodeResourcesAssigned (0x304)
  StateHistory[02] = DeviceNodeDriversAdded (0x303)
  Flags (0x24000130)  DNF_ENUMERATED, DNF_IDS_QUERIED, 
                      DNF_NO_RESOURCE_REQUIRED, DNF_NO_LOWER_DEVICE_FILTERS, 
                      DNF_NO_UPPER_DEVICE_FILTERS
  UserFlags (0x00000008)  DNUF_NOT_DISABLEABLE
  CapabilityFlags (0x004001c1)  DeviceD1, UniqueID, 
                                SilentInstall, RawDeviceOK
                                Unknown flags 0x00400000
  DisableableDepends = 1 (including self)


6: kd> !object \Global??\Volume{e2faca35-8b0f-41fd-9743-4fa665234538}
Object: ffff808c5a14d380  Type: (ffffa708ea48c4e0) SymbolicLink
    ObjectHeader: ffff808c5a14d350 (new version)
    HandleCount: 0  PointerCount: 1
    Directory Object: ffff808c58c079c0  Name: Volume{e2faca35-8b0f-41fd-9743-4fa665234538}
    Flags: 00000000 ( Local )
    Target String is '\Device\HarddiskVolume3'

6: kd> !object \Device\HarddiskVolume3
Object: ffffa708ecf7c930  Type: (ffffa708ea4e2220) Device
    ObjectHeader: ffffa708ecf7c900 (new version)
    HandleCount: 0  PointerCount: 11
    Directory Object: ffff808c58c04a20  Name: HarddiskVolume3

6: kd> !devstack ffffa708ecf7c930
  !DevObj           !DrvObj            !DevExt           ObjectName
  ffffa708ef179040  \Driver\volsnap    ffffa708ef179190  
  ffffa708ecec18d0  \Driver\volume     ffffa708ecec1a20  
  ffffa708eceee8d0  \Driver\rdyboost   ffffa708eceeea20  
  ffffa708eceed8d0  \Driver\iorate     ffffa708eceeda20  
  ffffa708ef177030  \Driver\fvevol     ffffa708ef177180  
> ffffa708ecf7c930  \Driver\volmgr     ffffa708ecf7ca80  HarddiskVolume3
!DevNode ffffa708ecee3c90 :
  DeviceInst is "STORAGE\Volume\{bb1d3e22-3c95-11ea-ad85-806e6f6e6963}#0000000018500000"
  ServiceName is "volume"

6: kd> !drvobj \Driver\volmgr 
Driver object (ffffa708ec995e30) is for:
 \Driver\volmgr

Driver Extension List: (id , addr)

Device Object list:
ffffa708ecee38f0  ffffa708ecf7c930  ffffa708eceb3b40  ffffa708ecee2b90
ffffa708ec921900  

6: kd> !object \Driver\mountmgr
Object: ffffa708ec939d20  Type: (ffffa708ea4e24e0) Driver
    ObjectHeader: ffffa708ec939cf0 (new version)
    HandleCount: 0  PointerCount: 7
    Directory Object: ffff808c58cd7420  Name: mountmgr


6: kd> !drvobj ffffa708ec939d20
Driver object (ffffa708ec939d20) is for:
 \Driver\mountmgr

Driver Extension List: (id , addr)

Device Object list:
ffffa708ec9a2ca0  

6: kd> !devobj ffffa708ec9a2ca0
Device object (ffffa708ec9a2ca0) is for:
 MountPointManager \Driver\mountmgr DriverObject ffffa708ec939d20
Current Irp 00000000 RefCount 0 Type 00000012 Flags 00000840
SecurityDescriptor ffff808c58df8b20 DevExt ffffa708ec9a2df0 DevObjExt ffffa708ec9a2f68 
ExtensionFlags (0x00000800)  DOE_DEFAULT_SD_PRESENT
Characteristics (0x00000100)  FILE_DEVICE_SECURE_OPEN
Device queue is not busy.


4: kd> !drvobj amduart 7
Driver object (ffffb9860d65ae00) is for:
 \Driver\amduart

Driver Extension List: (id , addr)
(fffff80028787310 ffffb9860d4f5860)  
Device Object list:
ffffb98609be42e0  

DriverEntry:   fffff8002ed5fb00 amduart
DriverStartIo: 00000000 
DriverUnload:  fffff8002ed5fc70 amduart
AddDevice:     fffff800287870c0 Wdf01000!FxDriver::AddDevice

Dispatch routines:
[00] IRP_MJ_CREATE                      fffff8002873ab70    Wdf01000!FxDevice::DispatchWithLock
[01] IRP_MJ_CREATE_NAMED_PIPE           fffff8002873ab70    Wdf01000!FxDevice::DispatchWithLock
[02] IRP_MJ_CLOSE                       fffff8002873ab70    Wdf01000!FxDevice::DispatchWithLock
[03] IRP_MJ_READ                        fffff8002873ab70    Wdf01000!FxDevice::DispatchWithLock
[04] IRP_MJ_WRITE                       fffff8002873ab70    Wdf01000!FxDevice::DispatchWithLock
[05] IRP_MJ_QUERY_INFORMATION           fffff8002873ab70    Wdf01000!FxDevice::DispatchWithLock
[06] IRP_MJ_SET_INFORMATION             fffff8002873ab70    Wdf01000!FxDevice::DispatchWithLock
[07] IRP_MJ_QUERY_EA                    fffff8002873ab70    Wdf01000!FxDevice::DispatchWithLock
[08] IRP_MJ_SET_EA                      fffff8002873ab70    Wdf01000!FxDevice::DispatchWithLock
[09] IRP_MJ_FLUSH_BUFFERS               fffff8002873ab70    Wdf01000!FxDevice::DispatchWithLock
[0a] IRP_MJ_QUERY_VOLUME_INFORMATION    fffff8002873ab70    Wdf01000!FxDevice::DispatchWithLock
[0b] IRP_MJ_SET_VOLUME_INFORMATION      fffff8002873ab70    Wdf01000!FxDevice::DispatchWithLock
[0c] IRP_MJ_DIRECTORY_CONTROL           fffff8002873ab70    Wdf01000!FxDevice::DispatchWithLock
[0d] IRP_MJ_FILE_SYSTEM_CONTROL         fffff8002873ab70    Wdf01000!FxDevice::DispatchWithLock
[0e] IRP_MJ_DEVICE_CONTROL              fffff8002873ab70    Wdf01000!FxDevice::DispatchWithLock
[0f] IRP_MJ_INTERNAL_DEVICE_CONTROL     fffff8002873ab70    Wdf01000!FxDevice::DispatchWithLock
[10] IRP_MJ_SHUTDOWN                    fffff8002873ab70    Wdf01000!FxDevice::DispatchWithLock
[11] IRP_MJ_LOCK_CONTROL                fffff8002873ab70    Wdf01000!FxDevice::DispatchWithLock
[12] IRP_MJ_CLEANUP                     fffff8002873ab70    Wdf01000!FxDevice::DispatchWithLock
[13] IRP_MJ_CREATE_MAILSLOT             fffff8002873ab70    Wdf01000!FxDevice::DispatchWithLock
[14] IRP_MJ_QUERY_SECURITY              fffff8002873ab70    Wdf01000!FxDevice::DispatchWithLock
[15] IRP_MJ_SET_SECURITY                fffff8002873ab70    Wdf01000!FxDevice::DispatchWithLock
[16] IRP_MJ_POWER                       fffff8002873ab70    Wdf01000!FxDevice::DispatchWithLock
[17] IRP_MJ_SYSTEM_CONTROL              fffff8002873ab70    Wdf01000!FxDevice::DispatchWithLock
[18] IRP_MJ_DEVICE_CHANGE               fffff8002873ab70    Wdf01000!FxDevice::DispatchWithLock
[19] IRP_MJ_QUERY_QUOTA                 fffff8002873ab70    Wdf01000!FxDevice::DispatchWithLock
[1a] IRP_MJ_SET_QUOTA                   fffff8002873ab70    Wdf01000!FxDevice::DispatchWithLock
[1b] IRP_MJ_PNP                         fffff8002873ab70    Wdf01000!FxDevice::DispatchWithLock


Device Object stacks:

!devstack ffffb98609be42e0 :
  !DevObj           !DrvObj            !DevExt           ObjectName
> ffffb98609be42e0  \Driver\amduart    ffffb9860d616310  00000044
  ffffb9860966c060  \Driver\ACPI       ffffb9860bae7010  00000019
!DevNode ffffb9860bb278a0 :
  DeviceInst is "ACPI\AMDI0020\0"
  ServiceName is "amduart"

Processed 1 device objects.


UMDF Irps:
=========
Here is how I get the new IRP in this dump. From UMDF point of view, it calls DeviceIoControl to the remote target device with a file handle, and UMDF really does not know nor record the new IRP that is created for this win32 i/o. You can search around but in general wdfkd won't be able to help.

6: kd> !wdfiotarget 0xfffffe5530e11bf8 
Requests sent: 1
    WDFREQUEST fffffe5530ea7078 !wdfumirp 0x000001aad18945b0
Target name:  \\?\HID#MSHW0124&Col02#4&1d271488&1&0001#{4d1e55b2-f16f-11cf-88cb-001111000030}
WDF file !handle  0x0000000000000418. Search for 'Object: xxxx Type: File', run '!fileobj xxxx'

6: kd> !handle  0x0000000000000418
Object: ffffc302212d62a0  Type: (ffffc3020d505400) File

6: kd> !fileobj ffffc302212d62a0
Device Object: 0xffffc30219e12060   \Driver\mshidkmdf
IRPs queued to File Object:
    ffffc302245f6a20   \Driver\mshidkmdf


1: kd> !process 0 0x1f wudfhost.exe
PROCESS ffff880597dbf480
PROCESS ffff88059cda50c0
PROCESS ffff88059d7ae0c0

1: kd> .process ffff880597dbf480
1: kd> .reload
1: kd> !wdfkd.wdfumirps
Number of pending IRPS: 0x5
####  CWudfIrp          Current Type                                        UniqueId          KernelIrp         Device Stack
----  ----------------  --------------------------------------------------  ----------------  ----------------  ----------------
0000  0x148143d4ec0     WdfRequestRead                                      0                 0x00000000        0x148143aac80    
0001  0x148143d5360     WdfRequestRead                                      0                 0x00000000        0x148143aac80    
0002  0x148143d5940     WdfRequestRead                                      0                 0x00000000        0x148143aac80    
0003  0x148143df000     WdfRequestUndefined                                 0                 0x00000000        0x148143d5bc0    
0004  0x148143e0790     WdfRequestRead                                      0                 0x00000000        0x148143d5bc0    

1: kd> .process ffff88059cda50c0
1: kd> !wdfkd.wdfumirps
Number of pending IRPS: 0x0

1: kd> .process ffff88059d7ae0c0
1: kd> !wdfkd.wdfumirps
Number of pending IRPS: 0x2
####  CWudfIrp          Current Type                                        UniqueId          KernelIrp         Device Stack
----  ----------------  --------------------------------------------------  ----------------  ----------------  ----------------
0000  0x216bc1d2c50     Power (SET_POWER)                                   0                 0xffff880597b17010  0x216bc12c1e0    
0001  0x216bea32ee0     WdfRequestDeviceIoControl                           



DLL Dump:
0:013> !dh gdi32 -f


HID Debug
!hidkd.help
!hidtree ffffc30219e12060
!hidpdo ffffc30219e11060

Dump Lists:
!list "-t nt!_LIST_ENTRY.Flink -e -x \"dt nt!_IRP\" 0xffffac8a8fec58f0"
!list "-t nt!_LIST_ENTRY.Flink -e -x \"dt nt!_ETHREAD\" 0xffff98851c21bba8"
!list "-t nt!_LIST_ENTRY.Flink -e -x \"!thread\" 0xffff98851c21bba8"
!list "-t nt!_LIST_ENTRY.Flink -e -x \"!thread\" 0xffff98851c21bba8"
!list "-t nt!_LIST_ENTRY.Flink 0xffff98851c21bba8"

WinDe.help
!winde.activity

Cpu activity:
7: kd> !prcb 0
PRCB for Processor 0 at fffff80332863180:
Current IRQL -- 0
Threads--  Current fffff8033418f400 Next ffff9207da314080 Idle fffff8033418f400
Processor Index 0 Number (0, 0) GroupSetMember 1
Interrupt Count -- 0098b63a
Times -- Dpc    0000041f Interrupt 000006da 
         Kernel 0009784f User      00004e86 

GFLAGS:
======
trick on clearing gflags (in case it prevents you from booting) in windbg - 
view flags !gflag => dd NtGlobalFlag, you can zero 
it ed NtGlobalFlag 0 and go and you're back in business.

Memory:
======
get details of virtual address
!vm <address>

DPCs:
====
!dpcs <cpu number>
6: kd> !dpcs 4
CPU Type      KDPC       Function
dpcs: no pending DPCs found

6: kd> !logdump 0x2 -- Circular Kernel Context Logger history
6: kd> !intstats /d -- DPC and ISR stats (total since boot)
6: kd> !intstats /w -- DPC and ISR stats (during DPC watchdog period)
2: kd> !dpcwatchdog -- very cool summary per CPU
2: kd> !watchdoganalyze -v 0n0
[Stack 38] Elapsed time since previous stack: 515 mSec; since reference stack: 593 mSec
   Exiting function: fffff806766415da  nt!MiDemoteSlabEntriesDpc+0x20A 
 # RetAddr           Call Site
06 fffff806766415e3  nt!KeYieldProcessorEx+0x20 
07 fffff806762be11a  nt!MiDemoteSlabEntriesDpc+0x213 

.load wmitrace.dll;!wmitrace.logdump 0x2
Found Buffers: 8 Messages: 626, sorting entries
[2]FFFFFFFF.FFFFFFFF::03/05/2023-23:35:29.593 [PerfInfoEvent]DPC      Initial Time=7182779735385. Routine=0xFFFFF8047A2EE240 Routine Name: storport!RaidpAdapterDpcRoutine
[2]FFFFFFFF.FFFFFFFF::03/05/2023-23:35:29.593 [PerfInfoEvent]DPC      Initial Time=7182779829781. Routine=0xFFFFF8047A2EE240 Routine Name: storport!RaidpAdapterDpcRoutine


List processes:
kd> !dml_proc

!list "-e -x \"dt nt!_EPROCESS @$extret-@@(#FIELD_OFFSET(nt!_EPROCESS, TimerResolutionLink)) ImageFileName SmallestTimerResolution RequestedTimerResolution\" nt!ExpTimerResolutionListHead"

DevCon:
https://docs.microsoft.com/en-us/windows-hardware/drivers/devtest/devcon
======
List devices hwid: devcon hwids *

Digging out UMDF Irps in Flight
===============================
1: kd> !process 0 0x1f wudfhost.exe
PROCESS ffff880597dbf480
PROCESS ffff88059cda50c0
PROCESS ffff88059d7ae0c0

1: kd> .process ffff880597dbf480
1: kd> .reload
1: kd> !wdfkd.wdfumirps
Number of pending IRPS: 0x5
####  CWudfIrp          Current Type                                        UniqueId          KernelIrp         Device Stack
----  ----------------  --------------------------------------------------  ----------------  ----------------  ----------------
0000  0x148143d4ec0     WdfRequestRead                                      0                 0x00000000        0x148143aac80    
0001  0x148143d5360     WdfRequestRead                                      0                 0x00000000        0x148143aac80    
0002  0x148143d5940     WdfRequestRead                                      0                 0x00000000        0x148143aac80    
0003  0x148143df000     WdfRequestUndefined                                 0                 0x00000000        0x148143d5bc0    
0004  0x148143e0790     WdfRequestRead                                      0                 0x00000000        0x148143d5bc0    

1: kd> .process ffff88059cda50c0
1: kd> !wdfkd.wdfumirps
Number of pending IRPS: 0x0

1: kd> .process ffff88059d7ae0c0
1: kd> !wdfkd.wdfumirps
Number of pending IRPS: 0x2
####  CWudfIrp          Current Type                                        UniqueId          KernelIrp         Device Stack
----  ----------------  --------------------------------------------------  ----------------  ----------------  ----------------
0000  0x216bc1d2c50     Power (SET_POWER)                                   0                 0xffff880597b17010  0x216bc12c1e0    
0001  0x216bea32ee0     WdfRequestDeviceIoControl                           0                 0x00000000        0x216bc12c1e0     



Viewing Devmgmt devices:
>Many times I want to find something in device manager however it does not have a search button. I have used powershells gwmi often, but the Out-GridView takes it to the next level!
>Run the following in a powershell window: 

PS:> gwmi win32_pnpentity | Out-GridView

Heinlein article:
https://www.tor.com/2012/10/28/something-else-like-heinlein/

============================================================================================================
Power policy problems - BEGIN:
============================================================================================================
kd> !popolicy
C:\> powercfg -qh

OneNote: Driver Dev - Building Provisioning Packages (PPKG Files)

icd.exe path:
"C:\Program Files (x86)\Windows Kits\10\Assessment and Deployment Kit\Imaging and Configuration Designer\x86\"

To update a build a provisioning package
    1) Edit the XML file for the package.
        a. Don't forget to bump the version number in the package.
    2) Build the ppkg file. For Example:
        a. " icd.exe /Build-ProvisioningPackage /CustomizationXML:Surface.Power.Policy.Defaults.xml /PackagePath:Surface.Power.Policy.Defaults.ppkg +Overwrite "
    3) Build and test the driver.
    4) Commit and push both the XML file and the compiled PPKG package.

Verifying the Provisioning Package

You can verify your PPKG file by opening it and looking in it. Provisioning packages are special WIM files, and can be mounted with DISM using an ADMIN command prompt.  

mkdir c:\temp

dism /get-wiminfo /wimfile:Surface.Power.Policy.Defaults.ppkg

    Deployment Image Servicing and Management tool
    Version: 10.0.18362.1
    
    Details for image : Surface.Power.Policy.Defaults.ppkg
    
    Index : 1
    Name : Surface.Power.Policy.Defaults
    Description :
    Size : 173,283 bytes
    
    The operation completed successfully.

This indicates the index for this package is 1, which you will need for the next step.

dism /mount-wim /wimfile:Surface.Power.Policy.Defaults.ppkg /index:1 /mountdir:c:\temp /readonly

You can now browse through the package, which will be mounted on C:\temp. When you are done, you must unmount the WIM:

dism /unmount-image /mountdir:c:\temp /discard

============================================================================================================
Power policy problems - END
============================================================================================================

============================================================================================================
NDIS
============================================================================================================

7: kd> !ndiskd.help

NDIS KD EXTENSIONS

    help               This help and lots more
    netadapter         Show network adapters  (this is a good starting place)
    protocol           Show protocol drivers
    mopen              Show open bindings between netadapter and protocol
    filter             Show light-weight filters
    nbl                Show information about an NET_BUFFER_LIST
    oid                Show pending OID Requests
    ndis               Show NDIS.sys build info
    netreport          Draw a box diagram of your network stack
    netqueue           Show information about a NetAdapterCx datapath queue
    nrc                Show information about an NET_RING_COLLECTION

    Show more extensions
    View examples & tutorials online
7: kd> !ndiskd.oid
ALL PENDING OIDs
    NetAdapter         ffffa9819619d1a0 - Qualcomm Atheros QCA61x4A Wireless Network Adapter
        Low-level OID      OID_WDI_SET_POWER_STATE
        Current OID        OID_PNP_SET_POWER
    Filter             ffffa9818aef0c70 - Qualcomm Atheros QCA61x4A Wireless Network Adapter-WFP Native MAC Layer LightWeight Filter-0000
        Current OID        OID_PNP_SET_POWER
    Filter             ffffa9819a132c70 - Qualcomm Atheros QCA61x4A Wireless Network Adapter-Virtual WiFi Filter Driver-0000
        Current OID        OID_PNP_SET_POWER
    Filter             ffffa9818489ac70 - Qualcomm Atheros QCA61x4A Wireless Network Adapter-Native WiFi Filter Driver-0000
        Current OID        OID_PNP_SET_POWER
    Filter             ffffa9818ad59640 - Qualcomm Atheros QCA61x4A Wireless Network Adapter-QoS Packet Scheduler-0000
        Current OID        OID_PNP_SET_POWER
        Queued OIDs        OID_GEN_NETWORK_LAYER_ADDRESSES
                           OID_GEN_NETWORK_LAYER_ADDRESSES
                           OID_802_3_MULTICAST_LIST

Header files:
    dot11wdi.h
    ntddndis.h
    bcrypt.h
    bdamedia.h
    ifdef.h
    iscsierr.h
    netevent.h
    ntstatus.h
    suppress.h
    windot11.h
    winerror.h

    
kd> !mex.help
7: kd> !mex.help -all
Command                                               Description                                                                                                                                                                                                                                                   Category     Owner
===================================================== ============================================================================================================================================================================================================================================================= ============ ========
ab                                                    Debug Stop 0xAB (session pool leak)                                             
addr                                                  Display information about an address                                           
afd                                                   Afd Command Help                                                              
aspnetperfcounters                    (!AspxCounters) Get the ASP.Net performance counters                                         
aspxpagesext                                          Like !aspxpages, but more powerful                                          
autod                                                 Enable or disable AutoDiscover tracing output for Outlook                  
axaot                                          (!axa) Gets version information about AOT objects from SD                        
axcfg                                          (!axg) Displays configuration information about the connected process           
axdump                                       (!axdmp) Show information about dump file                                        
axinfo                                         (!axo) Show info about bug                                                    
axptr                                          (!axp) Generate file.ptr file for AX Symbols                                 
axsrc                                          (!axs) Automatically downloads Source Files for current frame from SD       
backtrace                                       (!bt) Displays the stack backtrace for the specified index into ntdll!Rtlp
base64                                         (!b64) Displays or saves base64 data                                      
baseitem                                              Dumps an object which inherits from outlook!BaseItem              
beep                                                  Beeps                                                            
bin                                                   Displays binary information located at the given address        
bing                                                  Bings for something                                            
bits2                                           (!b2) Executes a command with all possible values of a single bit flip  
bl                                                    Replaces the built in breakpoint list (bl) command with DML'd version 
bp                                                    Replaces the built in breakpoint (bp) command with a DML'd version   
btree                                                 Btree Extension                                                      
bugcheck                                         (!b) Queries Bugcheck                                                     
cache                                            (!c) Cache the output of a command to replay later                        
cattrarray                                    (!_maa) Dump mshtml!CAttrArray object from address                           
cdocs                                      (!_mcdocs) List mshtml!CDoc objects                                             
celement                                      (!_mce) Dump mshtml!CElement object from address                             
chkall                                                Shortcut for !chkimg against all modules                             
cinethttp                                     (!_uci) Dump urlmon!CInetHttp object from address                            
classtype                                       (!ct) Tries to determine the C++ class type of a pointer                   
clipboard                                             Dump clipboard contents                                              
clipboard2                                            Gets/Sets text on the clipboard, or enable/disable clipboard access  
clrperfcounters                            (!clrperf) Get the CLR performance counters                                     
clrstack2                                (!clrstack2) Prints the stack trace of a managed thread                           
clusdisk                                              Shows all the disk cluster is aware of for W2k3 - W28R2              
cluster                                               Cluster related commands                                             
codescope                                             Prints all available code analysis checklists                        
colescript                                 (!_jscole) Dump jscript!COleScript object from address                          
colkconnectionhttp                           (!ohttp) Dumps a COlkConnectionHTTP object                                    
colkconnectionrpc                             (!orpc) Dumps a COlkConnectionRPC object                                     
commandline                                     (!cl) Prints out the command line of a process                             
comment                                               Displays the comments for the dump                                   
computername                                    (!cn) Computer Name Command Help                                           
conhost                                        (!con) Displays console host (conhost.exe) info                             
context                                          (!w) Prints out the current implicit process and thread context (e.g. where am I) 
cordll                                      (!cordll) Displays available CLR versions                                             
count                                                 Counts the number of lines returned by a command                           
criticalsection                                 (!cs) CS - Displays details for a critical section                               
croppipeline                                          Dumps a CROPPipeline                                                       
croprequest                                           Dumps a CROPRequest                                                        
croptask                                              Dumps a CROPTask                                                           
crypt32                                               Dumps crypt32.dll info                                                     
cscriptbody                                           Dumps information about a vbscript!CScriptBody object                      
cut                                                   Filters output, removing unwanted areas                                    
cxmlhttprequest                           (!_mxmlreq) Dump mshtml!CXMLHttpRequest object from address                           
da                                                    Displays an ANSI string                                                   
dae                              (!DumpAllExceptions) Replacement for !dae                                                      
dce                                                   Dump NTUSER DCE Objects                                                   
ddt                                                   Wrapper for dt that adds some DML                                         
deadlocks                                      (!dls) This command looks for deadlocked threads. It will also take advantage of 
decodeoplockstate                             (!dols) Decode an OpLockState to human readable values                            
decompilemember                                       Decompile and print psuedo-C# source code for the given [MemberName]      
decompiletype                                         Decompile and print psuedo-C# source code for the given [TypeName]        
deferredqueue                                   (!dq) Dumps Outlook's deferred call queue                                       
deferredready                                  (!dfr) Shows the current deferredready threads                                   
delegaterefs                                 (!drefs) Displays information about objects referenced by delegates                
desktop                                   (!desktops) Displays the desktops for the Windows Stations                            
deviceobject                                  (!devo) Displays information about a device object                                
dhcp                                                  Displays information for the DHCP server process                          
diffimg                                               Compares the process' loaded module list with a scan of memory and display
dispid                                                Interprets a dispid                                                       
displayobj                                     (!do2) Display a managed object structure                                        
dnsclient                                     (!dnsc) Displays the DNS client cache, and includes many other features for the DN
dnsserver                                     (!dnss) Allows display and search of the DNS server database and cache.           
domaininfo                                 (!dominfo) Displays domain information from LSASS process                            
dr                                                    Displays registers showing volatile registers highlighted with (*)        
driverobject                                  (!drvo) Displays details about a driver object                                    
drives                                                Displays drive info for each disk with a letter association               
dtpool                                         (!dtp) Displays information about a pool allocation, if it is a known pooltag we 
du                                                    Displays a Unicode string                                                 
dumpabp                                               Interprets an ABP                                                         
dumpadapters                                          Dumps Outlook's adapter list from OLMAPI32!g_pCurrentConnectionManager    
dumpaddins                                            Dumps the addin list from mso!g_pAddInsX                                  
dumpaspnetsession                                     Prints information on ASP.NET InProc Sessions                             
dumpattachmentcol                              (!dac) Dumps an object which inherits from AttachmentCol                         
dumpattachmentobject                           (!dao) Dumps an object which inherits from AttachmentObject                      
dumpccnctconnprovhttp                        (!dccph) Dumps an emsmdb32!CCnctConnProvHTTP object                                
dumpcelement                                 (!_mdce) Dump mshtml!CElement object from address                                  
dumpcnct                                      (!cnct) Dumps an emsmdb32!CNCT object                                             
dumpconnections                                 (!dc) Dumps Outlook's connection list from OLMAPI32!g_pCurrentConnectionManager 
dumpcontactinfo                                (!dci) Dumps an CMsoContactInfo object                                           
dumpcontextlinks                               (!dcl) Dumps the chain of context links of type outlook!OMContextLink            
dumpdataset                                           Dumps a list of all DataSet objects                                       
dumpdotsourcedfiles                                   Outputs any dot sourced Powershell files optionally with their accompanyin
dumpdynamicassemblies2                        (!dda2) Like !DumpDynamicAssemblies, but better                                   
dumpexchangeconnections                        (!dec) Dump Exchange Connections                                                 
dumpexchangeserverconnection                  (!desc) Dumps an emsmdb32!CExchangeServerConnection object                        
dumpexchangestatusbar                         (!desb) Dumps Exchange sync status from OUTLOOK!ThreadSafeSingleton<COlkCEProgress
dumpexplorer                               (!procexp) Opens a process explorer-like UI for a kernel dump.                       
dumpfielddrawinfo                             (!dfdi) Dumps a RGFLDDI array of FieldDrawInfo structures                         
dumpfoldertreeitem                            (!dfti) Outputs an outlook!FolderTreeItem or outlook!ScopeItem                    
dumpgcalloc                                 (!_jsgca) Dump jscript Garbage Collector Alloc from address                         
dumphttpruntime2                                      Dumps the HttpRuntime objects on the heap                                 
dumpiestacks                             (!_iestacks) Dump all IE objects found in all threads                                  
dumpinfo                                        (!di) Display dump information                                                  
dumpjscriptgc                                (!_jdgc) Dump all JScript Garbage Collector                                        
dumpjscriptstacks                           (!_jdjss) Dump all JScript functions found with the related callstack               
dumplcie                                   (!_ielcie) Dump LCIE status for current dump                                         
dumpmapimemory                                 (!dmm) Interprets MAPI memory allocated using MAPIAllocateBuffer/MAPIAllocateMore
dumpmarkup                                    (!_mdm) Dump Mshtml!CMarkup object from address                                   
dumpnamechecksessions                         (!dncs) Dumps the name check sessions (Nickname cache) from OUTLOOK!CDll::s_NameCh
dumppersona                                           Dumps an CMsoPersona object                                               
dumpprintfieldinfo                            (!dpfi) Dumps a RGPFI array of PrintFieldInfo structures                          
dumpprop                                              Dumps an SPropValue at the given address                                  
dumppropdefcollection                         (!dpdc) Dumps an RgPdisp structure                                                
dumpprops                                             Dumps an array of SPropValue at the given address                         
dumpproviders                                         Dumps a chain of lstprov objects                                          
dumpproxystacks                              (!_wdps) Dump all proxy stack found with related callstack                         
dumppsvariables                                       Outputs the Powershell Variables of the currently running script on the cu
dumpreminderdialog                             (!drd) Dumps the reminder dialog from OUTLOOK!g_pReminder                        
dumpreminderqueue                              (!drq) Dumps the reminder queue from OUTLOOK!ReminderQueue::s_pReminderQueue     
dumprenitem                                    (!dri) Dumps an object which inherits from RenItem                               
dumpres                            (!dumprestriction) Dumps an SRestriction at the given address                                
dumprow                                               Dumps one SRow value at the given address                                 
dumprows                                (!dumprowset) Dumps SRows at the given address                                          
dumprpcs                                              Finds MAPI RPCs using olmapi32!g_ServerReqMgrList                         
dumpscriptbody                              (!_jscsb) Dump jscript!CScriptBody object from address                              
dumpscriptexception                         (!_jsdse) Dump jscript!RuntimeScriptException object from address                   
dumpscriptruntime                           (!_jscsr) Dump jscript!CScriptRuntime object from address                           
dumpsessions                                (!pmapix) Dumps the open MAPI sessions from pinst_MAPIX                             
dumpsharedlock                                 (!dsl) Dumps the mso!CSharedLock object for the current thread                   
dumpsort                                              Dumps an SSortOrderSet at the given address                               
dumpstackpscommands                                   Outputs the commands, cmdlets, etc. found on the current thread including 
dumpstackpsobjects                                    Outputs the PSObjects found on the current thread including those referenc
dumpstackstrings                               (!dss) Displays all the strings on the stack                                     
dumpsubmitters                                        Dumps SUBMITTER_REC records                                               
dumpsystemstring                      (!systemstring) Dumps a pstprx32!Microsoft::System::String                                
dumptagarray                              (!dumptags) Dumps a tag array at the given address                                    
dumptasks                                             Dumps SERVER_REQ_TASK_REC records                                         
dumptime                                              Time Information                                                          
dumptreenode                                 (!_mdtn) Dump mshtml!CTreeNode object from address                                 
dumpvar                                     (!dumpvt) Dumps a VARIANT at the given address                                      
dumpwcfmessage                              (!wcfmsg) Dumps information about a WCF buffered message                            
dumpwindowsurfaces                             (!dws) Dump window surfaces to a directory                                       
dumpwrappercontexts                            (!dwc) Dumps Outlook wrapper contexts from outlook!OMPerTypeList<OMWrapperContext
dwm                                          (!ghost) Displays the applications that are in a 'Not Responding' state from ghost 
dwmport                                               Display DWM ALPC Port messages                                            
env                                            (!env) Displays helpful links to get the debugger setup, optimized, or to add 3rd
eresource                                     (!eres) Displays details for a nt!_ERESOURCE                                      
err                                                   Interprets an error code                                                  
evt                                                   Show detail for a nt!_KEVENT                                              
exec                                                  Runs a series of commands. Use this instead of using semicolons           
executive                                             Displays details on threads waiting on the executive                      
fileobject                                      (!fo) Displays information about a given file object                            
fileserver                                      (!fs) Displays thread running the SRV.sys or SRV2.sys drivers, excluding threads
filesystem                                     (!vol) FileSystem - Analyze file system information.                             
filetime                                        (!ft) Dumps a FILETIME at the given address                                     
filter                                         (!flt) Displays all registered filters as well as options for more information   
finalizable                            (!finalizable) Displays information about finalizable objects in the GC Heap             
findapptinfo                                   (!fai) Finds all ApptInfo objects                                                
findohttp                                   (!fohttp) Finds all COlkConnectionHTTP objects in memory (potentially slow)         
findorpc                                     (!forpc) Finds all COlkConnectionRPC objects in memory (potentially slow)          
findpipelines                                  (!fpl) Finds all CROPPipeline objects in memory (potentially slow)               
findpst                                    (!findpst) Finds PSTs                                                                
findstackbaseitems                            (!fsbi) Finds all outlook!BaseItem objects on the stack                           
findstackfolders                               (!fsf) Finds all MNSFolder objects on the stack                                  
findstackrenitems                             (!fsri) Finds all outlook!RenItem objects on the stack                            
findunkobj                                     (!fuo) Finds all emsmdb32!UNKOBJ objects in memory (potentially slow)            
fixadplus                                     (!fadp) Fixes stacks in an ADPlus log                                             
fixexchangesource                              (!fes) Fixes source path for common Exchange symbols                             
fixofficesource                                (!fos) Fixes source path for common Office symbols                               
fixscsource                                   (!fscs) Adds the source code path (.srcpath+) for a System Center or MDOP applicat
fixthis                                               Preface a broken command with this one to open an email and send it to the
flags                                        (!Flags) Interprets flags for a given property tag                                 
fncinfo                                               Dumps information about a vbscript!FncInfo object                         
foldobj                                               Dumps a folder which inherits from emsmdb32!FOLDOBJ                       
foreachcpu                                     (!fec) Executes a command on each processor                                      
foreachframe                                   (!fef) An implementation of !for_each_frame that supports filtering and sets the 
foreachitem                                    (!fei) Iterates through a list, executing a command for each item.               
foreachline                                    (!fel) Runs a command against every line of data                                 
foreachmatchingstack                          (!fems) Run a command against identical stacks                                    
foreachmodule                                  (!fem) An implementation of !for_each_module that supports filtering             
foreachobject                                  (!feo) Runs a command against each CLR object                                    
foreachprocess                                 (!fep) An implementation of !for_each_process that supports filtering and sets th
foreachthread                                  (!fet) An implementation of .for_each_thread that works in user and kernel mode  
functionbody                                 (!_jsfb) Dump jscript9!Js::FunctionBody object from address                        
functioninfo                                 (!_jsfi) Dump jscript9!Js::FunctionInfo object from address                        
gatewait                                              Shows threads with a state of GateWait                                    
gchandleinfo                              (!gchandle) Displays information on GC Handles                                        
gcheapinfo                                    (!gchi) Get info on the managed GC Heap                                           
genericarray                                    (!ga) Dumps an Outlook GenericArray                                             
goodoldtimes                                   (!got) Trace value to origin.                                                    
grep                                                  Search the output of a command for a specific string or pattern           
gtc                                                   Gets the tick count from the shared memory area of an iDNA trace.         
gub                                            (!g-u) Same as gu, but backwards in time: runs p- until hitting the call to the c
guid                                                  Dumps a GUID at the given address                                         
handlefind                                      (!hf) Find handles for a given kernel object                                    
head                                                  Displays the first X lines of a command's output                          
help                                                  Help                                                                      
hidefsurf                                             Encapsulates visualization of the HiDef RDP surfaces                      
hilite                                          (!hl) Highlights the specified text using the specified options (alias: !hilight
httpheaders                                           Print the contents of an HttpHeaderCollection                             
httptrace                                             Enable or Disable HTTP tracing output for Outlook                         
idlequeue                                       (!iq) Dumps the MAPI idle queue                                                 
idna                                             (!i) Displays compact iDNA position for note taking                            
if                                             (!mif) Condition detection based on command output                               
il                                                    Prints the IL for the specified method                                    
ilspy                                                 Automatically extracts the module from the dump, and launches ILSpy       
imports                                               Displays the import table for a module                                    
initialized                                   (!init) Shows the current threads in the initialized state                        
interpretrawstack                              (!irs) This command dumps the raw stack and interprets the values as symbols, and
ioctl                                                 Looks up and displays the properties of an ioctl code                     
ioq                                                   Displays information about local storage IO                               
ip                                                    Converts an address into an IP address format                             
irpbyfilename                                 (!ibfn) Dump any IRP containing the specified text in filename                    
javascriptfunction                          (!_jsfct) Dump jscript9!Js::JavascriptFunction object from address                  
jscriptglobals                           (!_jscriptg) Dump jscript globals                                                      
jscsession                                  (!_jscss) Dump jscript!CSession object from address                                 
jumptoload                                     (!jtl) Jumps to the load timestamp of a given module in an IDNA trace            
kbsearchmodules                                (!kbs) SilverSeekKB debug extension                                              
ldap                                                  Displays LDAP client or server details                                    
ldaparena                                (!ldaparena) Displays Memory usage by LDAP/ESENT in Windows 8.1 and later              
listthreads                                     (!lt) Displays a list of threads                                                
listticks                                   (!lticks) Show tick counts for threads                                              
lls                                                   Check for logon/logoff/shutdown hangs                                     
loaderlock                                      (!ll) Displays loader lock information                                          
logoff                                        (!loff) Logoff hang analyzer                                                      
logon                                          (!lon) Logon hang analyzer                                                       
logonobj                                              Dumps an object which inherits from emsmdb32!LOGONOBJ                     
logonsession                         (!logonsessions) Displays LSASS's logon session details                                    
loop                                                  Loops either forwards or backwards through a series of numbers with variab
lpdriver                                              Outputs local printer driver structures for an application                
lphandle                                              Outputs local spooler handles for an application                          
lsahandletable                                 (!lht) Displays LSASS's logon session details                                    
lsasessions                                           Displays LSASS's  session details                                         
lsass                                          (!lsa) Displays LSASS information                                                
managedthreads                            (!mthreads) A !threads look-alike, with !aspxpagexext-like output                     
mapiobjectcache                                (!moc) Dumps an object which inherits from outlook!MapiObjectCache               
mapiobjinstancedata                           (!moid) Dumps an object which inherits from outlook!MapiObjInstanceData           
mapistruct                                            Dumps a MAPI object                                                       
mappeddrives                               (!mdrives) Displays mapped drives                                                    
mem                                                   Memory usage information                                                  
messagequeue                                    (!mq) Displays message queue                                                    
mheap                                                 A DML'd version of !heap.                                                 
mirp                                                  Displays IRP details (replaces !irp)                                      
mirpfind                                              Mex version of IRPFIND                                                    
mnsfolder                                             Dumps an object which inherits from MNSFolder                             
mods                                                  Displays modules loaded in a process                                      
more                                                  Runs a command in paged mode, asking for input every X lines              
mreg                                                  This is a DML'd version of !reg                                           
mrmsg                                          (!msg) Interprets a Windows message                                              
ms                                              (!ms) Dumps a message store which inherits from MSPST32!MS                      
msgobj                                                Dumps a message which inherits from emsmdb32!MSGOBJ                       
mshtmlglobals                             (!_mshtmlg) Dump mshtml globals                                                       
mshtmlthreadstates                          (!_mcdoc) List mshtml!THREADSTATE objects                                           
mshtmlwindows                               (!_mcwnd) List mshtml!CWindow objects                                               
msodoc                                                Displays detailed information about an object which inherits from mso!CMso
msprvdrobj                                            Dumps a folder which inherits from emsmdb32!MSPRVDROBJ                    
mup                                                   Displays info for the Multiple UNC Provider (MUP)                         
namedprop                                       (!np) Dumps the named prop table list from olmapi32!s_rgNamedPropTable          
namedproptable                                 (!npt) Dumps a named prop table derived from olmapi32!NamedPropMapTableEntry     
namelist                                     (!_jsnl) Dump jscript!NameList object from address                                 
nametbl                                      (!_jsnt) Dump jscript!NameTbl object from address                                  
nativeheapleak                                 (!nhl) If a heap stack database is present, prints out the main consumers.       
ncsi                                                  Displays Network Connectivity Status Indicator (NCSI) configuration       
ndao                                                  Native Dump ALL Objects - Potentially very slow                           
ndb                                            (!ndb) Dumps an MSPST32!NDB object                                               
ndro                                                  Native Dump Register Objects                                              
ndso                                                  Native Dump Stack Objects                                                 
net                                                   Net Command Help                                                          
notes                                            (!n) Annotate thread analysis in realtime                                      
notification                                 (!notif) Dumps a NOTIFICATION object                                               
notifications                               (!notifs) Dumps an array of NOTIFICATION objects                                    
notifyobj                                             Dumps a message which inherits from emsmdb32!NOTIFYOBJ                    
ntfsacl                                               Displays information on the NTFS AsyncCloseList.                          
obj                                                   Displays details for a given kernel object (object manager)               
objectsummary                                         Outputs object analysis summary                                           
objt                                                  Interprets an OBJT                                                        
obtrace                                               Dumps the trace information for an object                                 
olanalyze                                      (!ola) Basic Outlook/MAPI dump analysis                                          
olcmd                                    (!olglobals) Dumps the command line parameters from OUTLOOK!g_psoclCmdLine             
olic                                 (!officelicense) Dumps the Office Licensing information from mso!vplic                     
openprinters                                    (!op) Shows a list of currently open printers                                   
oracleclientperfcounters                              Display System.Data.OracleClient performance counters                     
outline                                         (!ol) Outlines the calls inside a given function                                
p                                                     Displays process details                                                  
phandles                                        (!ph) Shows a list of currently open printer handles                            
pingtrack                                             Pingtrack command                                                         
printdbcommand                                        Prints information about a DBCommand object                               
printexception2                                (!pe2) Like !PrintException, with DML                                            
printmanifest                                         Prints the assembly manifest for the specified module                     
printmembers                                          Scans specified module and type [Module!TypeName] and prints all members  
printtypes                                            Scans specified [Module] and prints all types                             
propset                                               Dumps an object which inherits from PropSet                               
proxyinfo                                     (!_wpi) Dump wininet!PROXY_INFO object from address                               
proxymanager                                  (!_wpm) Dump WininetProxyManager object from address                              
psh                                                   Allow to execute debugger commands and to process results with powershell 
psrunspace                                            Outputs the runspaces in the process.                                     
psscriptblock                                         Outputs the script blocks in the process.                                 
pstobj                                                Dumps an object which inherits from MSPST32!OBJ                           
ptag                                       (!proptag) Interprets a property tag                                                 
publicsymbolcreep                                     Detects whether any public symbols have been loaded for Microsoft binaries
rasmans                                               Displays the rasmans!ConnectionBlockList                                  
readfile                                              Read a file from the filesystem and display the output in the debugger    
ready                                          (!rdy) Shows the currently ready threads                                         
recenterror                                     (!re) Dumps the recent error queue from olmapi32!g_RecentErrInfo                
rnotf                                                 Dumps a message which inherits from emsmdb32!RNOTF                        
rollup                                          (!ru) Takes an input value and rolls it up to the appropriate bucket (e.g. bytes
rop                                                   Interprets a ROP                                                          
rot                                                   Dumps Outlook's Running Object Table (ROT)                                
rpctrace                                              Enable or Disable RPC tracing output for Outlook                          
rtime                                                 Interprets an rtime value                                                 
runaway2                                              Runaway2.. Replacement for !runaway                                       
runcheck                                 (!runchecks) runs the specified check(s) on the specified module(s)                    
runchecklist                                          runs the specified checklist(s) on the specified module(s)                
running                                        (!cpu) (Kernel mode only) A brief overview of currently executing threads        
rxirps                                                Displays the list of IRPs stored in rdbss!RxIrpsList                      
sccm                                                  SCCM                                                                      
scom                                            (!om) Utilities for SC Operations Manager.                                      
scrfncobj                                   (!_jssfo) Dump jscript!ScrFncObj object from address                                
scsm                                            (!sm) Utilities for SC Service Manager                                          
scvmm                                          (!vmm) System Center Virtual Machine Manager                                     
searchthreadstacks                             (!sts) Searches thread stacks for a value                                        
serverinfo                                    (!_wsi) Dump wininet!CServerInfo list                                             
serverinfoidna                            (!_wsiydna) Parse IDNA and check wininet!CServerInfo objects                          
services                                   (!service) Displays details about services. Requires access to the usermode address s
session                                   (!sessions) Display details for sessions                                              
settings                                              Mex Settings                                                              
shutdown                                              Analyze shutdown hangs                                                    
sort                                                  Sort command                                                              
sourceinfo                                   (!_jssi) Dump jscript9!Js::FunctionBody::SourceInfo object from address            
spdisposecheck                                        Executes the SharePoint Dispose and Do Not Dispose Checklist items        
spirenitem                                            Dumps an SPIRenItem object                                                
sqlclientperfcounters                                 Display System.Data.SqlClient performance counters                        
sqlcmd                                                Provides information about ADO.NET Commands to SQL Server                 
sqlcn                                                 Provides an overview of ADO.NET connections to SQL Server                 
sqlports                                  (!sqlports) Gets the local and remote TCP ports from a SqlConnection object           
srvnet                                                Displays info on SRVNET                                                   
stackoverflow                                   (!so) Queries StackOverflow                                                     
standby                                        (!sby) Shows the current standby threads                                         
staticfields                                          Display static fields of a managed type                                   
strings                                               Prints out readable strings in an address range                           
stx                                            (!stx) Annotate thread stacks in realtime                                        
sum                                            (!sum) Sums the output returned by a command                                     
suspended                                             Displays details on suspended threads                                     
svcreg                                                Dumps the passed in service/driver registry key                           
svcthreads                              (!svcthreads) Find threads executing WCF services                                       
t                                                     A new implementation of !thread for user & kernel mode                    
tableobj                                              Dumps a folder which inherits from emsmdb32!TABLEOBJ                      
tac                                                   Writes input to console, last line first.                                 
tag                                                   Searches kernel modules for a given pooltag                               
tail                                                  Displays the final X lines of a command's output                          
tasklist                                        (!tl) Displays information about running tasks (processes)                      
tasktriage                                   (!tasks) Analyzes the System.Threading.Tasks.Task objects still on the heap.       
tcpip                                          (!tcp) TCP/IP - Gets TCP and UDP ports from Kernel Memory                        
threadpool                                      (!tp) Displays information regarding NTDLL thread pools                         
threadreport                                  (!trep) Displays a thread report.                                                 
time                                                  Time how long a command takes to execute                                  
tr                                         (!replace) Search and Replace. Translate a char/string into another char/string.     
transition                                   (!trans) Shows the current threads in the transition state                         
tttcache                                      (!tttc) Caches code execution locations throughout a time travel trace utilizing m
tttfindcachedcodelocations                     (!fcc) Finds code execution locations from a previously created TTTCache         
tttfindreturnvalue                             (!frv) Finds return value locations from a previously created TTTCache           
tttlistpositionsbymodule                       (!lpm) Finds code execution positions and counts for functions within a module fr
tttraceback                                    (!ttb) "Steps Out" of the specified location then displays a timeline of what fun
udescan                                   (!manalyze) Scans dump for known issues and displays them in human-readable format.   
uniqlines                                       (!ul) Prints each line of output and a count of how many times they appeared    
uniquestacks                                    (!us) Like the built-in !uniqstacks except it associates thread IDs with the sta
unkobj                                                Interprets an UNKOBJ                                                      
update                                                Updates mex to the latest version                                         
urlmonglobals                             (!_urlmong) Dump urlmon globals                                                       
urlmonzones                                   (!_wsz) Dump urlmon Security zones                                                
userrequest                                           Displays details on threads with a wait reason of UserRequest             
vbaproj                                               Displays detailed information about a VBA project (vbe7!ProjItem)         
vbscript                                       (!vbs) Displays detailed information about vbscript running on the current thread
ver                                                   Displays OS version info                                                  
vrdpfb                                                Encapsulates visualization of the RDP frame buffer                        
vss                                                   Vss Command Help                                                          
wcfperfcounters                                       Dumps performance counters for WCF services                               
wcftcpconnectionpools                         (!wtcp) Display WCF Net.TCP connection pools                                      
wdanalyze                                             Displays Word-specific information (open documents, active document, last 
wddoc                                          (!doc) Displays detailed information about a particular document which inherits f
wddocs                                        (!docs) Finds currently opened Word documents and templates using wwlib!vpdodUser 
wdflags                                               Displays information about global flags                                   
wdfn                                                  Displays detailed information about open files                            
wdt                                                   Displays information about last fetch                                     
whocalls                                              Scans all loaded managed modules and finds methods that call [MethodName] 
whoimplements                                         Scans all loaded managed modules and finds types that implement [Interface
whoinherits                                           Scans all loaded managed modules and finds types that inherit [TypeName]  
whonews                                               Scans all loaded managed modules and finds methods that construct [TypeNam
whopins                                               Scans managed modules and all finds methods that pin objects of a given [T
window                                         (!wnd) Displays windows for each desktop. You must be in the context of a given s
windowstation                               (!winsta) Display details for windows station(s)                                    
wininetaddrinfo                               (!_wai) Dump wininet!AddrInfo object from address                                 
wininetcache                               (!_wcache) Dump wininet!CCacheClientStore informations                               
wininetccacheclientcontainerinfo      (!_wccacheinfo) Dump CCacheClientContainerInfo object from address                        
wininetccacheclientstoreitem              (!_wccache) Dump CCacheClientStoreItem object from address                            
wininetcookies                              (!_wcook) Dump cookies informations                                                 
wininetdnscache                              (!_wdns) Dump wininet DNS cache                                                    
wininetglobals                                 (!_wg) Dump wininet globals                                                      
wininethandles                                 (!_wh) List wininet!INTERNET_HANDLE_OBJECT                                       
wininetkeepalive                              (!_wka) List wininet!ICSocket Keep-Alive from  address                            
wininetrequests                              (!_wreq) Dump wininet!HTTP_REQUEST_HANDLE_OBJECT list                              
wininetrequestsidna                      (!_wreqidna) Parse IDNA and check wininet!HTTP_REQUEST_HANDLE_OBJECT objects           
winlogon                                              Displays details about Winlogon (pre-Vista)                               
winnsi                                                winnsi Command Help                                                       
winrm                                                 WinRM / wsmsvc related commands                                           
wldap32                                               Displays wldap32.dll details (dll responsible for client side LDAP connect
wmi                                                   WMI / WINMGMT related commands                                            
wolfram                                         (!wa) Queries Wolfram Alpha                                                     
wq                                                    Displays executive work queue threads                                     
wrcpuratecontrol                                      Displays details on threads with a wait reason of WrCpuRateControl        
wrfastmutex                                           Displays details on threads waiting for a Fast Mutex                      
wrfreepage                                            Displays details on threads with a wait reason of WrFreePage              
writefile                                             Runs a command and writes the data to a file                              
writemem                                              Writes memory to disk                                                     
writemodule                                           Writes a module to your temp directory                                    
wrlpcreceive                                  (!lpcs) Displays details on LPC/ALPC server threads                               
wrresource                                            Displays details on threads with a wait reason of WrResource              
wsus                                                  Utilities WSUS                                                            
x                                                     Wrapper for x that adds some DML                                          
xlanalyze                                      (!xla) Analyzes Excel session and displays debug information.                    
xlbooks                                        (!xlb) Displays information about open workbooks.                                
xlvbe                                                 Displays information about the Visual Basic Environment (VBE).            
xlwindows                                      (!xlw) Displays information about open windows.                                  
xx                                              (!x2) Replacement for !x                                                        
zonemappings                                  (!_wzm) Dump zones mappings informations                                          


Ndis registery path (example):
HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Control\Class\{4d36e972-e325-11ce-bfc1-08002be10318}\0003\Ndi\params\NetworkAddress

PDB Dump: cvdump.exe @ https://github.com/Microsoft/microsoft-pdb/blob/master/cvdump/cvdump.exe

Force crash dump:

https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/forcing-a-system-crash-from-the-keyboard


With USB keyboards, you must enable the keyboard-initiated crash in the registry. In the registry key HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\kbdhid\Parameters, create a value named CrashOnCtrlScroll, and set it equal to a REG_DWORD value of 0x01.

After this is completed, the keyboard crash can be initiated by using the following hotkey sequence: Hold down the rightmost CTRL key, and press the SCROLL LOCK key twice.

PCI bus:
kd> !pcitree
0: kd> !pcitree
Bus 0x0 (FDO Ext ffff94863e7571d0)
  (d=0,  f=0) 80868a12 devext 0xffff94863c11b460 devstack 0xffff94863c11b310 0600 Bridge/HOST to PCI
  (d=2,  f=0) 80868a52 devext 0xffff94863e5cc720 devstack 0xffff94863e5cc5d0 0300 Display Controller/VGA
  (d=5,  f=0) 80868a19 devext 0xffff94863e6bb4b0 devstack 0xffff94863e6bb360 0480 Multimedia Device/'Other'
  (d=d,  f=0) 80868a13 devext 0xffff94863e6bd4b0 devstack 0xffff94863e6bd360 0c03 Serial Bus Controller/USB
  (d=12, f=0) 808634fc devext 0xffff94863e6b34b0 devstack 0xffff94863e6b3360 0700 Simple Serial Communications Controller/Serial Port
  (d=14, f=0) 808634ed devext 0xffff94863e6b54b0 devstack 0xffff94863e6b5360 0c03 Serial Bus Controller/USB
  (d=14, f=2) 808634ef devext 0xffff94863e6b74b0 devstack 0xffff94863e6b7360 0500 Memory Controller/RAM
  (d=14, f=3) 808634f0 devext 0xffff94863e7624b0 devstack 0xffff94863e762360 0280 Network Controller/'Other'
  (d=15, f=0) 808634e8 devext 0xffff94863e76d4b0 devstack 0xffff94863e76d360 0c80 Serial Bus Controller/Unknown Sub Class
  (d=15, f=2) 808634ea devext 0xffff94863e76f4b0 devstack 0xffff94863e76f360 0c80 Serial Bus Controller/Unknown Sub Class
  (d=15, f=3) 808634eb devext 0xffff94863e7714b0 devstack 0xffff94863e771360 0c80 Serial Bus Controller/Unknown Sub Class
  (d=16, f=0) 808634e0 devext 0xffff94863e7734b0 devstack 0xffff94863e773360 0780 Simple Serial Communications Controller/'Other'
  (d=16, f=4) 808634e4 devext 0xffff94863e7754b0 devstack 0xffff94863e775360 0780 Simple Serial Communications Controller/'Other'
  (d=19, f=0) 808634c5 devext 0xffff94863e6c24b0 devstack 0xffff94863e6c2360 0c80 Serial Bus Controller/Unknown Sub Class
  (d=1d, f=0) 808634b0 devext 0xffff94863e6c44b0 devstack 0xffff94863e6c4360 0604 Bridge/PCI to PCI
  Bus 0x1 (FDO Ext ffff94863e76b190)
    (d=0,  f=0) 1e0f0001 devext 0xffff94863e6dd1f0 devstack 0xffff94863e6dd0a0 0108 Mass Storage Controller/Unknown Sub Class
  (d=1d, f=4) 808634b4 devext 0xffff94863e6c64b0 devstack 0xffff94863e6c6360 0604 Bridge/PCI to PCI
  Bus 0x2 (FDO Ext ffff94864b39d510)
    (d=0,  f=0) 10de2191 devext 0xffff94864b419270 devstack 0xffff94864b419120 0302 Display Controller/Unknown Sub Class
  (d=1e, f=0) 808634a8 devext 0xffff94863e6c84b0 devstack 0xffff94863e6c8360 0780 Simple Serial Communications Controller/'Other'
  (d=1f, f=0) 80863482 devext 0xffff94863e6ca4b0 devstack 0xffff94863e6ca360 0601 Bridge/PCI to ISA
  (d=1f, f=3) 808634c8 devext 0xffff94863e6cc4b0 devstack 0xffff94863e6cc360 0403 Multimedia Device/Unknown Sub Class
  (d=1f, f=5) 808634a4 devext 0xffff94863e6ce4b0 devstack 0xffff94863e6ce360 0c80 Serial Bus Controller/Unknown Sub Class
Total PCI Root busses processed = 1
Total PCI Segments processed = 1

0: kd> !devstack 0xffff94864b419120
  !DevObj           !DrvObj            !DevExt           ObjectName
  ffff94864b6a9030  \Driver\nvlddmkm   ffff94864b6a9180  
  ffff94864b3a3e10  \Driver\ACPI       ffff94863e5e0440  
> ffff94864b419120  \Driver\pci        ffff94864b419270  NTPNP_PCI0021
!DevNode ffff94864b3bc340 :
  DeviceInst is "PCI\VEN_10DE&DEV_2191&SUBSYS_00321414&REV_A1\4&3208d4ed&0&00EC"
  ServiceName is "nvlddmkm"

Note: ACPI !DevExt is the Device is NSTree (Acpi namespace) for example:
| | SSH_ (ffff8904d4f27248) - Device ffff94863e5e0440


0: kd> !devext ffff94864b419270
PDO Extension, Bus 0x2, Device 0, Function 0.
  DevObj 0xffff94864b419120  Parent FDO DevExt 0xffff94864b39d510
  Device State = PciStarted
  Vendor ID 10de (NVIDIA CORPORATION)  Device ID 2191
  Subsystem Vendor ID 1414 (MICROSOFT CORPORATION)  Subsystem ID 0032
  Header Type 0, Class Base/Sub 03/02  (Display Controller/Unknown Sub Class)
  Programming Interface: 00, Revision: a1, IntPin: 01, RawLine 00
  Possible Decodes ((cmd & 7) = 7): BMI
  Capabilities: Ptr=60, power msi express 
  Express capabilities: (OS controlled) ltr aer 
  Logical Device Power State: D3
  Device Wake Level:          D3
  WaitWakeIrp:                <none>
  Requirements:     Alignment Length    Minimum          Maximum
    BAR0    Mem:    01000000  01000000  0000000000000000 00000000ffffffff
    BAR1    Mem:    10000000  10000000  0000000000000000 ffffffffffffffff
    BAR3    Mem:    02000000  02000000  0000000000000000 ffffffffffffffff
    BAR5     Io:    00000080  00000080  0000000000000000 00000000ffffffff
      ROM BAR:      00080000  00080000  0000000000000000 00000000ffffffff
    VF BAR0 Mem:    00080000  00080000  0000000000000000 00000000ffffffff
  Resources:        Start            Length
    BAR0    Mem:    00000000b5000000 01000000
    BAR1    Mem:    00000000a0000000 10000000
    BAR3    Mem:    00000000b0000000 02000000
  Interrupt Requirement:
    Line Based - Min Vector = 0x0, Max Vector = 0xffffffff
    Message Based: Type - Msi, 0x1 messages requested
  Interrupt Resource:    Type - MSI, 0x1 Messages Granted

  Config space access log: !pcicfglog 0xffff94864b419270

!kext.pci
!pci 602 ffff ff

dxgkdx debugger:
===============
7: kd> !dxgkdx.help
!adapters - Display information on all adapters started on the system.
!bdd - Prints the useful state of the specified BDD adapter.
!clearoutputduplsdiag - Clears out the DDA diagnostic buffers for the specified OutputDupl managers
!commitrequest <commit VidPN request> - Display summary of the request to commit a VidPN.
!deadlocks - Displays each adapter's core eresource (if held) and active dxgkrnl deadlock trackers.
!devices - Displays a list of VidMm devices on the system
!diag - Prints the diagnostics buffers present in the global dxgkrnl circular buffers.
!diagnostics - Prints the diagnostics buffers present in the global dxgkrnl circular buffers.
!displayconfig <Path Array> <Size of path array> <Mode Info Arrary.
!dispmodes <adapter object> <VidPN source ID> - Display cached display mode list for the specified adapter.
!dmabuffer - Display information on a particular DMA buffer.
!dmmobject <DMM object> - Display summary of the specified DMM object.
!dmmstatus <VidPN manager> - Display summary of the specified VidPN manager.
!dxalloc - Display information on a particular allocation.
!dxcontext - Display information on a particular context.
!dxdevice - Display information on a particular device.
!dxgadapters - Displays all the active DXGADAPTERs on the system.
!dxganalyze - TBD

!dxgkflags options flags      --   Parses a macro'd flag into a decipherable string.
!dxglog - Dumps display driver model related logs
!dxgloggo - replaces 'g' command to use with '!dxglog -live'.
!dxgsession - Prints the contents of the dxgkrnl session manager.
!dxhandle - Display information on a particular handle.
!dxhandletable - Display information about a handle table.
!dxprocess - Display information about a particular process or list existing processes.
!dxresource - Display information on a particular DXGRESOURCE object.
!dxsyncobj - Display information on a particular synchronization object.
!dxvm - Display information about virtual machines.
!edid - Displays EDID information parsed from the target or from the command-line.
!fencehistory - Displays fence history for a scheduler node.
!flipentry- Displays a flip queue entry
!fliphistory - Displays flip queue history for all planes of a particular VidPnSource.
!flipstatus - Displays flipstatus for every entry of the flip queue
!gammaramp <gamma ramp data> - Display summary of the gamma ramp data.

!gpuva- Prints information about a specific virtual address.
!gpuvapaginghistory- Prints paging history on the given adapter.
!gpuvasearch - Searches page tables of a process for physical address.
!help - Display list of command or detailed help on a specific command.
!interrupthistory - Displays interrupt history for a scheduler node.
!iodevices - Lists all iommu devices.
!iofault - Gets fault information from a given IoMmu.
!iogpa - Decode GPA for a given device.
!iommus - Lists all iommus.
!iommusearch - Finds a mapped page.
!lockorder - Dumps lock acquisition state for DXGTHREAD.
!mmdevice - Display information on a particular device.
!mmdevicebudget - Inspect the VidMm device and it's budget history.
!mmstatus - Display status information on the specified memory manager object.
!monitor <monitor object> - Display summary of the specified monitor.
!monitormode <monitor mode object> - Display summary of the specified monitor mode.
!monitormodeset <monitor mode set object> - Display summary of the specified monitor mode set.
!outputdupl - Prints the diagnostics buffers present in the given output duplication manager.
!outputduplsnapshot - Prints the debug snapshot present in the given output duplication manager.
!pagehistorysearch - Searches the page history in the given VIDMM_GLOBAL for a physical address.
!paginghistory - Display recent paging history.
!pagingqueue- Dumps contents of a paging queue.
!pathsmodality <Address of a D3DKMT_GETPATHSMODALITY structure> - Display summary of the specified VidPN paths modality.
!penaltybox - Dumps the state of the various penalty box bands and their devices.
!portstatus - Display status information on the specific device object.
!powercomponents - Display information about power components for the given adapter.
!processvads - Prints information about the virtual address space of a process.
!qdccache
!rotationhistory - Display recent rotation history.
!scandmausage - Scans processes and outputs their DMA buffer usage.
!schstatus - Display status information on the specific scheduler object.
  sdump                                      - produces hex dump of the TDR related
                                               data from minidump
!searchalloc - Search for allocations matching the specified criterias.
!searchpageshistory - Search through the recent system memory pages history.
!sharedallocs - Displays all shared allocs and local allocs.
  simea <expression>                         - sumulates timeout by injecting infinite loop
!smm - Various commands for inspectign the state of the system memory manager.
!syncobj - Display information for a scheduler synchronization object.
                                             - TBD
                                             - TBD
!vidpn <VidPN object> - Display summary of the specified VidPN.
!vidpnpath <VidPN present path object> - Display summary of the specified VidPN present path.
!vidpnsourcemodeset <VidPN source mode set object> - Display summary of the specified VidPN source mode set.
!vidpntargetmodeset <VidPN target mode set object> - Display summary of the specified VidPN target mode set.
!viewheap - Allows inspection of the recycle heap for a process.
!vsyncstate - Displays VSync state for all VidPnSources of adapter.


DPCs:
1: kd> !kdexts.dpcwatchdog
All durations are in seconds (1 System tick = 0.000000 milliseconds)
Circular Kernel Context Logger history: !logdump 0x2
DPC and ISR stats (total since boot): !intstats /d
DPC and ISR stats (during DPC watchdog period): !intstats /w

--------------------------------------------------
CPU#0
--------------------------------------------------
Current DPC: No Active DPC
Pending DPCs:
----------------------------------------
CPU Type      KDPC       Function
Failed to read DPC at 0xfffff80214639520
 0: Threaded: 0xfffff8020ea920d8 0xfffff802142ff1e0 nt!KiDpcWatchdog

--------------------------------------------------
CPU#1
--------------------------------------------------
Current DPC: No Active DPC
Pending DPCs:
----------------------------------------
CPU Type      KDPC       Function
 1: Threaded: 0xffffc40045fd10d8 0xfffff802142ff1e0 nt!KiDpcWatchdog
fffff802146283b8: Unable to get Flags value from nt!KdVersionBlock
DPC Watchdog Captures Analysis for CPU #1.
   DPC Watchdog capture size: 641 stacks.
   Number of unique stacks: 132.
   Most common function: fffff802143cb148  nt!KiStartSystemThread+0x28
List of functions that exist often in the Watchdog record:
Module Name    Function Name                            #Stack  #Of Occurrences
nt             KiTransitionSchedulingGroupGeneration    002     125 (of 131)
List of functions that are called often in the Watchdog record:
Module Name    Function Name                            #Stack  #Of Occurrences
nt             KiTransitionSchedulingGroupGeneration    003     125 (of 131)


1: kd> !dpchistory 1
fffff802146283b8: Unable to get Flags value from nt!KdVersionBlock
CPU #1 DPC Watchdog History Stack #1 (of 641) - Time: 21597 Min 15 Sec 171.88 mSec
 # RetAddr           Call Site
05 fffff802142239f4  nt!KiChargeSchedulingGroupCycleTime+0x2E [minkernel\ntos\ke\schedgrp.c @ 1058]
06 fffff802142236d5  nt!KiTransitionSchedulingGroupGeneration+0x104 [minkernel\ntos\ke\schedgrp.c @ 4104]
07 fffff80214220fd6  nt!KiGroupSchedulingGenerationEnd+0x55 [minkernel\ntos\ke\schedgrp.c @ 2488]
08 fffff80214220778  nt!KiGroupSchedulingQuantumEnd+0xC2 [minkernel\ntos\ke\schedgrp.c @ 2870]
09 fffff802143ca946  nt!KiQuantumEnd+0x658 [minkernel\ntos\ke\quantum.c @ 300]
0a fffff802143c9ffe  nt!KiDispatchInterruptContinue+0x16 [minkernel\ntos\ke\amd64\ctxswap.asm @ 238]
0b fffff80214250b58  nt!KiDpcInterrupt+0x2EE [minkernel\ntos\ke\amd64\dpcint.asm @ 138]
0c fffff8021424f904  nt!KiSwapThread+0xCD8 [minkernel\ntos\ke\thredsup.c @ 11123]
0d fffff80214310108  nt!KiCommitThreadWait+0x144 [minkernel\ntos\ke\waitsup.c @ 773]
0e fffff8021438aed6  nt!KeWaitForGate+0xCC [minkernel\ntos\ke\gateobj.c @ 202]
0f fffff80214327c95  nt!KiExecuteDpc+0x86 [minkernel\ntos\ke\dpcsup.c @ 1477]
10 fffff802143cb148  nt!PspSystemThreadStartup+0x55 [minkernel\ntos\ps\psexec.c @ 9322]
11 ----------------  nt!KiStartSystemThread+0x28 [minkernel\ntos\ke\amd64\threadbg.asm @ 83]




4: kd> !pde.help
=========================================================================================
 Help for Prototype Debugger Extension (PDE) v12.7 - Copyright 2009-2020 Andrew Richards
=========================================================================================
  !seek          - Equivalent of ~*knL and/or !deep 1

  !seek [-q] [-e symbol] [<symbol> [command]]
                 - Execute 'command' against stacks that contain 'symbol'
                    (Note, don't include a displacement in the specified symbol)

                 - Specify '-q' (quiet) to omit the per-thread header

                 - Specify '-e' to exclude stacks that contain 'symbol'
                    (Note, don't include a displacement in the specified symbol)

                   e.g. !seek
                        !seek ReadFile
                        !seek ReadFile kbn
                        !seek ReadFile dps @rsp @rsp+0x20
                        !seek -q ReadFile !teb
                        !seek -e SleepEx ReadFile !teb

  !seek -?        - Display the help for !seek
  !seek -help     - Display the help for !seek

=========================================================================================
  !deep          - Equivalent of ~*knL but only displays stacks that are at least
                   'depth' frames deep (default depth is 1)

  !deep [<depth> [-q] [-s symbol] [-e symbol] [command]]
                 - Execute 'command' against stacks that are at least 'depth' frames deep

                 - Specify '-q' (quiet) to omit the per-thread header

                 - Specify '-s' to only include stacks that contain 'symbol'
                    (Note, don't include a displacement in the specified symbol)

                 - Specify '-e' to exclude stacks that contain 'symbol'
                    (Note, don't include a displacement in the specified symbol)

                   e.g. !deep
                        !deep 25
                        !deep 25 kbn
                        !deep 25 dps @rsp @rsp+0x20

                        !deep 25 -q
                        !deep 25 -q !teb

                        !deep 25 -s ReadFile
                        !deep 25 -s ReadFile kbn
                        !deep 25 -s ReadFile dps @rsp @rsp+0x20

                        !deep 25 -e SleepEx
                        !deep 25 -e SleepEx kbn
                        !deep 25 -e SleepEx dps @rsp @rsp+0x20

  !deep -?        - Display the help for !deep
  !deep -help     - Display the help for !deep

=========================================================================================
  !busy          - Equivalent of ~*knL but only displays stacks that are at least
                   'depth' frames deep (default depth is 1) and are not waiting for:-
                    ~ ntdll!NtWaitFor*
                    ~ ntdll!ZwWaitFor*
                    ~ ntdll!NtRemoveIoCompletion
                    ~ ntdll!ZwRemoveIoCompletion
                    ~ ntdll!NtReplyWaitReceivePort
                    ~ ntdll!ZwReplyWaitReceivePortEx

  !busy [<depth> [-x] [-q] [-s symbol] [-e symbol] [command]]
                 - Execute 'command' against stacks that are at least 'depth' frames deep
                   and are not waiting (for the list above)

                 - Specify '-x' to also exclude waiters of network calls, sleeps nad messages:-
                    ~ ntdll!NtRequestWaitReplyPort
                    ~ ntdll!ZwRequestWaitReplyPort
                    ~ ntdll!NtDelayExecution
                    ~ ntdll!ZwDelayExecution
                    ~ ntdll!RtlDeactivateActivationContextUnsafeFast
                    ~ *!NtUserWaitMessage
                    ~ *!ZwUserWaitMessage
                    ~ *!ZwUserGetMessage
                    ~ *!NtUserGetMessage

                 - Specify '-q' (quiet) to omit the per-thread header

                 - Specify '-s' to only include stacks that contain 'symbol'
                    (Note, don't include a displacement in the specified symbol)

                 - Specify '-e' to exclude stacks that contain 'symbol'
                    (Note, don't include a displacement in the specified symbol)

                   e.g. !busy
                        !busy 25
                        !busy 25 kbn
                        !busy 25 dps @rsp @rsp+0x20

                        !busy 25 -x
                        !busy 25 -x kbn
                        !busy 25 -x dps @rsp @rsp+0x20

                        !busy 25 -q
                        !busy 25 -q !teb

                        !busy 25 -s ReadFile
                        !busy 25 -s ReadFile kbn
                        !busy 25 -s ReadFile dps @rsp @rsp+0x20

                        !busy 25 -e SleepEx
                        !busy 25 -e SleepEx kbn
                        !busy 25 -e SleepEx dps @rsp @rsp+0x20

  !busy -?        - Display the help for !busy
  !busy -help     - Display the help for !busy

=========================================================================================
  !dpx           - Equivalent of dps, dpp, dpa and dpu (combined); also class types (dt) and trap frames (kV)

  !dpx           - Displays from stack pointer to the stack base
  !dpx N         - Displays the first N values, from the stack pointer down
  !dpx <addr> N
                 - Displays the first N values, from <addr> down
  !dpx <addr> <addr>
                 - Displays from addr to addr

                 - Specify '-u' to display an unlimited number of values
                   Default limit is 6,000 addresses

                 - Specify '-a' to display all stack values
                   Default only displays stack values that point to a value

                 - Interface pointers are adjusted to align with the class's virtual function table (vftable)
                 - When there is a value adjustment, the pointer is displayed in light blue text

                 - Specify the following to limit the types; multiple options are allowed
                   -da : ANSI strings
                   -du : UNICODE strings
                   -dt : Data Types
                   -ds : Symbols
                   -df : Trap Frames (Kernel only)
                   -dse: Stowed Exceptions (WinRT apps only)


                   e.g. !dpx
                        !dpx 20
                        !dpx -a
                        !dpx -da -du 20
                        !dpx <addr> <addr> -u
                        !dpx <addr> <addr> -u -a

=========================================================================================
  !spx/!spxa     - Find an expression (number) or data type (symbol)
                 - Search is POINTER aligned
                 - Special handling for multiple interface classes
                 - Add -dt to perform a 'dt' on each address
                 - Very fast in User Mode
                 - Very slow in Kernel Mode

  !spx           - Commit/Private/ReadWrite only
  !spxa          - Commit only

  !spx/!spxa [-dt] [-s <addr>] [-e <addr>] <expression>

                   e.g. !spx combase!CComApartment
                        !spx -dt combase!CComApartment
                        !spx -s @rsp -e @rsp+1000 0x1234000+0n56

=========================================================================================
  !sdx           - Find an expression (number)
                 - Search is DWORD aligned
                 - Very fast in User Mode
                 - Very slow in Kernel Mode

  !sdx [-s <addr>] [-e <addr>] <expression>

=========================================================================================
  !ssz           - Find ANSI and UNICODE strings
  !ssa           - Find ANSI strings
  !ssu           - Find UNICODE strings
                 - Search is case sensitive
                 - Displays up to 200 characters after the initial match
                 - UNICODE search is a conversion of the ANSI command line
                 - Very FAST in User Mode
                 - Very slow in Kernel Mode

  !ssz [-s <addr>] [-e <addr>] <string>
  !ssa [-s <addr>] [-e <addr>] <string>
  !ssu [-s <addr>] [-e <addr>] <string>

                   e.g. !ssz Program Files
                        !ssz Windows
                        !ssz -s @rsp -e @rsp+1000 User

=========================================================================================
  !dtr           - Equivalent of dt for each valid register
 
  !dtr [args]
  !dtr           - Lists registers that point to an address; includes class type
  !dtr <arg>     - Equivalent of dt @reg <arg> for each valid register
                     !dtr <arg> --> dt @reg <arg>

                   e.g. !dtr
                        !dtr nt!_ERESOURCE
                        !dtr nt!_ERESOURCE Flag

=========================================================================================
  !grep          - Only shows lines which contain <search>
                 - Search is case insensitive
                 - Lines are delimited by newline ('\n')
                 - !grep can be chained

  !grep <search> <command>

                   e.g. !grep days vertarget
                        !grep call u @eip
                        !grep dt !dpx
                        !grep dt !grep DUser !dpx

  !ungrep        - Same as !grep but exclusion

-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
  !bold          - Highlight the lines which contain <search>
                 - Search is case insensitive
                 - Lines are delimited by newline ('\n')

  !bold <search> <command>

                   e.g. !bold version vertarget
                        !bold call uf ntdll!RtlUserThreadStart

-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
  !head          - Display the first N bytes of a command
  !tail          - Display the last N bytes of a command

  !head <bytes> <command>
  !tail <bytes> <command>

=========================================================================================
  !ghostthreads  - Lists all threads; real or ghosts
  !gt            - Same as !ghostthreads

  !gt [command]  - If 'command' is specified, the command is run
                   for each thread, instead of the summary table.

                 - The following substitutions are made:
                   - $teb   - TEB Address
                   - $base  - Stack Base Address
                   - $limit - Stack Limit Address

                   e.g. !gt !teb $teb
                        !gt !dpx $base $limit

=========================================================================================
  !loadsos        - Runs #1
  !loadpsscor     - Runs #2
  !loadsosex      - Runs #3
  !loadspext      - Runs #4

  Define PDE_LOADCORDLL to change the default (at load)
                  0 = Disabled
                  1 = SOS (default)
                  2 = PSSCORx + SOSEX
                  3 = SOS + SOSEX
                  4 = SOS + SOSEX + SPEXT 

=========================================================================================
  !comment        - Display the dump's comment (with DML)

  !notes          - Executes commands based on the dump type - starts your case notes
  !exr            - Executes commands based on the exception code (.exr -1)

  !line           - Print a line
  !bigline        - Print three big lines

  !du <addr>      - Display a UNICODE string (up to 4Gb)
  !da <addr>      - Display a ANSI string (up to 4Gb)
  !err <code>     - Display an Error Code
  !guid <addr>    - Display a GUID

  !url <url>      - Open a url; use !ext.url instead

  !kr             - knL printed upside down so WinDiff works better

  !dtr            - Displays Data Types in Registers
  !msr            - Displays the Model-Specific Registers (MSR)

  !stowedexceptions
                  - Display the Stowed Exceptions of a Store app
  !dse            - Same as !stowedexceptions
  !bgtask         - Display the Background Tasks of a Store app

  !symsrvaudit    - Display the SRV status of each lookup made during the command
                  - Command defaults to ".reload /f"

  !diadumptables <module>
                  - Dump the DIA Tables and Assembly Information of the specified Module
  !diadumpsymbols <module>
                  - Dump the DIA Symbol Table (Functions) of the specified Module

  !dbgp           - Dump a DBGP ACPI table
  !dbg2           - Dump a DBG2 ACPI table
  !msdm           - Dump a MSDM ACPI table
  !slic           - Dump a SLIC ACPI table

  !dmem           - Display the Memory Regions of a User Mode dump
  !vmem           - Display the Virtual Regions of a User Mode process

  !streams        - List the MiniDump Streams in a User Mode dump
  !streamhex <N>  - Dump a MiniDump Stream in a User Mode dump as HEX
  !streamtext <N> - Dump a MiniDump Stream in a User Mode dump as TEXT

  !tags [GUID]    - List the GUID and Size of the secondary callback chunks
  !tagshex <GUID> - List the GUID and Size of the secondary callback chunks, and dump in HEX
  !tagstext <GUID>- List the GUID and Size of the secondary callback chunks, and dump in TEXT

  !crashtask      - Enable crashdump support on the current (modern) process

  !dml            - Toggle .prefer_dml
  !dmlraw         - Print DML output as TEXT (used to review DML)

  !help           - Displays the help for all commands

=========================================================================================
  -- Defaults -- 
  DML On          - .prefer_dml 1
  UNICODE On      - .enable_unicode 1
  Ignore Pages On - .ignore_missing_pages 1
  Lines Disabled  - .lines -d

  -- Aliases -- 
  symoff          - .outmask- 0x200
  symon           - .outmask+ 0x200
  dml             - !PDE.dml
  av              - !ext.analyze -nodb -v
  avv             - !ext.analyze -nodb -v6
  ax              - !ext.analyze -nodb -xml
  axv             - !ext.analyze -nodb -xml -xcs -xmi
  axs             - !ext.analyze -nodb -xsd
  show            - !ext.analyze -show
  sn              - !sym noisy
  sq              - !sym quiet
  rf              - .reload /f
  ru              - .reload /u

=========================================================================================



Hypervisor:
==========
http://hvinternals.blogspot.com/2021/01/hyper-v-debugging-for-beginners-2nd.html

The decrypted dump with hypervisor state is at \\dazhan-dew\in\hypervisor\decrypted.dmp. 
From there, .load hvexts.dll (grab it from bin\dbg\files\bin\winext\hvexts.dll) and 
do !parsedump to switch to the hypervisor view.
Processor 2 is the one that hit the page fault, and you'll have to do
?? KdDummyProcess.DirectoryTableBase[0] = KepProcessorRegions[2]->PageTableRoot
.process @@(&KdDummyProcess)
That shows a partial stack up to the first trap. From there, look at the trap frame and 
dump k = rsp rip 40 to walk past the trap frame.

2: kd> !hvexts.help
Commands for W:\Tools\mexdbg\hvexts.dll:


======================================================================


Truncate memory:
https://www.geoffchappell.com/notes/windows/boot/bcd/library/truncatememory.htm
> bcdedit /set truncatememory 0x400000000


FDO_DATA:
dt 0xffffc60706116f40 SurfaceSystemTelemetryDriver!_FDO_DATA

Break on Driver Load:
0: kd> bu SurfaceBattery!DriverEntry "gu; !drvobj \Driver\SurfaceBattery 2"

0: kd> !drvobj SurfaceBattery
Driver object (ffff9b0e6a80ae10) is for:
Loading symbols for fffff800`477b0000     Wdf01000.sys ->   Wdf01000.sys
 \Driver\SurfaceBattery
Driver Extension List: (id , addr)
(fffff80047805620 ffff9b0e6721aa40)  
Device Object list:
ffff9b0e673319a0  

0: kd> !devobj ffff9b0e673319a0
Device object (ffff9b0e673319a0) is for:
  \Driver\SurfaceBattery DriverObject ffff9b0e6a80ae10
Current Irp 00000000 RefCount 0 Type 00000022 Flags 00002004
SecurityDescriptor ffff898bb30573e0 DevExt ffff9b0e6a727350 DevObjExt ffff9b0e67331b18 
ExtensionFlags (0x00000800)  DOE_DEFAULT_SD_PRESENT
Characteristics (0x00000100)  FILE_DEVICE_SECURE_OPEN
AttachedTo (Lower) ffff9b0e6734b840Loading symbols for fffff800`4de30000 SurfaceIntegrationDriver.sys ->   SurfaceIntegrationDriver.sys
 \Driver\SurfaceIntegrationDriver
Device queue is not busy.

0: kd> dt SurfaceBattery!_FDO_DATA ffff9b0e6a727350
   +0x000 WdfDevice        : 0x000064f1`958d8f98 WDFDEVICE__
   +0x008 ClassHandle      : 0xffff9b0e`6ad76d30 Void
   +0x010 ClassInitLock    : 0x000064f1`98d15b48 WDFWAITLOCK__
   +0x018 WmiLibContext    : _WMILIB_CONTEXT
   +0x058 StateLock        : 0x000064f1`98d14728 WDFWAITLOCK__
   +0x060 NotificationsLock : 0x000064f1`98d34338 WDFSPINLOCK__
'ist' is not recognized as an internal or external command,
operable program or batch file.


3: kd> !winde.help

==================
Help for WinDE.dll
==================

!WinDE.<command> -?  - Detailed help for the command

Alphabetical list of Kernel-Mode WinDE commands:

!WinDE.activity      =  Check the System activity for numerous common hang symptoms
!WinDE.afdendp       =  List AFD endpoints
!WinDE.blocks        =  Dump ERESOURCE locks with waiters, and waiter/owner threads
!WinDE.bits          -  Displays the potential values of a single bit flip for an address
!WinDE.calls         =  Search call stacks for string(s)
!WinDE.clusdsks      -  Enumerates the Cluster disks on a node
!WinDE.critlist      =  List Critical Sections, owners, and threads waiting on them
!WinDE.cx            =  Dump CRITICAL_SECTION lock, and its waiter/owner threads
!WinDE.debug         =  display current WinDE debug settings, and optionally set debug flags
!WinDE.diskq         =  list DISK devices with queued IO, or one device's IO queue
!WinDE.dtpool        -  Reads pool allocation and attempts to determine type
!WinDE.eflags        -  Displays flags from the eflags register
!WinDE.er            =  Dump ERESOURCE lock, and its waiter/owner threads
!WinDE.evtlog        =  Locate event log file data in memory
!WinDE.exe           =  Find processes with EXE names containing the given string
!WinDE.exq           =  Scan Executive Work Queues for active threads and queued work items
!WinDE.exqi          =  List Executive Work Queue queued work items for the given queue
!WinDE.filedevice    -  more details about handles
!WinDE.findfile      -  Searches Nonpaged pool for File objects matching search string
!WinDE.findhandle    -  Searches for open handles to a given object
!WinDE.findsvc       =  Find services with names containing the given string
!WinDE.fm            =  Dump FAST_MUTEX lock, and its waiter/owner threads
!WinDE.gdihandle     -  Dumps GDIHandleCount and UserHandleCount for each process
!WinDE.gettickcount  -  Get elapsed time since last input (keyboard/mouse)
!WinDE.gm            =  Dump KGUARDED_MUTEX lock, and its waiter/owner threads
!WinDE.go            =  Dump KGATE lock, and its waiter/owner threads
!WinDE.handles       =  Statistical analysis of handles in a process
!WinDE.handletype    -  more details about handles
!WinDE.hang          -  Hang analysis for the system
!WinDE.idle          =  Dump the Idle process (/D=more detail, /V=verbose)
!WinDE.info          =  display general information about the current debug session
!WinDE.io            =  Dump an IRP, and its associated event and file object
!WinDE.ioe           =  Shortcut for "!irpfind 0 0 userevent args"
!WinDE.ioq           =  List disk-related devices with stuck IO
!WinDE.ipconfig      -  Display Information for TCPIP Interfaces on the system
!WinDE.irps          =  Find all active IRPs, and display IRP count statistics
!WinDE.k             =  Dump and analyze a thread's stack
!WinDE.kp            =  Dump and analyze a thread's stack, with Parameters in DML
!WinDE.kpu           =  Dump and analyze a thread's stack, with Parameters in DML, and user symbols reload
!WinDE.ku            =  Dump and analyze a thread's stack, with user symbols reload
!WinDE.leak          =  Check the System for numerous common leak symptoms
!WinDE.lm            =  Dump LPC message, waiter thread, LPC process/thread, etc
!WinDE.lp            =  List process/thread times and handle counts, etc
!WinDE.lpcwait       =  List LPC server threads and connections waiting
!WinDE.lswn          -  Show information about the SRV Work Queues and allocated work items
!WinDE.mem           =  Display the top memory consumers
!WinDE.mod           =  Show module information
!WinDE.modref        =  Scan Modules for references to an address
!WinDE.mpioq         =  (beta) list MPIO devices with queued IO, or one device's IO queue
!WinDE.mu            =  Dump KMUTANT lock, and its waiter/owner threads
!WinDE.netstat       -  Display the valid endpoints on the system
!WinDE.objects       =  Show system Objects object and handle counts
!WinDE.objdir        =  Browse the Object Manager's Object Directory
!WinDE.pcrs          =  Dump all PCRs, and all Running and Standby threads
!WinDE.pl            =  Dump EX_PUSH_LOCK lock
!WinDE.poolfailures  =  Displays pool allocation failure statistics and reasons
!WinDE.poolref       =  Scan NonPaged pool for references to an address
!WinDE.pooltag       =  Show the pooltag for the pool block containing an address
!WinDE.pup           =  Shortcut for .Process adr;.reload /User;!Process adr 7
!WinDE.rdq           =  Scan Remote Desktop Work Queues for active threads and queued work items
!WinDE.rdy           =  List Ready threads
!WinDE.re            =  Dump RTL_RESOURCE lock, and its waiter/owner threads
!WinDE.regref        =  Show Registry key Reference counts
!WinDE.rootkit       =  Check for RootKit-style hooked system services
!WinDE.rpc           =  Show client information for an RPC message
!WinDE.rw            =  Dump RTL_SRWLOCK lock, and its waiter/owner threads
!WinDE.sessionview   -  Dumps Session View Space for the current session
!WinDE.shutdown      =  List shutdown-related data in WINLOGON
!WinDE.sl            =  Dump Kernel SpinLock
!WinDE.spl           =  List SPOOLSV Spooler/Printer/Driver/Port/Monitor/Job status
!WinDE.spltype       =  Dump a Spooler structure based on its embedded signature
!WinDE.srvendp       =  List Server service Endpoints
!WinDE.srvfiles      =  List Server service Files
!WinDE.srvsess       =  List Server service Sessions
!WinDE.srvshare      =  List Server service Shares
!WinDE.srvtrees      =  List Server service Tree connections
!WinDE.stax          =  Scan processes for thread stacks relevant to hung systems
!WinDE.svc           =  List SERVICES Service records
!WinDE.svq           =  Scan Server Work Queues for active threads and queued work items
!WinDE.t             =  Dump and analyze a thread
!WinDE.tcpip         =  Analyze TCPIP Port Pool usage
!WinDE.tu            =  Dump and analyze a thread, with user symbols reload
!WinDE.tag           =  Find pool tag string in loaded modules
!WinDE.ticks         =  Convert a decimal Elapsed Ticks value (e.g. from !thread) to HH:MM:SS.mmm
!WinDE.tix           =  Convert an Elapsed Ticks value in the current radix (usually hex) to HH:MM:SS.mmm
!WinDE.update        -  Check for (and update to) the latest version
!WinDE.vss           -  Display volume shadow copy information
!WinDE.waittime      -  Display wait times for all threads in all processes
!WinDE.watson        =  Find AeDebug Debugger process, and debug its parent
!WinDE.wsq           =  Scan Workstation Work Queues for active threads and queued work items
!WinDE.zp            =  List Zombie Processes - Process objects not in the active process list
!WinDE.zt            =  List Zombie Threads - Thread objects no longer in the active process thread lists
View help on WinDE commands relevant to:
     Strategy  Settings  Hangs  Leaks  Processes  Threads  IRPs  Services : EventLog  Spooler  Server  WinLogon  


Enable Tracing:

@echo off
cd %~dp0
set LOG_FILE=i2ctrace.etl
set LOG_TRACE=i2ctrace
set LOG_AUTO=autosession\

if exist %LOG_FILE% del %LOG_FILE%

logman create trace -n %LOG_AUTO%%LOG_TRACE% -ets -o %LOG_FILE% -nb 128 640 -bs 128
:: ACPI
logman update trace -n %LOG_AUTO%%LOG_TRACE% -ets -p Microsoft-Windows-Kernel-Acpi
:: ETW SPB Class Extension
logman update trace -n %LOG_AUTO%%LOG_TRACE% -ets -p Microsoft-Windows-SPB-ClassExtension
:: ETW SPB HID Class Extension
logman update trace -n %LOG_AUTO%%LOG_TRACE% -ets -p Microsoft-Windows-SPB-HIDI2C
:: ETW iaLPSS2_I2C
logman update trace -n %LOG_AUTO%%LOG_TRACE% -ets -p {C2F86198-03CA-4771-8D4C-CE6E15CBCA56}
:: WPP iaLPSS2_I2C
logman update trace -n %LOG_AUTO%%LOG_TRACE% -ets -p {FDB34DB7-9086-49EA-90C9-E3B3C7D35A64} 0xFFFFFFFF 0xFF
:: HidClass
logman update trace -n %LOG_AUTO%%LOG_TRACE% -ets -p {47c779cd-4efd-49d7-9b10-9f16e5c25d06} 0xFFFFFFFF 0x5
:: HidI2c(Wpp)
logman update trace -n %LOG_AUTO%%LOG_TRACE% -ets -p {e742c27d-29b1-4e4b-94ee-074d3ad72836} 0xFFFFFFFFFFFFFFFF 0x5
:: SpbCx(Wpp)
logman update trace -n %LOG_AUTO%%LOG_TRACE% -ets -p {e6086b4d-aeff-472b-bda7-eec662afbf11} 0xFFFFFFFFFFFFFFFF 0x5
:: ETW iaLPSS2_GPIO
logman update trace -n %LOG_AUTO%%LOG_TRACE% -ets -p {63848CFF-3EC7-4DDF-8072-5F95E8C8EB98}
:: WPP iaLPSS2_GPIO
logman update trace -n %LOG_AUTO%%LOG_TRACE% -ets -p {FEC7886E-AA65-449B-9944-5D12970C0864} 0xFFFFFFFF 0xFF

SetupApi Log levels:
===================
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Setup
most verbose: 0x2000FFFF


Memory Triage:
!lookaside ffffcbbf421b6040
4: kd> !pool ffffcbbf421b6050 1
4: kd> !pte ffffcbbf421b6050
4: kd> !pplookaside 
4: kd> !poolval ffffcbbf421b6050 3
4: kd> !poolused 7 -- dumps pool by all tags
4: kd> !poolfind Gla1
4: kd> !sysptes

NO_PAGES_AVAILABLE (4d)
No free pages available to continue operations.
If kernel debugger available "!vm 3".
4: kd> !vm 3

PTE of virtual address:
0: kd> !pte fffff80433039a80
                                           VA fffff80433039a80
PXE at FFFF8C4623118F80    PPE at FFFF8C46231F0080    PDE at FFFF8C463E010CC0    PTE at FFFF8C7C021981C8
contains 000000029FB0B063  contains 000000029FA0C063  contains 8A000001196009E3  contains 0000000000000000
pfn 29fb0b    ---DA--KWEV  pfn 29fa0c    ---DA--KWEV  pfn 119600    -GLDA--KW-V  LARGE PAGE pfn 119639      

contents of virtual address:
0: kd> db fffff80433039a80 L8
fffff804`33039a80  02 00 00 00 00 00 00 00                          ........

the following will invoke the MM to translate the PFN to VA (okay if RAM, not MMIO)
contents of physical address - use pfn and append last 12-bits of VA - pfn = 119639, 12-bits of VA = a80
0: kd> !db 119639a80 L8
#119639a80 02 00 00 00 00 00 00 00 ........p..2....


10: kd> !poolfind -tag "DFCI"
Scanning large pool allocation table for tag 0x49434644 (DFCI) (ffff9e0dfcc00000 : ffff9e0dfdc00000)
ffff9e0df5003000 : tag DFCI, size    0x3090, Nonpaged pool

4: kd> !memusage
 loading PFN database
  Usage Summary (in Kb):
Control       Valid Standby Dirty Shared Locked PageTables  name
3ffffffffe 453468      0     0     0 453468     0    AWE
ffffb9041a2784a0   492      0     0     0   492     0  mapped_file( wbiosrvc.dll )
4: kd> !ca ffffb9041a2784a0   

    
Summary:
!running -i -t
!sysinfo machineid
!exploitable -m
!deadlock
!heap -stat -h 0
!vm
!kah
!ocafences


Hardware Breakpoints:
https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/ba--break-on-access-
> ba e1 MyAddress

Deferred Breakpoint:
> bu <addr>

MSRs:
====
2: kd> dg 0040
                                                    P Si Gr Pr Lo
Sel        Base              Limit          Type    l ze an es ng Flags
---- ----------------- ----------------- ---------- - -- -- -- -- --------
0040 00000000`3abcf000 00000000`00000067 TSS32 Busy 0 Nb By P  Nl 0000008b

http://bsodtutorials.blogspot.com/2013/12/debugging-with-registers-part-3.html

2: kd> dg 0 0x58
                                                    P Si Gr Pr Lo
Sel        Base              Limit          Type    l ze an es ng Flags
---- ----------------- ----------------- ---------- - -- -- -- -- --------
0000 00000000`00000000 00000000`00000000 <Reserved> 0 Nb By Np Nl 00000000
0008 00000000`00000000 00000000`00000000 <Reserved> 0 Nb By Np Nl 00000000
0010 00000000`00000000 00000000`00000000 Code RE Ac 0 Nb By P  Lo 0000029b
0018 00000000`00000000 00000000`00000000 Data RW Ac 0 Bg By P  Nl 00000493
0020 00000000`00000000 00000000`ffffffff Code RE Ac 3 Bg Pg P  Nl 00000cfb
0028 00000000`00000000 00000000`ffffffff Data RW Ac 3 Bg Pg P  Nl 00000cf3
0030 00000000`00000000 00000000`00000000 Code RE Ac 3 Nb By P  Lo 000002fb
0038 00000000`00000000 00000000`00000000 <Reserved> 0 Nb By Np Nl 00000000
0040 00000000`3abcf000 00000000`00000067 TSS32 Busy 0 Nb By P  Nl 0000008b
0048 00000000`0000ffff 00000000`00008380 <Reserved> 0 Nb By Np Nl 00000000
0050 00000000`00000000 00000000`0000bc00 Data RW Ac 3 Bg By P  Nl 000004f3
0058 Unable to get descriptor

DML Reference:

4: kd> dx Debugger.State.Scripts
Debugger.State.Scripts                
4: kd> dx -r1 Debugger.State.Scripts
Debugger.State.Scripts                
4: kd> dx -r1 Debugger.Utility.Control
Debugger.Utility.Control                
    ExecuteCommand   [ExecuteCommand(command) - Method which executes a debugger command and returns a collection of strings representing the lines of output of the command execution]
    SetBreakpointAtSourceLocation [SetBreakpointAtSourceLocation(source_file, source_line, (opt) module_name) - Method which sets a breakpoint at a source line location and returns it as an object in order to be able to control its options]
    SetBreakpointAtOffset [SetBreakpointAtOffset(function_name, function_offset, (opt) module_name) - Method which sets a breakpoint at an offset and returns it as an object in order to be able to control its options]
    SetBreakpointForReadWrite [SetBreakpointForReadWrite(address, (opt) type, (opt) size) - Method which sets a breakpoint on read/write (default) at a certain address and returns it as an object in order to be able to control its options]
    ChangeRegisterContext [ChangeRegisterContext(inheritUnspecifiedValues, pc, sp, [fp], [regCtx]) | ChangeRegisterContext(inheritUnspecifiedValues, regCtx) - Changes the active register context with a given abstract pc, sp, and optional fp or an optional object which contains named registers and values.  This is largely equivalent to having done .cxr in the debugger.  It does *NOT* change the register values of the thread/processor, only the debugger's current view of them]
    WalkStackForRegisterContext [WalkStackForRegisterContext(inheritUnspecifiedValues, pc, sp, [fp], [regCtx]) | WalkStackForRegisterContext(inheritUnspecifiedValues, regCtx) - Performs a stack walk given the incoming abstract pc, sp, and optional fp or an optional object which contains named registers and values.  The returned stack walk is of the same form as <ThreadObject>.Stack]



ACPI device object correlation with ACPI device in !nstree
1: kd> !devstack 0xffffd9085b0507b0
  !DevObj           !DrvObj            !DevExt           ObjectName
  ffffd9085b5fcd90  \Driver\iactrllogicffffd908615d6700  
> ffffd9085b0507b0  \Driver\ACPI       ffffd908552ea8b0  00000070
!DevNode ffffd908615d6050 :
  DeviceInst is "ACPI\INT3472\1"
  ServiceName is "iactrllogic"

Note: the !DevExt of the ACPI device is the Device of the ACPI Device below:

| | | | ICL1 (ffffd90859390c30) - Device ffffd908552ea8b0
| | | | | _ADR (ffffd90859390ce0) - Integer - 0000000000000000
| | | | | _HID (ffffd90859390d90) - String - INT3472
| | | | | _CID (ffffd90859390e40) - String - INT3472
| | | | | _DDN (ffffd90859390ef0) - String - INCL-CRDD
| | | | | _UID (ffffd90859390fc0) - String - 1

PCI stuff:

1: kd> !devstack 0xffffd90855de8360
  !DevObj           !DrvObj            !DevExt           ObjectName
  ffffd9085b0bbd20  \Driver\iaLPSS2_I2C_ADLffffd9085abb77f0  0000004b
  ffffd90855ae6d50  \Driver\ACPI       ffffd90852310460  
> ffffd90855de8360  \Driver\pci        ffffd90855de84b0  NTPNP_PCI0017
!DevNode ffffd908556e8010 :
  DeviceInst is "PCI\VEN_8086&DEV_51EB&SUBSYS_72708086&REV_01\3&11583659&0&AB"
  ServiceName is "iaLPSS2_I2C_ADL"

1: kd> !devext
!devext [<address> <type>]
  <address> is the address of a device extension to
            be dumped.
  <type>    is the type of the object owning this extension:
            PCI if it is a PCI device extension
            ISAPNP if it is an ISAPNP device extension
            PCMCIA if it is a PCMCIA device extension
            HID if it is an HID device extension
1: kd> !devext ffffd908552ea460 ACPI
Device extension type 'ACPI' is not handled by !devext.
1: kd> !devext ffffd90855de84b0 PCI
PDO Extension, Bus 0x0, Device 15, Function 3.
  DevObj 0xffffd90855de8360  Parent FDO DevExt 0xffffd908556eb190
  Device State = PciStarted
  Vendor ID 8086 (INTEL CORPORATION)  Device ID 51EB
  Subsystem Vendor ID 8086 (INTEL CORPORATION)  Subsystem ID 7270
  Header Type 0, Class Base/Sub 0c/80  (Serial Bus Controller/Unknown Sub Class)
  Programming Interface: 00, Revision: 01, IntPin: 04, RawLine 2b
  Possible Decodes ((cmd & 7) = 7): BMI
  Capabilities: Ptr=80, power 
  Logical Device Power State: D3
  Device Wake Level:          Unspecified
  WaitWakeIrp:                <none>
  Requirements:     Alignment Length    Minimum          Maximum
    BAR0    Mem:    00001000  00001000  0000000000000000 ffffffffffffffff
  Resources:        Start            Length
    BAR0    Mem:    0000007ffeecb000 00001000
  Interrupt Requirement:
    Line Based - Min Vector = 0x0, Max Vector = 0xffffffff
  Interrupt Resource:    Type - Line Based, Interrupt Line = 0x2b
  Config space access log: !pcicfglog 0xffffd90855de84b0

PCI Space and Resource List:
http://yeilho.blogspot.com/2013/11/pci-config-space-with-windbg.html

0: kd> !devobj fffffa8009789a50  
 Device object (fffffa8009789a50) is for:  
  00000010 \Driver\PnpManager DriverObject fffffa80097560f0  
 Current Irp 00000000 RefCount 0 Type 00000004 Flags 00001040  
 Dacl fffff9a10010dd91 DevExt fffffa8009789ba0 DevObjExt fffffa8009789bb0 DevNode fffffa8009749010   
 ExtensionFlags (0x00000800) DOE_DEFAULT_SD_PRESENT  
 Characteristics (0x00000080) FILE_AUTOGENERATED_DEVICE_NAME  
 AttachedDevice (Upper) fffffa80097a34b0 \Driver\ACPI_HAL  
 Device queue is not busy.  

0: kd> !devnode fffffa8009749010 6  
 DevNode 0xfffffa8009749010 for PDO 0xfffffa8009789a50  
  Parent 0xfffffa8009782cb0  Sibling 0xfffffa800979bd30  Child 0xfffffa800970b010    
  InstancePath is "ROOT\ACPI_HAL\0000"  
  State = DeviceNodeStarted (0x308)  
  Previous State = DeviceNodeEnumerateCompletion (0x30d)  
  StateHistory[05] = DeviceNodeEnumerateCompletion (0x30d)  
  StateHistory[04] = DeviceNodeEnumeratePending (0x30c)  
  StateHistory[03] = DeviceNodeStarted (0x308)  
 [snip]  
  StateHistory[08] = Unknown State (0x0)  
  StateHistory[07] = Unknown State (0x0)  
  StateHistory[06] = Unknown State (0x0)  
  Flags (0x0c0001f5) DNF_MADEUP, DNF_HAL_NODE,   
            DNF_ENUMERATED, DNF_IDS_QUERIED,   
            DNF_HAS_BOOT_CONFIG, DNF_BOOT_CONFIG_RESERVED,   
            DNF_NO_RESOURCE_REQUIRED, DNF_NO_LOWER_DEVICE_FILTERS,   
            DNF_NO_LOWER_CLASS_FILTERS  
  DisableableDepends = 1 (from children)  
  BootResourcesList at 0xfffff8a000069ae0 Version 0.0 Interface 0 Bus #0  
   Entry 0 - Interrupt (0x2) Driver Exclusive (0x2)  
    Flags (0000) - LEVEL_SENSITIVE   
    Level 0, Vector 0, Group 0, Affinity 0xff  
    Range starts at 0x92 for 0x1 bytes  
   Entry 56 - Port (0x1) Driver Exclusive (0x2)  
    Flags (0x11) - PORT_MEMORY PORT_IO 16_BIT_DECODE   
    Range starts at 0xa0 for 0x2 bytes  
 [snip]  
    Range starts at 0xf0 for 0x10 bytes  
   Entry 59 - Port (0x1) Driver Exclusive (0x2)  
    Flags (0x11) - PORT_MEMORY PORT_IO 16_BIT_DECODE   
    Range starts at 0xcf8 for 0x8 bytes  
   Entry 60 - Memory (0x3) Driver Exclusive (0x2)  
    Flags (0000) - READ_WRITE   
    Range starts at 0x00000000fec00000 for 0x400 bytes  
 [snip]  

1: kd> !arbiter 1

DEVNODE ffffd601ae543c20 (HTREE\ROOT\0)
  Port Arbiter "RootPort" at fffff80450e444e0
    Allocated ranges:
      0000000000000000 - 0000000000000cf7    
        0000000000000000 - 0000000000000cf7 SC    ffffd601ae2c1ce0  (pci)
        0000000000000000 - 000000000000000f  CB   ffffd601ae297da0 
        0000000000000020 - 0000000000000021  CB   ffffd601ae297da0 
        0000000000000040 - 0000000000000043  CB   ffffd601ae297da0 
        0000000000000048 - 000000000000004b  CB   ffffd601ae297da0 
        0000000000000070 - 0000000000000071  CB   ffffd601ae297da0 
        0000000000000080 - 000000000000008f  CB   ffffd601ae297da0 
        0000000000000092 - 0000000000000092  CB   ffffd601ae297da0 
        00000000000000a0 - 00000000000000a1  CB   ffffd601ae297da0 
        00000000000000c0 - 00000000000000cf  CB   ffffd601ae297da0 
        00000000000000f0 - 00000000000000ff  CB   ffffd601ae297da0 
      0000000000000cf8 - 0000000000000cff   B   ffffd601ae297da0 
      0000000000000d00 - 000000000000ffff    
        0000000000000d00 - 000000000000ffff SC    ffffd601ae2c1ce0  (pci)
        0000000000001800 - 00000000000018fe  CB   ffffd601aef74ce0 
        0000000000002000 - 00000000000020fe  CB   ffffd601aef46ce0 
    Possible allocation:
      < none >

      DEVNODE ffffd601aef788a0 (ACPI\PNP0A08\0)
        Port Arbiter "PCI I/O Port (b=0)" at ffffd601aef8c1c0
          Allocated ranges:
            0000000000000020 - 0000000000000021   B   ffffd601aefeeb30 
            0000000000000024 - 0000000000000025   B   ffffd601aefeeb30 
            0000000000000028 - 0000000000000029   B   ffffd601aefeeb30 
            000000000000002c - 000000000000002d   B   ffffd601aefeeb30 
            000000000000002e - 000000000000002f   B   ffffd601aefeed60 
            0000000000000030 - 0000000000000031   B   ffffd601aefeeb30 
            0000000000000034 - 0000000000000035   B   ffffd601aefeeb30 
            0000000000000038 - 0000000000000039   B   ffffd601aefeeb30 
            000000000000003c - 000000000000003d   B   ffffd601aefeeb30 
            0000000000000040 - 0000000000000043   B   ffffd601aefe6ce0 
            000000000000004e - 000000000000004f   B   ffffd601aefeed60 
            0000000000000050 - 0000000000000053   B   ffffd601aefe6ce0 
            0000000000000061 - 0000000000000061   B   ffffd601aefeed60 
            0000000000000063 - 0000000000000063   B   ffffd601aefeed60 
            0000000000000065 - 0000000000000065   B   ffffd601aefeed60 
            0000000000000067 - 0000000000000067   B   ffffd601aefeed60 
            0000000000000070 - 0000000000000077    
              0000000000000070 - 0000000000000070  CB   ffffd601aefeed60 
              0000000000000070 - 0000000000000077  C    ffffd601aefe6ab0 
            0000000000000080 - 0000000000000080   B   ffffd601aefeed60 
            0000000000000092 - 0000000000000092   B   ffffd601aefeed60 
            00000000000000a0 - 00000000000000a1   B   ffffd601aefeeb30 
            00000000000000a4 - 00000000000000a5   B   ffffd601aefeeb30 
            00000000000000a8 - 00000000000000a9   B   ffffd601aefeeb30 
            00000000000000ac - 00000000000000ad   B   ffffd601aefeeb30 
            00000000000000b0 - 00000000000000b1   B   ffffd601aefeeb30 
            00000000000000b2 - 00000000000000b3   B   ffffd601aefeed60 
            00000000000000b4 - 00000000000000b5   B   ffffd601aefeeb30 
            00000000000000b8 - 00000000000000b9   B   ffffd601aefeeb30 
            00000000000000bc - 00000000000000bd   B   ffffd601aefeeb30 
            00000000000004d0 - 00000000000004d1   B   ffffd601aefeeb30 
            0000000000000680 - 000000000000069f   B   ffffd601aefeed60 
            0000000000000cf8 - 0000000000000cff       00000000 <Not on bus>
            000000000000164e - 000000000000164f   B   ffffd601aefeed60 
            0000000000001854 - 0000000000001857   B   ffffd601aef7b060 
            0000000000003000 - 000000000000303f     P ffffd601b204a360  (igfxn)
            0000000000010000 - ffffffffffffffff       00000000 <Not on bus>
          Possible allocation:
            < none >

1: kd> !devstack ffffd601b204a360
  !DevObj           !DrvObj            !DevExt           ObjectName
  ffffd601b301c030  \Driver\igfxn      ffffd601b301c180  
  ffffd601b2054cd0  \Driver\ACPI       ffffd601ae261010  
> ffffd601b204a360  \Driver\pci        ffffd601b204a4b0  NTPNP_PCI0001
!DevNode ffffd601b2050aa0 :
  DeviceInst is "PCI\VEN_8086&DEV_8A56&SUBSYS_00371414&REV_07\3&11583659&0&10"
  ServiceName is "igfxn"

1: kd> !devnode ffffd601b2050aa0 6
DevNode 0xffffd601b2050aa0 for PDO 0xffffd601b204a360
  Parent 0xffffd601aef788a0   Sibling 0xffffd601b203aaa0   Child 0xffffd601b3b03c70   
  InstancePath is "PCI\VEN_8086&DEV_8A56&SUBSYS_00371414&REV_07\3&11583659&0&10"
  ServiceName is "igfxn"
  State = DeviceNodeStarted (0x308)
  Previous State = DeviceNodeEnumerateCompletion (0x30d)
  StateHistory[01] = DeviceNodeEnumerateCompletion (0x30d)
  StateHistory[00] = DeviceNodeEnumeratePending (0x30c)
  StateHistory[19] = DeviceNodeStarted (0x308)
  StateHistory[18] = DeviceNodeEnumerateCompletion (0x30d)
  StateHistory[17] = DeviceNodeEnumeratePending (0x30c)
  StateHistory[16] = DeviceNodeStarted (0x308)
  StateHistory[15] = DeviceNodeEnumerateCompletion (0x30d)
  StateHistory[14] = DeviceNodeEnumeratePending (0x30c)
  StateHistory[13] = DeviceNodeStarted (0x308)
  StateHistory[12] = DeviceNodeEnumerateCompletion (0x30d)
  StateHistory[11] = DeviceNodeEnumeratePending (0x30c)
  StateHistory[10] = DeviceNodeStarted (0x308)
  StateHistory[09] = DeviceNodeEnumerateCompletion (0x30d)
  StateHistory[08] = DeviceNodeEnumeratePending (0x30c)
  StateHistory[07] = DeviceNodeStarted (0x308)
  StateHistory[06] = DeviceNodeStartPostWork (0x307)
  StateHistory[05] = DeviceNodeStartCompletion (0x306)
  StateHistory[04] = DeviceNodeStartPending (0x305)
  StateHistory[03] = DeviceNodeResourcesAssigned (0x304)
  StateHistory[02] = DeviceNodeDriversAdded (0x303)
  Flags (0x6c0000f0)  DNF_ENUMERATED, DNF_IDS_QUERIED, 
                      DNF_HAS_BOOT_CONFIG, DNF_BOOT_CONFIG_RESERVED, 
                      DNF_NO_LOWER_DEVICE_FILTERS, DNF_NO_LOWER_CLASS_FILTERS, 
                      DNF_NO_UPPER_DEVICE_FILTERS, DNF_NO_UPPER_CLASS_FILTERS
  CapabilityFlags (0x00400000)  
                                Unknown flags 0x00400000
  CmResourceList at 0xffffb00d86688970  Version 1.1  Interface 0x5  Bus #0
    Entry 0 - Memory (0x3) Device Exclusive (0x1)
      Flags (
      Range starts at 0x0000006001000000 for 0x1000000 bytes
    Entry 1 - DevicePrivate (0x81) Device Exclusive (0x1)
      Flags (
      Data - {0x00000001, 0000000000, 0000000000}
    Entry 2 - Memory (0x3) Device Exclusive (0x1)
      Flags (PREFETCHABLE 
      Range starts at 0x0000004000000000 for 0x10000000 bytes
    Entry 3 - DevicePrivate (0x81) Device Exclusive (0x1)
      Flags (
      Data - {0x00000001, 0x00000002, 0000000000}
    Entry 4 - Port (0x1) Device Exclusive (0x1)
      Flags (PORT_MEMORY PORT_IO 16_BIT_DECODE POSITIVE_DECODE 
      Range starts at 0x3000 for 0x40 bytes
    Entry 5 - DevicePrivate (0x81) Device Exclusive (0x1)
      Flags (
      Data - {0x00000001, 0x00000004, 0000000000}
    Entry 6 - Interrupt (0x2) Device Exclusive (0x1)
      Flags (LATCHED MESSAGE 
      Message Count 1, Vector 0xfffffff6, Group 0, Affinity 0
    
  BootResourcesList at 0xffffb00d80584120  Version 1.1  Interface 0x5  Bus #0
    Entry 0 - Memory (0x3) Device Exclusive (0x1)
      Flags (
      Range starts at 0x0000006001000000 for 0x1000000 bytes
    Entry 1 - Memory (0x3) Device Exclusive (0x1)
      Flags (PREFETCHABLE 
      Range starts at 0x0000004000000000 for 0x10000000 bytes
    Entry 2 - Port (0x1) Device Exclusive (0x1)
      Flags (PORT_MEMORY PORT_IO 16_BIT_DECODE POSITIVE_DECODE 
      Range starts at 0x3000 for 0x40 bytes
    
  

Secure mode debugging:
https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/activating-secure-mode

To activate Secure Mode, use one of the following methods:
The -secure command-line option
The .secure 1 command
The .symopt+0x40000 command

If you have an existing kernel debugging session and need to discover whether you are already in Secure Mode, use the .secure command with no arguments. This will tell you the current status of Secure Mode.

After Secure Mode has been activated, it cannot be turned off. Even ending the debugging session will not turn it off. Secure Mode persists as long as the debugger itself is running.

E820 Bios hibernation memory map:
!acpicache
0: kd> !acpicache
Dumping cached ACPI tables...
  XSDT @(fffff7d840005018) Rev: 0x1 Len: 0x0000e4 TableID: OEMID   
  MCFG @(fffff7d840006018) Rev: 0x1 Len: 0x00003c TableID: OEMID   
  FACP @(fffff7d84005a018) Rev: 0x6 Len: 0x000114 TableID: OEMID   
  APIC @(fffff7d84005b018) Rev: 0x5 Len: 0x0001dc TableID: OEMID   
  DMAR @(fffff7d84005d018) Rev: 0x2 Len: 0x000088 TableID: EDK2    
  HPET @(fffff7d84006a018) Rev: 0x1 Len: 0x000038 TableID: OEMID   
  FPDT @(ffffce89b37470b8) Rev: 0x1 Len: 0x000034 TableID: EDK2    
  NHLT @(ffffce89b36fe968) Rev: 000 Len: 0x0002f1 TableID: OEMID   
  LPIT @(ffffce89b36fec88) Rev: 0x1 Len: 0x000094 TableID: OEMID   
  SDEV @(ffffce89b36fed48) Rev: 0x1 Len: 0x0000b2 TableID: OEMID   
  SSDT @(ffffce89b37f7018) Rev: 0x2 Len: 0x005d2c TableID: CpuSsdt
  WSMT @(ffffce89b36fee28) Rev: 0x1 Len: 0x000028 TableID: OEMID   
  SSDT @(ffffce89b3747228) Rev: 0x2 Len: 0x000574 TableID: Tpm2Tabl
  TPM2 @(ffffce89b37477c8) Rev: 0x3 Len: 0x000034 TableID: EDK2    
  SSDT @(ffffce89b3bdd018) Rev: 0x2 Len: 0x003aea TableID: SocGpe 
  SSDT @(ffffce89b3be1018) Rev: 0x2 Len: 0x0039da TableID: SocCmn 
  SSDT @(ffffce89b37fd018) Rev: 0x2 Len: 0x0011a0 TableID: SsdtSurf
  SSDT @(ffffce89b3be5018) Rev: 0x2 Len: 0x002b22 TableID: SaSsdt 
  SSDT @(ffffce89b3be8018) Rev: 0x2 Len: 0x0033d3 TableID: IgfxSsdt
  SSDT @(ffffce89b38f6018) Rev: 0x2 Len: 0x0087cf TableID: TcssSsdt
  SSDT @(ffffce89b38fe818) Rev: 0x2 Len: 0x0007b8 TableID: SsdtPld 
  SSDT @(ffffce89b3beb418) Rev: 0x2 Len: 0x0004a9 TableID: SsdtPmi 
  SSDT @(ffffce89b39c5018) Rev: 0x2 Len: 0x001513 TableID: RTD3    
  BGRT @(ffffce89b39c6668) Rev: 0x1 Len: 0x000038 TableID: EDK2    
  DBG2 @(ffffce89b39c66c8) Rev: 000 Len: 0x00005d TableID: OEMID   
  DSDT @(ffffce89b39cb018) Rev: 0x2 Len: 0x029daf TableID: ADL     

!ioreslist - from devnode 
!cmreslist

BIOS Version:
1: kd> !gbl
Good Bios List Entry --- Machine BIOS Date 
[OEMELOEMEL]
AcpiOemId="FACP","OEMEL "
AcpiOemTableId="FACP","OEMEL   "
AcpiOemRevision=">=","FACP",0
AcpiRevision=">=","FACP",6
AcpiCreatorRevision=">=","FACP",20191121

Common BugChecks:
101         stops processing WD irqs, disable C-states
124         whea !errrec
9F          power irp deadlock/timeout (pnp overlap)
0A, D1, 50  memory corruption, s/w bug, use verifier
7A/77       !storagekd.storclass [2] in page error
EF          crit proc except - can be storage paging errors see (7A/77)
116         TDR 2ms Gfx T/O - chk evt logs for correctable machine chks
133, 102    DPC wdog
1E, 1E, 7F  execution of garbage code

documentation:
kd> !analyze -show <BC num> --- will display format 

Training Tips - BEGIN:
\\wosext2.amr.corp.intel.com\training\Nonsla

.frame /r 3 --> frame specific registers
gu - go up to caller
pct - runs to next call or return
on x64 proc - call convention (ABI) use 4 regs then stack: rcx, rdx, r8, r9
ln <addr> --> find nearest symbol
.format <n> -- show n in all numeric and date/time formats
.lastevent
.bugcheck
du <address> -- dumps unicode string
!kuser -- get the user shared data pointer
.process /p /r <proc addr> --- sets context to process
## remember 1st 4 parameters are in registers (ecx, edx, r8, r9) (not on stack)

ACPI Tables for non-PNP devices
BCD HKLM\BCD00000000 ->     boot cfg database
3: kd> !reg querykey \REGISTRY\MACHINE\
Found KCB = ffffaf0b80edbc20 :: \REGISTRY\MACHINE
Hive         ffffaf0b80e77000
KeyNode      ffffaf0b80edc16c
[SubKeyAddr]         [SubKeyName]
ffffaf0b80edc4a4     BCD00000000
ffffaf0b80edc74c     DRIVERS
ffffaf0b80edc3cc     HARDWARE
ffffaf0b80edc59c     SAM
ffffaf0b80edc504     SECURITY
ffffaf0b80edc374     SOFTWARE
ffffaf0b80edc31c     SYSTEM


mountvol /s x:
boot mgr: CR0.PE=1 (Prot Mode), CR0.PG=1 (Paging enabled)

Tool: dependency walker - load ntoskrnl.exe
sigcheck -> gets version info and description

\Windows\System32\config\SYSTEM (system hive)

winload.efi (bootmgr) - Exit boot services -> ntos
Visual studio tools prompt: -> ~System32> link -dump ntoskrnl.exe

LOADER_PARAMETER_BLOCK passed to ntoskrnl - list of modules to load
kd> !dh nt -> section header
dt nt!_*LOADER*BLOCK*
dt nt!_LOADER_PARAMETER_BLOCK <addr>

CSRSS: is the Windows subsystem

kernel init phases:
0: logo splash
1: iomgr, pnp, pm, services
2: boot drivers, pnnp discovery, 1st user process (SMSS.exe sess mgr) 

shutdown:
NtShutdownSystem -> NtSetSystemPowerState

ACPI sleep control registers:
!fadt -- ACPI table
PM1 and PM2 Control Blocks have values stored from
!amli find _S5
!amli dns /v \_S5
!amli dns /v \_S4
!amli dns /v \_S3
these values get stored in the PMx control blocks during sleep state

The event log chronicles the most recent 150 events that occurred in the interpreter.
Here is an example of the log display:
kd> !amli dl
RUN!: [c15a6618]QTh=00000000,QCt=00000000,QFg=00000000: Ctx=c18b4000,rc=0
KICK: [c15a6618]QTh=00000000,QCt=00000000,QFg=00000000: rc=0
SYNC: [c15a6618]QTh=00000000,QCt=00000000,QFg=00000002,LockPhase=0,Locked=0,IRQL=00: Obj=\_WAK
ASYN: [c15a6618]QTh=00000000,QCt=00000000,QFg=00000002,LockPhase=0,Locked=0,IRQL=00: Obj=\_WAK
REST: [c15a6618]QTh=00000000,QCt=00000000,QFg=00000002: Ctx=c18b4000,Obj=\_WAK
INSQ: [c15a6618]QTh=00000000,QCt=00000000,QFg=00000002: Ctx=c18b4000,Obj=\_WAK
EVAL: [c15a6618]QTh=00000000,QCt=00000000,QFg=00000002: Ctx=c18b4000,Obj=\_WAK
RUNC: [c15a6618]QTh=c15a6618,QCt=c18b4000,QFg=00000002: Ctx=c18b4000,Obj=\_WAK

!amli display string buffer
| | TZ03 (ffffa0828ec1ed10) - Device ffffa0828bbdf010
| | | _STR (ffffa0828ec1ee40) - Buffer - 8ec1ee20 L=000a

2: kd> !amli dns ffffa0828ec1ee40
ACPI Name Space: \_SB.TZ03._STR (ffffa0828ec1ee40)
Buffer(_STR:Ptr=ffffa0828ec1ee20,Len=10){
    0x52,0x00,0x54,0x00,0x53,0x00,0x33,0x00,0x00,0x00}

2: kd> dc ffffa0828ec1ee20
ffffa082`8ec1ee20  00540052 00330053 00000000 00000000  R.T.S.3.........


tool: procmon - enable boot monitoring
reboot - open procmon - smss.exe
process tree

!process 0 0 notepad.exe
!process x 4 --> lists threads
dt nt!_KTHREAD X Affinity

CPU KPCR
!pcr <N> -> gs:0 = KPCR via MSR
db gs:0 = KPCR addr

!idt -a --> dumps entire IDT
dt nt!_KDPC
!dpcs -- pending DPCs
prefer .frame /r <N> over .trap <X> -- better registers
!swd -- s/w watchdog status for DPCs

APC: callback run in specific thread to crack it into context for buffer copy.

Secure Kernel:
vtl0 (normal) /1 (secure) - virtual trust level, implemented by HyperV

Training Tips - END

Camera:
x iacamera64!used_mem_list = struct _LIST_ENTRY [ 0xffff9705`ffea2250 - 0xffff9706`00b6cd00 ]
x iacamera64!free_mem_list = struct _LIST_ENTRY [ 0xffff9706`148ebe50 - 0xffff9706`148e4050 ]
0: kd> !list "-t nt!_LIST_ENTRY.Flink -e -x \"dt iacamera64!_memory_range @$extret host_addr vied_addr vtl1_buffer_guid page_addr actual_size\" 0xffff9705`ffea2250"

Bugchecks:

KMODE_EXCEPTION_NOT_HANDLED (1e)
================================
This is a very common bugcheck.  Usually the exception address pinpoints
the driver/function that caused the problem.  Always note this address
as well as the link date of the driver/image that contains this address.
Arguments:
Arg1: ffffffffc0000002, The exception code that was not handled
Arg2: fffff8036072ebdf, The address that the exception occurred at
Arg3: 0000000000000000, Parameter 0 of the exception
Arg4: 0000000000000000, Parameter 1 of the exception

STACK_TEXT:  
3: kd> kv
 # Child-SP          RetAddr               : Args to Child                                                           : Call Site
00 ffffbf8e`31076488 fffff803`609392aa     : 00000000`0000001e ffffffff`c0000002 fffff803`6072ebdf 00000000`00000000 : nt!KeBugCheckEx
01 ffffbf8e`31076490 fffff803`60833ebf     : ffffbf8e`31076cb0 ffffbf8e`31076560 fffff803`60400000 fffff803`6082da4e : nt!HvlpVtlCallExceptionHandler+0x22
02 ffffbf8e`310764d0 fffff803`6060fac3     : ffffbf8e`310778f0 ffffbf8e`31077210 fffff803`6082da4e fffff803`604e9ca8 : nt!RtlpExecuteHandlerForException+0xf
03 ffffbf8e`31076500 fffff803`6060f72d     : 00000000`00000000 ffffbf8e`310771b0 00000000`00000000 ffffbf8e`31077210 : nt!RtlDispatchException+0x2f3
04 ffffbf8e`31076c70 fffff803`6072ebdf     : 00000000`c0000001 ffffe58b`50930950 ffff9a80`95911180 ffffbf8e`31077a38 : nt!RtlRaiseException+0x10d
05 ffffbf8e`310771f0 fffff803`609fac8e     : ffffe58b`509308a0 00000000`00000001 ffff9a80`95911180 fffff803`5b599600 : nt!RtlRaiseStatus+0x4f
06 ffffbf8e`31077790 fffff803`606bb72b     : ffffe58b`50930910 00000000`00000000 ffffbf8e`31077a38 00000000`00000000 : nt!purecall+0xe
07 ffffbf8e`310777c0 fffff803`606bcea6     : 00000000`000004c0 ffffbf8e`310779f0 ffffe58b`3cb1a040 00000000`00035223 : nt!KiProcessExpiredTimerList+0x1eb
08 ffffbf8e`310778f0 fffff803`6082da4e     : 00000000`00000000 ffff9a80`95911180 ffffe58b`3cb1a040 ffffe58b`48639080 : nt!KiRetireDpcList+0xed6
09 ffffbf8e`31077b80 00000000`00000000     : ffffbf8e`31078000 ffffbf8e`31071000 00000000`00000000 00000000`00000000 : nt!KiIdleLoop+0x9e

https://learn.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-exception_record
3: kd> dt nt!_EXCEPTION_RECORD ffffbf8e`31077210
   +0x000 ExceptionCode    : 0n-1073741822
   +0x004 ExceptionFlags   : 0x81
   +0x008 ExceptionRecord  : (null) 
   +0x010 ExceptionAddress : 0xfffff803`6072ebdf Void
   +0x018 NumberParameters : 0
   +0x020 ExceptionInformation : [15] 0

3: kd> .frame /r 5
05 ffffbf8e`310771f0 fffff803`609fac8e     nt!RtlRaiseStatus+0x4f
rax=0000000000000000 rbx=00000000c0000001 rcx=000000000000001e
rdx=ffffffffc0000002 rsi=ffffe58b50930950 rdi=ffff9a8095911180
rip=fffff8036072ebdf rsp=ffffbf8e310771f0 rbp=ffffbf8e31077889
 r8=fffff8036072ebdf  r9=0000000000000000 r10=0000000000000000
r11=ffffbf8e310764d0 r12=0000000000000001 r13=ffffbf8e31077a30
r14=ffffbf8e31077a38 r15=0000000000000080
iopl=0         nv up ei ng nz na po nc
cs=0010  ss=0018  ds=002b  es=002b  fs=0053  gs=002b             efl=00000286
nt!RtlRaiseStatus+0x4f:
fffff803`6072ebdf 80c3ff          add     bl,0FFh

VPU Debug:
=========
use vpu kd: vpudriver-29.0.10.395-RelWithDebInfo\RelWithDebInfo\tools\x64\ivdkmdbgextn\ivdkmdbgextn.dll
!commands
!bufdbgshowmsgs
!vpubugchecksummary
force dump on TDR:
reg add "HKLM\System\CurrentControlSet\Control\GraphicsDrivers" /v "TdrLevel" /t REG_DWORD /d 1 /f

============= Session 10 Training BEGIN =================
DPC_WATCHDOG_VIOLATION (133)
The DPC watchdog detected a prolonged run time at an IRQL of DISPATCH_LEVEL or above.
Arguments:
Arg1: 0000000000000000, A single DPC or ISR exceeded its time allotment. The offending
    component can usually be identified with a stack trace.
Arg2: 0000000000000501, The DPC time count (in ticks).
Arg3: 0000000000000500, The DPC time allotment (in ticks).
Arg4: fffff8035351c340, cast to nt!DPC_WATCHDOG_GLOBAL_TRIAGE_BLOCK, which contains

Timers: !time -- current time
default timeouts
DPC = 20 sec
IRQ = 2 min
repro faster by shortening these timeouts
the times in the bugcheck are cumulative
!swd --> DCP Count = 0 !! this is the culprit
kv
kPnL
!idt -a // shows all IDTs
dt nt!_KINTERRUPT <addr>
!irql -- shows save IRQL
kv -> find trap frame back in time leading up to the timer timeout
what happened @timer irq
!thread -- how long was thread running

TLBs flushes all CPUs via IPI (and waits for resp)
  finding outstanding IPIs?
> !ipi -- very cool!!
> !ipi -v -- verbose
IPI State for Processor 0
    TargetCount          0  PacketBarrier        0  IpiFrozen     2 [Frozen]
...
IPI State for Processor 11
    TargetCount          0  PacketBarrier        0  IpiFrozen     0 [Running]

Ipi Cmd:
11: kd> !apic
Apic (x2Apic mode)  ID:67624d30 (67624d30)  LogDesc:67624d30  TPR 67624D30
TimeCnt: 67624d30clk  SpurVec:30  FaultVec:67624d30  error:67624d30
Ipi Cmd: 00007ffd`f0c297a5  Vec:A5  ExtINTA   Ph:00007FFD-Pend lvl high       
Timer..: 00000000`67624d30  Vec:30  RESET       Dest=Self      edg high rirr  
Linti0.: 00000000`67624d30  Vec:30  RESET       Dest=Self      edg high rirr  
Linti1.: 00000000`67624d30  Vec:30  RESET       Dest=Self      edg high rirr  
TMR: 03, 05, 0E, 11, 13-14, 17, 1C-1f, 23, 25, 2E, 31, 33-34, 37, 3C-3f, 43, 45, 4E, 51, 53-54, 57, 5C-5f, 63, 65, 6E, 71, 73-74, 77, 7C-7f, 83, 85, 8E, 91, 93-94, 97, 9C-9f, A3, A5, AE, B1, B3-b4, B7, BC-bf, C3, C5, CE, D1, D3-d4, D7, DC-df, E3, E5, EE, F1, F3-f4, F7, FC-ff
IRR: 03, 05, 0E, 11, 13-14, 17, 1C-1f, 23, 25, 2E, 31, 33-34, 37, 3C-3f, 43, 45, 4E, 51, 53-54, 57, 5C-5f, 63, 65, 6E, 71, 73-74, 77, 7C-7f, 83, 85, 8E, 91, 93-94, 97, 9C-9f, A3, A5, AE, B1, B3-b4, B7, BC-bf, C3, C5, CE, D1, D3-d4, D7, DC-df, E3, E5, EE, F1, F3-f4, F7, FC-ff
ISR: 03, 05, 0E, 11, 13-14, 17, 1C-1f, 23, 25, 2E, 31, 33-34, 37, 3C-3f, 43, 45, 4E, 51, 53-54, 57, 5C-5f, 63, 65, 6E, 71, 73-74, 77, 7C-7f, 83, 85, 8E, 91, 93-94, 97, 9C-9f, A3, A5, AE, B1, B3-b4, B7, BC-bf, C3, C5, CE, D1, D3-d4, D7, DC-df, E3, E5, EE, F1, F3-f4, F7, FC-ff
    

> ~2; r; k
!pcr -> if curr == idle thread then non-responsive
!smt -- shows virtual / physical CPUs

-----------
find who is trying to acquire spinlock?
.cxr
!running -it -- owner of spinlock should be running
!cpuinfo -- shows how many CPUs
1: kd> !cpuinfo
CP  F/M/S Manufacturer  MHz PRCB Signature    MSR 8B Signature Features
 0  6,190,0 GenuineIntel  998 0000000f00000000                   311b3fff
 1  6,190,0 GenuineIntel  998 0000000f00000000                   311b3fff
 2  6,190,0 GenuineIntel  998 0000000f00000000                   311b3fff
 3  6,190,0 GenuineIntel  998 0000000f00000000                   311b3fff
                      Cached Update Signature 0000000f00000000
                     Initial Update Signature 0000000f00000000
!pcr N (if curr == idle thread) then idle
.ignore_missing_pages 1
.cxr
maybe sharing w/DPC
which ISR? uf KiCallIsr find calls to [? edi + X]
.frame /r N
u poi(addr of ISR) L1
maybe [edi] is a _KINTERRUPT? 
dt nt!_KINTERRUPT <addr in edi>
    see vector and look at !idt -a output
!idt <vector> shows driver
or ServiceContext addr in _KINTERRUPT
!wdfkd.wdfobject <ServiceContext addr> --> shows device
!devstack <device>

============= Session 10 Training END =================

============= Session 11 Training BEGIN =================

Bug check 0xA: IRQL_NOT_LESS_OR_EQUAL
valid = 0 or invalid address
!irql
!pte <addr> -- valid?
u <addr>
pageable code?
!dh <addr of executable> e.g. !dh nt
    find offset from nt and find section virtual address of !dh

----------------
Bug check 0xA: IRQL_NOT_LESS_OR_EQUAL
!pte <mem ref'd>
r cr2
dt nt!_KDPC <addr in register?>
.frame /r N
try .formats <N>
timers?
!timer -- check list of timers for time addr (maybe paged out)
!verifier -?
!verifier 80 <timer addr> -- who freed it? --> gives the thread

-----------------
object manager
!object X
dt nt!_KMUTANT
r rip=N

============= Session 11 Training END =================

============= Session 12 Training BEGIN =================
objects -> ref counted -> view in process explorer and winobj
!peb -- shows DLLs loaded in process
.process /r /p <proc addr>
!peb (no args after .process)

Critical Processes:
dt nt!_EPROCESS Flags => BreakOnTermination = 1

bit diff: XOR ^
trustlets = secure process VTL1
VTL0 normal kernel

----------------
Bug check 0xEF: CRITICAL_PROCESS_DIED
get proc addr
dt nt!_EPROCESS <proc addr> => Flags.BreakOnTermination = 0y1
> kn --> show lots of frames
!pte
!teb -- stack base limit overflow?

paging failures - see storagekd.help -> storclass 2
see failed scsi requests and packets w/dual IRPs

============= Session 12 Training END =================

============= Session 13 Training BEGIN =================
Call conventions:
32-bit:
    push ebp -- return address
    mov ebp,esp -- then stores current SP into BP
    ebp is like a linked list, pointing to prev ebp & value after is return addr
    dps @ebp L2
    debuggers can walk the ebp chain
    +offsets == point to passed in parms
    -offsets == point to local vars

64-bit:
    eip is used to determine the function (needs symbols)
    sub rsp,70h (e.g.) determine stack frame alloc from symbols
    adds to rsp for return address
    repeat

!teb --> stack stuff (for overruns)

Idle CPUs:
    intelppm!MWaitIdle
        mwait rax,rcx --> puts CPU in C-state
        
Note: halt => C1 state

Soft affinity == Ideal Processor => warm cache

!process 0 0 notepad.exe
!process 0 0 csrss.exe
try setting BreakOnTerminate in _EPROCESS and exit notepad -- it will break into debugger

ba w 8 <addr> -- break on 8-byte write access

============= Session 13 Training END =================

============= Session 14 Training BEGIN =================

Waitable objects: _DISPATCHER_HEADER
0: kd> dt nt!_DISPATCHER_HEADER WaitListHead
   +0x008 WaitListHead : _LIST_ENTRY -> WAIT_BLOCK
        links object to wait block

0: kd> dt nt!_KEVENT
   +0x000 Header           : _DISPATCHER_HEADER
0: kd> dt nt!_KMUTANT
   +0x000 Header           : _DISPATCHER_HEADER
   +0x018 MutantListEntry  : _LIST_ENTRY
   +0x028 OwnerThread      : Ptr64 _KTHREAD
   +0x030 MutantFlags      : UChar
   +0x030 Abandoned        : Pos 0, 1 Bit
   +0x030 Spare1           : Pos 1, 7 Bits
   +0x030 Abandoned2       : Pos 0, 1 Bit
   +0x030 AbEnabled        : Pos 1, 1 Bit
   +0x030 Spare2           : Pos 2, 6 Bits
   +0x031 ApcDisable       : UChar

_KMUTANT has ownership -> thread
Threads/Processes wait on Termination
Files waited on for I/O termination
signaled state

0: kd> dt nt!_KWAIT_BLOCK
   +0x000 WaitListEntry    : _LIST_ENTRY
   +0x010 WaitType         : UChar
   +0x011 BlockState       : UChar
   +0x012 WaitKey          : Uint2B
   +0x014 SpareLong        : Int4B
   +0x018 Thread           : Ptr64 _KTHREAD
   +0x018 NotificationQueue : Ptr64 _KQUEUE
   +0x018 Dpc              : Ptr64 _KDPC
   +0x020 Object           : Ptr64 Void
   +0x028 SparePtr         : Ptr64 Void

   links WB to object

KWAIT_BLOCK (WB) has a Thread and an Object
_KTHREAD has a WaitBlockList
0: kd> dt nt!_KTHREAD
   +0x000 Header           : _DISPATCHER_HEADER
   +0x140 WaitBlock        : [4] _KWAIT_BLOCK
   +0x24b WaitBlockCount   : UChar
   +0x0d0 WaitBlockList    : Ptr64 _KWAIT_BLOCK -> list of WAIT_BLOCKs

0: kd> dx -id 0,0,ffffa80df1cff040 -r1 (*((ntkrnlmp!_KWAIT_BLOCK (*)[4])0xffffa80dfe61f180))
(*((ntkrnlmp!_KWAIT_BLOCK (*)[4])0xffffa80dfe61f180))                 [Type: _KWAIT_BLOCK [4]]
    [0]              [Type: _KWAIT_BLOCK]
    [1]              [Type: _KWAIT_BLOCK]
    [2]              [Type: _KWAIT_BLOCK]
    [3]              [Type: _KWAIT_BLOCK]

0: kd> dx -id 0,0,ffffa80df1cff040 -r1 (*((ntkrnlmp!_KWAIT_BLOCK *)0xffffa80dfe61f180))
(*((ntkrnlmp!_KWAIT_BLOCK *)0xffffa80dfe61f180))                 [Type: _KWAIT_BLOCK]
    [+0x000] WaitListEntry    [Type: _LIST_ENTRY]
    [+0x010] WaitType         : 0x1 [Type: unsigned char]
    [+0x011] BlockState       : 0x4 [Type: unsigned char]
    [+0x012] WaitKey          : 0x0 [Type: unsigned short]
    [+0x014] SpareLong        : 1083 [Type: long]
    [+0x018] Thread           : 0xffffa80dfe61f040 [Type: _KTHREAD *]
    [+0x018] NotificationQueue : 0xffffa80dfe61f040 [Type: _KQUEUE *]
    [+0x018] Dpc              : 0xffffa80dfe61f040 [Type: _KDPC *]
    [+0x020] Object           : 0xffffa80e00b040e0 [Type: void *]
    [+0x028] SparePtr         : 0x0 [Type: void *]

Object is what is being waited on - see if thread NotificationEvent matches

Note: if 3 objects or less WAITS the in _KTHREAD
else in WaitBlockList.
array of 4 and 3 max objects reserves one for _KTIMER (waitable)


Bug check 0xD1: DRIVER_IRQL_NOT_LESS_OR_EQUAL
1 Memory referenced.
2 IRQL at time of reference.
3 0 - Read 1 - Write 2 - Execute 8 - Execute
4 Address that referenced memory. Use ln (list nearest symbols) on this address to see the name of the function.

if mem ref'd == addr ref'ing mem then executing paged code

Page fault is saved in CR2
r cr2 -> page fault address
!pte 
!pcr (if curr == idle thread) then idle
!irql
IRQL is saved in CR8
r cr8 => IRQL of CPU
intelppm!IdleExecuteTransition : mwait --> CPU to C-state
Page faults save context -- see Software Dev Manual chap 6
#PF 
uf nt!KiPageFault
    push rbp -- 
.frame /r <add of pg fault handler>
dps rbp -- find fault code
dps rbp - 8 <-- pushed rbp in KiPageFault

r if --> saved interrupt flags: 0 = disabled, 1 = enabled
!devnode 0 1 intelppm -> changes CPU C-states

Is address in driver?
lmvi m intelppm -- see start/end
start < cr2 < end
if upper bits are different xor or them for bit diff - maybe bit flip

============= Session 14 Training END =================

============= Session 15 Training BEGIN =================
I/O Subsys
DMA error bugcheck E6 caused by vtd iommu irq w/o verifier enabled
    vbs - virtual base security
rust - new language for drivers
wdf is open source so private symbols - see channel9 MSDN going deep

FDO policy owner
SerCx: LPC (low pin count) class driver for i2c, spi, uart -- ACPI does PnP

Lab: Bug Check 0x124: WHEA_UNCORRECTABLE_ERROR
==============================================
Arg2 = !errrec --> mwait bugchecked maybe - why???
Arg3/4 Mci_Status
see also event logs
!idt -a
--> nt!KiMcheckAbort stack = Addr
in kv stack
see if an IRQ handler is in the stack and ub the retaddr for instruction

============= Session 15 Training END =================
============= Session 16 Training BEGIN =================

Drivers
dps <driver object address>+0x70 (may change) -- dumps dispatch routines
dt <driver>!_DRIVER_EXTENSION -- internals
!error <status code> --> decodes to english

_FILE_OBJECT instance of _DEVICE_OBJECT and are used for handles
    handle to FO -> DO

Lab: Bug Check 0x1E: KMODE_EXCEPTION_NOT_HANDLED
================================================
1   The exception code that wasn't handled. --> !error Arg1
2   The address where the exception occurred.
3   Exception information parameter 0 of the exception record.
4   Exception information parameter 0 of the exception record.

k stack maybe trap, e.g. nt!KiTrap06 -- illegal instruction
    unhandled exception
!chkimg nt or any image like pci -- may show errors - usually hardware
kd> !chkimg -lo 50 -d !fastfat
u Arg2 -- exception occured at
!pte Arg2 -- --KREV (kernel, read-only, exec, valid)

============= Session 16 Training END =================

============= Session 17 Training BEGIN =================

devnode tree nt!_DEVICE_NODE
DSDT (\__SB) bus
inf file PCI\VEN_VID&DEV_DID
VID & DID in PCI config space
bus -> IoInvalidate -> Pnp QDR -> PDOs -> Pnp QDid

!wdfldr (no arg) shows all devices
boot loader - winload  scans registry -> ExitBootServices

Phase 0 - Pnp init (IopInitializePlugPlayServices)
    HTREE\ROOT\0 -> PnpManager - root device
    what bus? root enumerated devs - non-Pnp
    HKLM\SYS\CCS\Enum\Root -> ACPI_HAL -> ACPI -> DSDT Table

Phase 1 - ROOT\ACPI_HAL\0000 (enums PCI) see enum reg key

cmds:
!arbiter <N>
!pnpcompletion -- list all completed Pnp events
!pnpevent -- list all queued Pnp events
!pnptriage - full triage
!lbt -- legacy bus table list
!cmreslist <addr> -> devnode!ResourceList
!ioreslist <addr> -> devnode!ResourceRequirements

============= Session 17 Training END =================

============= Session 18 Training BEGIN =================

debug Pnp
YB cases:
0) no driver case: install it, or chk hw/ids in INF
1) failed DriverEntry: set bu drvr!DriverEntry and debug
2) failed AddDevice: find AddDevice address via DriverObject
    dps <driver object address>+0x70 (may change) -- dumps dispatch routines
    set bu drvr!AddDevice and debug
3) Resource conflict
4) Failed to START_DEVICE

Case 1:
!pnptriage
CM_PROB_FAILED_DRIVER_ENTRY
CM_PROB_FAILED_ADD
look at !devnode(s)
!pcitree

bu drvr!DriverEntry
bu drvr!AddDevice -> rcx = DriverObject

Case 3: resource conflict
!pcitree
!pci 100 B D F 
!pci 100 0 8 0 --> very cool
see dt devnode!ResourceRequirements
!ioreslist <res rqmts addr>
OR
!devnode <addr> 7
devnode!ResourceList (RL) -> device view
devnode!ResourceListTranslated (RLT) -> host view
!cmreslist <RL>; !cmreslist <RLT>
!idt <N> should match RLT value

Lab YB w/Dump (e.g.)
-------------------
!pnptriage -> intelppm NORMAL_CONFLICT -> !code12 useless w/o privates
dt devnode!ResourceRequirements -> !ioreslist <res rqmt addr>
2+ devnodes w/same requirement? = conflict
!devnode 0 1 intelppm (maybe not all conflict)

Who owns the resource?
!arbiter [Flags] -- I/O resource flag = 1
!arbiter 1 -> C = range in conflict

Where is the resource requirement coming from?
dt denode!UniqueId ==> "\_SB.SCK0.C126" -- ACPI namespace
!amli dns \_SB.SCK0.C126 --> Device
!amli dns /s \_SB.SCK0.C126
    look for _CRS -- resource requirements Buffer Ptr
next look in DSDT tables
!acpicache
5: kd> !acpicache
Dumping cached ACPI tables...
  ...
  DSDT @(ffff8004909c5018) Rev: 0x2 Len: 0x02ad92 TableID: ADL     

5: kd> !acpicache 1 ffff8004909c5018
Dumping cached ACPI tables...
HEADER - ffff8004909c5018
  Signature:               DSDT
  Length:                  0x0002ad92
  Revision:                0x02
  Checksum:                0xf0
  OEMID:                   INTEL
  OEMTableID:              ADL     
  OEMRevision:             0x00000000
  CreatorID:               INTL
  CreatorRev:              0x20200717

5: kd> db ffff8004909c5018
ffff8004`909c5018  44 53 44 54 92 ad 02 00-02 f0 49 4e 54 45 4c 00  DSDT......INTEL.
ffff8004`909c5028  41 44 4c 20 20 20 20 20-00 00 00 00 49 4e 54 4c  ADL     ....INTL
ffff8004`909c5038  17 07 20 20 a0 86 f8 04-00 15 5c 2f 04 5f 53 42  ..  ......\/._SB
ffff8004`909c5048  5f 50 43 30 30 47 46 58-30 41 4c 53 49 00 00 15  _PC00GFX0ALSI...
ffff8004`909c5058  5c 2f 04 5f 53 42 5f 50-43 30 30 47 46 58 30 43  \/._SB_PC00GFX0C
ffff8004`909c5068  4c 49 44 00 00 15 5c 2f-04 5f 53 42 5f 50 43 30  LID...\/._SB_PC0
ffff8004`909c5078  30 47 46 58 30 43 44 43-4b 00 00 15 5c 2f 04 5f  0GFX0CDCK...\/._
ffff8004`909c5088  53 42 5f 50 43 30 30 47-46 58 30 43 42 4c 56 00  SB_PC00GFX0CBLV.

Dump DSDT table to disk and decode:
decoder: iasl.exe (Intel ASL comppiler)
1. dump: .writemem d:\Intel_Dev\Bugs\Dumps\dsdt.bin ffff8004909c5018 L0x0002ad92
2. !!dir d:\Intel_Dev\Bugs\Dumps
03/30/2023  10:29 AM           175,506 dsdt.bin
3. decode: d:\dev\code\work\uefi\asl\bin\iasl.exe -d dsdt.bin
4. output: dsdt.dsl --> find C126 of \_SB.SCK0.C126 for resources
    IO (Decode16,
        0x0000,             // Range Minimum
        000,             // Range Maximum
        1,               // Alignment
        F,               // Length
        0)

Who owns the resource? Search dsdt.dsl file for matching IO port.

Lab WHEA w/Dump (e.g.)
---------------------
!errrec <err rec addr>
3: kd> !errrec ffffa805e3755020
===============================================================================
Common Platform Error Record @ ffffa805e3755020
-------------------------------------------------------------------------------
Record Id     : 01d96322e0eb16b9
Severity      : Fatal (1)
Length        : 27744
Creator       : Microsoft
Notify Type   : BOOT Error Record
Timestamp     : 3/30/2023 16:15:45 (UTC)
Flags         : 0x00000002 PreviousError

===============================================================================
Section 0     : Firmware Error Record Reference
-------------------------------------------------------------------------------
Descriptor    @ ffffa805e37550a0
Section       @ ffffa805e37552e0
Offset        : 704
Length        : 2592
Flags         : 0x00000000
Severity      : Fatal


===============================================================================
Section 1     : Firmware Error Record Reference
-------------------------------------------------------------------------------
Descriptor    @ ffffa805e37550e8
Section       @ ffffa805e3755d00
Offset        : 3296
Length        : 544
Flags         : 0x00000000
Severity      : Fatal

kd> .writemem c:\whea.bin ffffa805e3755020 L (0n27744)
Next: c:\Python38\Scripts\intel_crashlog.exe analyze whea.bin > whea.out
options for intel_crashlog.exe: unpack,pack,trigger,extract,decode,hash,analyze,report,list,triage,console,diff,summary,signature,info,check

In system events:
Source column: WHEA-Logger
Details: Event Data - RawData:

!!! If raw data length is <= 256 then copy to command line and run dumprec /b

w:\whea\dumprec.exe /b 435045520101FFFFFFFF0100030000000300000000010000133713011801222157227C5A5EEF034ABA49386D21A67BD9000000000000000000000000000000004ABCFE8E22529C40A59F6F06DDB7967866A4613D40AB9A40A698F362D464B38F9100000000000000020000000000000000300000000000000000000000000000C80000003800000000010000000000008B3A1885419C9C42939C5C3C087CA28000000000000000000000000000000000030000000000000000000000000000000000000000000000E10F364410C1DB408D76592836FAD332000000000000000000000000000000000000000001000AA080260001002600030000000000000000

Note: dumprec can be found at (or w:\whea):
\\cce-rpt-data\Tools\WHEA-Logger_256B_Decode

============================================================
1/24/3334 11:55:19 - Boot Error
                     Informational (Previous Error)
Platform ID:            {5a7c2257-ef5e-4a03-ba49-386d21a67bd9}
------------------------------------------------------------
  0 - MU Telemetry Section
      Component ID:       {44360fe1-c110-40db-8d76-592836fad332}
      Subcomponent ID:    {00000000-0000-0000-0000-000000000000}
      Error Status Value: 0xa00a0001
      Info 1:             0x300260001002680
      Info 2:             0x0
Raw Data: 56 bytes
0000: e1 0f 36 44 10 c1 db 40 8d 76 59 28 36 fa d3 32
0010: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
0020: 00 00 00 00 01 00 0a a0 80 26 00 01 00 26 00 03
0030: 00 00 00 00 00 00 00 00

if the raw data > 256, then save the XML from the details tab of the system event:

1. C:\CScripts\641258_ADL_CScripts_Rev1p0\cscripts_1.0\start_adl_offline.bat
2. >>> crashlog.whea_logger_parser(r'd:\Intel_Dev\whea_learn\whea.xml')

WHEA-Logger Event Parser 0.95

extract from d:\Intel_Dev\whea_learn\whea.xml, data size = 6816
save to C:\CScripts\641258_ADL_CScripts_Rev1p0\cscripts_1.0\commlibs\crashlog\crashlogs\samples\20230406_165447_whea.crashlog
Done!
>>> quit()

3. grab file at: C:\CScripts\641258_ADL_CScripts_Rev1p0\cscripts_1.0\commlibs\crashlog\crashlogs\samples\20230406_165447_whea.crashlog'
    This is the bin file similar to the bin file from .writemem from crash dump.

4. c:\Python38\Scripts\intel_crashlog.exe analyze d:\Intel_Dev\whea_learn\20230406_165447_whea.crashlog > d:\Intel_Dev\whea_learn\20230406_165447_whea.crashlog.out
    this produces the same format as if writemem from the dump file were used.


Note: the whea.crashlog file can be opened in Intel System Debugger and viewed.
REASON: 20010H
This header field indicates the reason for the Crash Log trigger.
Field           Value   Symbolic Description
CPU_REASON      2H      UMCF: An uncorrectable machine-check occurred Reason of the Crash Log trigger initiated by the CPU 
PCH_RESET       0H      NONE Type of reset that occurred during the Crash Log trigger 
PCODE_MCA       0H      NONE Pcode MCA error code sent by the CPU 
TRIGGER_REASON  4H      CPU_TRIG: This Crash Log record was triggered due to an error condition on the CPU. Reason of the Crash Log trigger 
UMCF: An uncorrectable machine-check occurred


Source Type: 0x10 --> ntddk.h
dt _WHEA_ERROR_SOURCE_TYPE
?? (_WHEA_ERROR_SOURCE_TYPE) 0x10
    -> WheaErrSrcTypeDeviceDriver
db <err rec addr> --> CPER ....

Another way to get the WHEA data:
================================
3: kd> !whea 
Error Source Table @ fffff800019ca250
13 Error Sources
Error Source 0 @ fffffa80064132c0
   Notify Type      : Machine Check Exception
   Type             : 0x0 (MCE)
   Error Count      : 8
   Record Count     : 10
   Record Length    : c3e
   Error Records    : wrapper @ fffffa8007cf4000  record @ fffffa8007cf4030
. . . . 

# 3: kd> !errrec fffffa8007cf4030 
===============================================================================
## Common Platform Error Record @ fffffa8007cf4030
-------------------------------------------------------------------------------
Revision      : 2.1
Record Id     : 01c9c7ff04e0ff7d
Severity      : Fatal (1)
Length        : 1730
Creator       : Microsoft
Notify Type   : Machine Check Exception
Timestamp     : 4/28/2009 12:54:47
Flags         : 0x00000000
# 

19: kd> dt -r WHEA_ERROR_RECORD fffffa8007cf4030
Wdf01000!WHEA_ERROR_RECORD

Also, check !pci ff 0x0 1 0 (ff B D F)
19: kd> !pci ff 1 0 0
PCI Segment 0 Bus 0
00:0  8086:a706.00  Cmd[0006:.mb...]  Sts[2090:c....]  Intel Host Bridge  SubID:8086:7270
      cf8:80000000  IntPin:0  IntLine:0  Rom:0  cis:0  cap:e0
      Cap[e0] ID 09 Vendor Specific
      00000000:  a7068086 20900006 06000000 00000000
      00000010:  00000000 00000000 00000000 00000000
      00000020:  00000000 00000000 00000000 72708086
      00000030:  00000000 000000e0 00000000 00000000

PCI Segment 0 Bus 0x1
00:0  10de:28a1.a1  Cmd[0006:.mb...]  Sts[0010:c....]  Nvidia 3D Controller  SubID:1414:0082
      cf8:80010000  IntPin:1  IntLine:0  Rom:0  cis:0  cap:60
      MEM[0]:66000000  MPF[1]:c         MEM[2]:60        MPF[3]:c         M1M[4]:62        IO[5]:1          
      Cap[60] ID 01 PowerManagement
          PMC   4803 (PME from D3H0 v3)
          PMCSR 0008 (PME_Status=0 PME_En=0 State=D0)
      Cap[68] ID 05 MSI
           MSI Enabled
           MsgAddr     fee007b0
           MsgAddrHi   0
           MsData      0
      Cap[78] ID 10 PCI Express
PCI Express Capabilities @ 7a
  Capability Version                  = 1
  Device/Port Type                    = 0 : Endpoint
  Slot Implemented                    = 0
  Interrupt Message Number            = 0
  Reserved                            = 0
Device Capabilities @ 7c
  Max Payload Size Supported          = 1 : 256 bytes
  Phantom Functions Supported         = 0 : None
  Extended Tag Supported              = 1 : 8-bit
  L0s AcceptableLatency               = 7 : [4us, INF)
  L1 Acceptable Latency               = 6 : [64us, INF)
  Attention Button Present            = 0
  Attention Indicator Present         = 0
  Power Indicator Present             = 0
  Reserved (1)                        = 0
  Captured Slot Power Limit           = 4B
  Captured Slot Power Limit Scale     = 0 : 1.0x
  Reserved (2)                        = 0
Device Control @ 80
  Correctable Error Enable            = 0
  Non-fatal Error Enable              = 0
  Fatal Error Enable                  = 0
  Unsupported Request Error Enable    = 0
  Enable Relaxed Order                = 1
  Max Payload Size                    = 1 : 256 bytes
  Extended Tag Enable                 = 1
  Phantom Functions Enable            = 0
  Aux-power Enable                    = 0
  No-snoop Enable                     = 1
  Max Read Request Size               = 2 : 512 bytes
  Bridge Config Retry Enable          = 0
Device Status @ 82
  Correctable Error Detected          = 0
  Non-fatal Error Detected            = 0
  Fatal Error Detected                = 0
  Unsupported Request Detected        = 0
  Aux Power Detected                  = 0
  Transactions Pending                = 0
  Reserved                            = 0
Link Capabilities @ 84
  Maximum Link Speed                  = 1 : 2.5 Gb/s
  Maximum Link Width                  = 8
  Active State PM Support             = 2 : L0s
  L0s Exit Latency                    = 6 : [2us, 4us)
  L1 Exit Latency                     = 2 : [2us, 4us)
  Reserved                            = 0
  Port Number                         = 0
Link Control @ 88
  Active State PM Control             = 0 : Disabled
  Reserved (1)                        = 0
  Read Completion Boundary            = 0 : 64 byte
  Link Disable                        = 0
  Retrain Link                        = 0
  Common Clock Config                 = 1
  Extended Synch                      = 0
  Reserved (2)                        = 0
Link Status @ 8a
  Link Speed                          = 1 : 2.5 Gb/s
  Link Width                          = x8
  Link Training Error                 = 0
  Link Training                       = 0
  Slot Clock Config                   = 1
  Reserved                            = 0
Slot Capabilities @ 8c
  Attention Button Present            = 0
  Power Controller Present            = 0
  MRL Sensor Present                  = 0
  Attention Indicator Present         = 0
  Power Indicator Present             = 0
  Hot-plug Surprise                   = 0
  Hot-plug Capable                    = 0
  Slot Power Limit Value              = 0
  Slot Power Limit Scale              = 0 : 1.0x
  Electromechanical Lock Present      = 0
  No Command Completed Support        = 0
  Physical Slot Number                = 0
Slot Control @ 90
  Attention Button Enable             = 0
  Power Fault Detected Enable         = 0
  MRL Sensor Enable                   = 0
  Presence Detect Enable              = 0
  Command Completed Enable            = 0
  Hot-plug Interrupt Enable           = 0
  Attention Indicator Control         = 0 : Reserved
  Power Indicator Control             = 0 : Reserved
  Power Controller Control            = 0 : On
  Reserved                            = 0
Slot Status @ 92
  Attention Button Pressed            = 0
  Power Fault Detected                = 0
  MRL Sensor Changed                  = 0
  Presence Detect Changed             = 0
  Command Completed                   = 0
  MRL Sensor State                    = 0 : Closed
  Presence Detect State               = 0 : Slot Empty
  Reserved                            = 0
Root Control @ 94
  Correctable SERR# Enable            = 0
  Non-fatal SERR# Enable              = 0
  Fatal SERR# Enable                  = 0
  PME Interrupt Enable                = 0
Root Status @ 98
  PME Requester ID                    = 0
  PME Status                          = 0
  PME Pending                         = 0
  Reserved                            = 0
      Cap[b4] ID 09 Vendor Specific
      00000000:  28a110de 00100006 030200a1 00000000
      00000010:  66000000 0000000c 00000060 0000000c
      00000020:  00000062 00000001 00000000 00821414
      00000030:  00000000 00000060 00000000 00000100


                      ...storport...
!storagekd.storclass --> scsi errors

============= Session 18 Training END =================

============= Session 19 Training BEGIN =================

!process 0 0 csrss.exe
.process /p /r <proc addr>
!process <proc addr>
dt nt!_IRP <irp addr>

?? sizeof(nt!_IRP) -> 0xD0
?? sizeof(nt!_IO_STACK_LOCATION) -> 0x48

dt nt!_IO_STACK_LOCATION <irp addr> + 0xD0 + 0x48 * N, where N is the current stack location:
_IRP.CurrentLocation = N
busying == pending, complete, or pass down

Lab !process 0 0 cmd.exe
========================
!process <proc addr>
bp /p <proc addr> nt!ReadFile
> .reload
> k yay!!!
> .frame /r 4 
> !handle <rcx> -> file object == file path\name
> ba w 8 <irp addr> + 0x30 --> _IO_STATUS 

Lab Bugcheck 7F: UNEXPECTED_KERNEL_MODE_TRAP
============================================
Arg1: exception code
kv -> .trap frame or .frame /r N
k> !ipi -- dumps all IPI's on all CPUs
TLBs = VToP cache -- TLB flush CR4

Lab Bugcheck 0xCC: PAGE_FAULT_IN_FREED_SPECIAL_POOL
===================================================
Arg1 Memory address referenced
Arg2 0: Read 1: Write
Arg3 Address that referenced memory (if known)
Arg4 Reserved
use !verifier special pool
!verifier 80 Arg1 -- shows driver

============= Session 19 Training END =================

============= Session 20 Training BEGIN =================

Power management states: S, D and F
S0: SOi3: C/S or fully on
S3: sleep RAM on
S4: hiber - memmaps same on resume
S5: off or hybrid - S4 kernel, S5 user

S3 and C/S are mutually exclusive on a system 
hybrid D3 RAM and disk (S4) -> desktop only S3 -> S4 Ok

Device States:
D0 & D3 -> see driver Properties -> Power Data: S -> D mappings
    these are unenforced, only the driver enforces
    FDO owns power policy, or Port Driver if miniport

SOC states: F-states (PEP) Active/Idle

!pcitree
!pci 100 B D F -- live only power mgmt info
dt nt!_DEVICE_NODE addr CurrentPowerState
1: kd> dt nt!_DEVICE_NODE ffffbe839c328b60 CurrentPowerState.DeviceState
   +0x09c CurrentPowerState             : 
      +0x000 DeviceState                   : 1 ( PowerDeviceD0 )
Note: this field updates when power IRP on its way down, so maybe in transition

PCI PDO:
1: kd> dt nt!_DEVICE_OBJECT ffffbe839c29e360 DeviceObjectExtension.PowerFlags
   +0x138 DeviceObjectExtension 
   ...
    [+0x010] PowerFlags       : 0x10 [Type: unsigned long]
The power state is the upper nibble of the PowerFlags

1: kd> dt _DEVICE_POWER_STATE 
nt!_DEVICE_POWER_STATE
   PowerDeviceUnspecified = 0n0
   PowerDeviceD0 = 0n1 <=== device is in D0
   PowerDeviceD1 = 0n2
   PowerDeviceD2 = 0n3
   PowerDeviceD3 = 0n4
   PowerDeviceMaximum = 0n5
1: kd> ?? (nt!_DEVICE_POWER_STATE) 1
_DEVICE_POWER_STATE PowerDeviceD0 (0n1)
   
Bus Drivers are reliable for this value - 
    only if the fxdevice does not say: IrpInUse 
    otherwise in transition

Component States:
!fxdevice -> (power management framework PoFx)
dt nt!PoFx* -- shows all the PoFx APIs, including RegisterDevice
!fxdevice shows all the PEP integrated devices
    Current: is the current power state -- from the devnode

WDF Drivers:
!wdfkd.wdfldr --> lists all WDF drivers
!wdfdriverinfo <name> -- shows list of devices managed by driver
!wdfdevice <addr> ff -> gives the power state

!poaction --> in flight IRPs
    PDO -> pcitree

To see what power states a device supports (no way directly)
1. look at power state history
2. if ACPI look for PS3 method
3. PHM tool -> ETL file

============= Session 20 Training END =================

============= Session 21 Training BEGIN =================

PPO and PEP (component F-states) can punt to PPO
    PPO -> WAIT_WAKE -> then QDR?
Non-Wake power Irps sent to TOS in separate worker thread to avoid deadlock
SET_POWER only PEND or FWD Irp within Delta T
Delta T violation - power mgr watchdog bugchk 9F (hang)
    Delta T = 2 min for D0, 5 min for Dx

System Power state - power mgr Irp from user
1st S - QUERY then SET (must succeed! not checked)
PPO sends Dx Irp then completes S-Irp
pending S-Irp holds off further S-state stacks - very order sequential (Child/Parent)
    or PPO can complete the S-IRP immediately

Connected Standby - periodic wakes w/screen off, continues to update apps
Disconnected Standby (Modern Standby) = S0ix
    System in S0 but apps off, devices idle, D3 idle, CPU idle C-State
        then PUnit (microController) -> PMIC driver disconnects power
            like S3 -- slow natural death
Wake? Periodic timer P-Code (PUnit) APIC timer -> C0 state ~ 30 seconds - only 1 CPU (w/shortest timeout)

S3 vs CS are mutually exclusive
debug using = tells why wake:
powercfg /sleepstudy or event logs

Lab Bugcheck 0x9F: DRIVER_POWER_STATE_FAILURE
=============================================
    PDO and Irp in Args case #3 Irp timed out
    !poaction -- state of Power mgr -> Set/Dx
    or dt!_PNP_IRP_DATA <addr> in !irp params
        -> PowerStateType -> Device/System
    if System Power State -> poaction -> Broadcast in Progress: TRUE
    
dt nt!_DEVICE_NODE <addr> UniqueId -> ACPI namespace
!amli dns /s <ACPI name>._DDN (device name)
    _PS0 _PS3 power methods
!amli u <acpi name)._PS0
-> mailslot signal like PUnit -> PMIC
is it running?
!amli lc -- list of contexts running
!amli u <pbOp>
!amil find RAIL
    fields vs buffers
Fields:
    find threads running ACPI code:
kd> !stacks 2 acpi!
!thread <thr adr>
    ACPI!InternalOpRegionHandler -> PMIC
    WdfIoTargetSendIoctlSynchronously
        who is PMIC talking to?
kd> .thread /p /r <thrd addr>
kd> ub <addr caller of WdfIoTargetSendIoctlSynchronously Retn Addr>
!wdfkd.wdfhandle <h>

Current Power State:
kd> dt nt!_DEVICE_NODE <node adr> CurrentPowerState.DeviceState

WDF queues -- if PowerOff can't process requests!!

============= Session 21 Training END =================

============= Session 22 Training BEGIN =================

if IRQL = FF, IRQs are disabled @trap time
cr8 = IRQL 

Full dump enable:
"wmic recoveros set DebugInfoType 1"

Lab step through KeBugCheckEx
=============================
kd> pct -- run to next call
if call nt!guard_dispatch_icall -> u @rax shows the call point
kd> !dbgprint -- see buffer of DbgPrint

to debug: disable VBS and secure boot
disable hyperV (== disable VBS)
    bcdedit /set hypervisorlaunchtype off


============= Session 22 Training END =================

============= Session 23 Training BEGIN =================

Lab Bugcheck 0x133 DPC_WATCHDOG_VIOLATION
=========================================
> !swd
check DPC Count = 0
> k (note: TOS and BOS don't matter)
!irql find what caused the timer to fire
look at !thread for tick count
Arg2 = watchdog period -- default DPC timeout = 2 min
> .frame /r N
disasm & figure it out


Lab Bugcheck 0x50 PAGE_FAULT_IN_NONPAGED_AREA
=============================================
> u Arg3, r CR2 = Arg1
> k
> u <start of fcn> <scene of crime>
uf caller
!poactino -- maybe shutting down


Lab Bugcheck 0x50 PAGE_FAULT_IN_NONPAGED_AREA
=============================================
Arg1 = mem accessed
Arg3 = mem accessor
u Arg3, r CR2 = Arg1
!pte Arg1
> .frame ...
> ub
deep dive disasm -- if private symbols:
dv /V /i /y
dt ...
!wdfhandle
!idt x
!pool <addr>
?? sizeof(_STRUCT)
!stacks 2 <driver>
maybe pnp or power stuff
!running -it
OR find resources that are gone

============= Session 23 Training END =================

============= Session 24 Training BEGIN =================

Lab Bugcheck 0xD1 DRIVER_IRQL_NOT_LESS_OR_EQUAL
===============================================
1 Memory referenced.
2 IRQL at time of reference.
3 0 - Read 1 - Write 2 - Execute 8 - Execute
4 Address that referenced memory

> k; !pte Arg1
note !pte "Contains" are the bits: KWEV etc... -- bit 0 is the V bit
use verifier if possible, like if mem was accessed after freed
!stacks 2 <driver> -- maybe find freeing of mem in threads
or just look at the stack (kv) and deduce: timers? wdf?
!wdfdriverinfo find Pnp/Power states
!wdfdevice <dev> ff -- bottom entries are most recent
look for pending Irps


Lab Bugcheck 0x9F: DRIVER_POWER_STATE_FAILURE
=============================================
Type 3: PDO, Irp
!poaction
look at exec resources -- they have owners
.thread /r /p <thr>; kn
.frame /r N
ub
dt nt!_ERESOURCE <addr> OwnerEntry. -- OwnerThread.
!locks nt!PopPolicyLock  -- thread waiting timed out by owner thread -> waiting on mutant
dt nt!_KMUTANT <adr> OwnerEntry. -- OwnerThread.
.thread /r /p <thr>
maybe circular dependence -- or deadlock (2 threads, 2 locks, reverse order)
WaitForResource samples every 3 secs (like spin lock) yields
note: not all locks have owners


Lab Bugcheck 0x9F: DRIVER_POWER_STATE_FAILURE
=============================================
Type 3: PDO, Irp
!irp; !devstack
ACPI case (GPIO)
> !amli lc --> nothing!
!poaction; !thread <addr>
pg fault (2 min wait!, why?) storage?
!storagekd.storclass -- looks OK, then why 2 min wait?
chk power state of storage:
!devstack -> !devnode
dt nt!_DEVICE_NODE <adr> CurrentPowerState.DeviceState = D0 -- ok
urr?  could be the D0 is in flight -- chk !poaction -- PDO none !!! arghhh!!!
it's in D0 -- why IO stuck paging? now what !!!
check child powered and not parent
SATA controller maybe OFF but disk in D0
chk parent devnode
dt nt!_DEVICE_NODE <adr> CurrentPowerState.DeviceState = D0 -- ok
chk in-flight D0 Irp in !poaction --- PDO --> yes!!!
    see if there is no thread working on the SATA D0 Irp -- all threads busy on other power Irps
    ie, look at all threads in !poaction --> !thread <t1>; !thread <t2>; ...
    this is a kind of deadlock -- SATA not in D0 -- limited # of power threads
!pte <code adr> of paging I/O waiting --> paged out!!
driver of code addr is on paging path -- can't be paged out -- deadlock
    chk if code addr is 0 (ZERO) offset in stack --> bang!
    !dh <driver name>
    > ? code addr - driver name = section header offset (Virtual Address) Flags = "Not Paged" not set? then paged section

============= Session 24 Training END =================

============= Session 25 Training BEGIN =================

Lab Bugcheck 0x9F: DRIVER_POWER_STATE_FAILURE
=============================================
    Type 3 - Irp, PDO -> SET_POWER timeout
real driver name (not service name) -> dt nt!_DEVICE_OBJECT <dev> DriverObject -> DriverName
    real name in DriverInit function prefix
symbol file also contains the real driver name
C:\> sigcheck -v <driver sys file> ==> gives name and version

!locks -> nt!PopPolicyLock -- look at lock owner *AND* waiters for driver of interest - dump threads
maybe some API is being called during D0Enter/Exit that shouldn't be - bug 22018457411

why did power IRP timeout?
!poaction --> no thread?
!stacks 2 <driver name> ?
WDF driver? -> !wdfdriverinfo <name> -- if many devs find FDO
    look at IRP stack, TOS is FDO, BOS if PDO

or !drvobj \Driver\name
    fine FDO in list of !drvobj
or !wdfdevice <fdo> ff -> pended power irps --> owning thread
.thread /r /p <thr>
!thread --> waiting 2 min timeout (D0 timeout) for FDO -> notification event?
-> KeWait -- .frame prior to this call
.frame /r N-1
ub
lookup API for KeWait param1 is event object -> rcx = [rbx+E8] (struct)
look at caller function: u <func>  rbx is a "this" pointer if C++
> dv /V /i /t -> @rbx = "this"
look for offset E8 in struct (if symbols) -> KEVENT 
drivers poll for completion of FW load then signal the KEVENT directly or in ISR/DPC
what is the timeout?  its param4 of KeWait so sent on stack
> dq <rsp+offset> L1 --> timeout in 100 nsec units (10^-9) (10^-7)
    so value is in msec -- in code imul -1000 s/b idiv bug

Lab Bugcheck 0x15F: CONNECTED_STANDBY_WATCHDOG_TIMEOUT_LIVEDUMP
===============================================================
For MSFT telemetry
PEP veto Type 3 Arg1
a device on PEP list needs to reach a power state --> list from BIOS
Arg3 = veto name reason string unicode
> du Arg3 -> "device not registered"
> u Arg4 --> intelpep!....
which device?
list registered list of devs, and list that is supposed to be registered.
1. !pnptriage -- look for CM_PROB_... of PEP devices - note: USB is not PEP
2. !fxdevice --> lists registered devices
3. script: !list -t nt!_POP_FX_DEVICE.Link.Flink -x "dt" -a "nt!_POP_FX_DEVICE DeviceId" poi(nt!PopFxDeviceList)
    output -- see pep.kd file -- these are all the PEP devices, registered or not
4. Which devices are supposed to be registered - from BIOS.
> !amli find PEPD
    \_SB.PEPD
> !amli dns /s \_SB.PEPD
    --> another list of deivces (see pep.kd file) -- diff with !list output
5. or dump the DSDT table
> !acpicache --> DSDT entry
> !acpicache 1 <addr of DSDT entry>
> .writemem <file path to dsdt.bin> <addr of DSDT> L0x<Length>
C:\> iasl.exe -d dsdt.bin > dsdt.out --> PEPD and Package list of PEP devs (master list)
6. Another method: use PEP structs
> dd intelpep!PepKnownDeviceCount L1
> x intelpep!PepKnownDeviceList <-- array
> dps poi(intelpep!PepKnownDeviceList)
> start du'ing pointers
OR
> ? addr2 - addr1 (in array) for struct length
> dt nt!_UNICODE_STRING poi(intelpep!PepKnownDeviceList)+38*N Buffer --> N is entry in array
7. Another method - disasm Pep function
> uf intelpep!PepFindDeviceMatch --> find mem allocation and size

filter the output files and diff to find missing device from PepKnownDeviceList

excluded /v arg
findstr /v unicode_string <file>
note: PEG0 is internal graphics

> !amli find <missing device> -- it exists, now what
> !amli dns /s <missing dev> -- see if _STA exists
check parent of device RP? chk _ADR
_ADR ==> device | function --> see if in !pcitree
if not in !pcitree - then either disabled, driver failed, no driver exists, or hidden by BIOS

note: kdnet can take over device for debug

Lab Bugcheck 0xE1: WORKER_THREAD_RETURNED_AT_BAD_IRQL
=====================================================
> !irql
> k
> ln Arg1
dox API or search kernel
> dt nt!_*WORK*ITEM* -> _IO_WORKITEM
dt nt!_IO_WORKITEM Arg4 -- just a guess
    -> Routine
    -> IoObject
    -> Context --> !wdfobject
> !wdfobject Context
> !wdfobject -> Work item -> cm_Callback
find resources -> interrupt == Arg2 IRQL
> !idt -a -- find IRQ connected to driver
    copy table to file and make a script - list of:
    dt nt!_KINTERRUPT <adr> Irql -- run and find IRQ with matching IRQL in Arg2
    dt nt!_KINTERRUPT <adr> ServiceContext
> !wdfobject ServiceContext --> find wdf device
> dt nt!_KINTERRUPT ActualLock = 0 or 1 if spin lock is acquired, and not released
> !wdfdevice <dev>
    find owning thread and pending irps
> !thread -> possible race condition
see WdfAcquireInterruptLock rules in API dox

best to troubleshoot by running verifier - will BC and the rule violation

Lab Bugcheck 0x1E: KMODE_EXCEPTION_NOT_HANDLED
==============================================
> u Arg2
> k --> GPF in stack?
invalid instruction? corrupt mem?
> !process 0 0
> !pte Arg2 KREV -- so its OK
> chkimg nt -> 0 errors

c:\> windbg -z <exec binary>
> .lines
> u ntoskrnl!SwapContext -- same bad bytes
not possible MSFT introduced bad instructions
and GPF and BAD INSTR are mutually exclusive errors
HRESET MSR
> x nt!*HRESET*
> running -it (nothing)
see what the system is doing
> ~0s;k
> ~1s;k
> ~2s;k
> ~3s;k

System Sleep?
> lm --> unloaded modules are a clue of (hiber/resume)
> !poaction
    Lightest State: Hibernate
> dd nt!PoResumeFromHibernate L1
    0 / 1 -> resuming?
On resume from hibernation, restoring the MSR's is a MUST
need live repro, compare 2 systems before and after hiber to compare MSRs
> rdmsr 17DA

see bugs: 14013764866 and 22012486156

============= Session 25 Training END =================

MSRs:
RPL:
IA32_X2APIC_LVT_THERMAL 833 => see RPLS MSR HAS.pdf


=======================================================

Capturing UEFI logs:
We can use below commands to get UEFI logs
1.  mountvol s: /s,
2.  mkdir s:\UefiLogs,
3.  reboot device,
4.  reproduce the issue.
5.  mountvol s: /s, share the logs in s:\UefiLogs directory

=======================================================



PNP Locks:
3: kd> !pnplocks
********************************************************************************
Dumping PnP locks...
********************************************************************************
Resource @ nt!PiEngineLock (0xfffff8032fc5c7e0)    Available
    Contention Count = 146
1 total locks

Resource @ nt!IopDeviceTreeLock (0xfffff8032fc5c700)    Available
    Contention Count = 4
1 total locks

Resource @ nt!PnpRegistryDeviceResource (0xfffff8032fc5c980)    Available
    Contention Count = 2744
1 total locks

********************************************************************************
If one or more of above are NOT available, do !thread on the owner thread to find the thread hung in PnP
********************************************************************************

3: kd> !polist
All entries in Power Irp Serial List
unable to get nt!PopIrpSerialListLength
PopIrpSerialListLength = 0

Blue Tooth:
15: kd> !bthkd.bthenuminfo
FDO ffffcf847b47faf0 PDO ffffcf8475f80b60
Power State: PowerDeviceD0
TdiPdoCount: 0
dt bthenum!_BTHENUM_FDO_DEVICE_EXTENSION ffffcf847b47fc40
Removing: FALSE
Removed: FALSE
Started: TRUE
Protocol: Unknown Protocol
Local Radio Info ffffcf847b47fd78
Service/Protocol Enumerator Interface ffffcf847b1f8780
Device Enumerator Interface ffffcf847b05bf10

List of Children: 
dt nt!_RTL_RB_TREE ffffcf847b47fcc8
--------------------------------

Wait Wake IRP List: WaitWakeIrpList ffffcf847b47fc80
----------------------------------------


FDO ffffcf847b47eaf0 PDO ffffcf847515ed40
Power State: PowerDeviceD0
TdiPdoCount: 0
dt bthenum!_BTHENUM_FDO_DEVICE_EXTENSION ffffcf847b47ec40
Removing: FALSE
Removed: FALSE
Started: TRUE
Protocol: BTHPROTO_RFCOMM
Local Radio Info ffffcf847b47ed78
Service/Protocol Enumerator Interface ffffcf847b1f83c0


